From grumbel at sheep.berlios.de  Tue Mar  1 13:48:17 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 1 Mar 2005 13:48:17 +0100
Subject: [Flexlay-commit] r492 - in trunk: lib pingus
Message-ID: <200503011248.j21CmH2Z004584@sheep.berlios.de>

Author: grumbel
Date: 2005-03-01 13:48:16 +0100 (Tue, 01 Mar 2005)
New Revision: 492

Modified:
   trunk/lib/objmap_sprite_object.cxx
   trunk/lib/objmap_sprite_object.hxx
   trunk/pingus/worldobjs.rb
   trunk/pingus/xmlreader.rb
Log:
- added some basic support for flipping

Modified: trunk/lib/objmap_sprite_object.cxx
===================================================================
--- trunk/lib/objmap_sprite_object.cxx	2005-02-28 04:02:43 UTC (rev 491)
+++ trunk/lib/objmap_sprite_object.cxx	2005-03-01 12:48:16 UTC (rev 492)
@@ -57,12 +57,22 @@
 {
   CL_Point  align = CL_Point(0, 0);
   CL_Origin origin_e;
-
+  
   sprite.get_alignment(origin_e, align.x, align.y);
 
   CL_Point origin = calc_origin(origin_e, CL_Size(sprite.get_width(),
                                                   sprite.get_height()));
   align.x = -align.x;
+
+  // FIXME: This looks a bit hacky
+  float scale_x, scale_y;
+  sprite.get_scale(scale_x, scale_y);
+
+  if (scale_x < 0)
+    align.x += sprite.get_width();
+  
+  if (scale_y < 0)
+    align.y += sprite.get_height();
       
   return CL_Rectf(pos - origin - align,
                   CL_Sizef(sprite.get_width(), sprite.get_height()));
@@ -75,6 +85,10 @@
 
   impl->sprite.get_scale(scale_x, scale_y);
   impl->sprite.set_scale(scale_x, -scale_y);
+  if (scale_y < 0)
+    impl->pos.y -= impl->sprite.get_height();
+  else
+    impl->pos.y += impl->sprite.get_height();
 }
 
 void
@@ -83,8 +97,18 @@
   float scale_x, scale_y;
   impl->sprite.get_scale(scale_x, scale_y);
   impl->sprite.set_scale(-scale_x, scale_y);
+  if (scale_x < 0)
+    impl->pos.x -= impl->sprite.get_width();
+  else
+    impl->pos.x += impl->sprite.get_width();
 }
 
+void
+ObjMapSpriteObject::set_rotate(float angle)
+{
+  impl->sprite.set_angle(angle);
+}
+
 ObjMapObject
 ObjMapSpriteObject::to_object()
 {

Modified: trunk/lib/objmap_sprite_object.hxx
===================================================================
--- trunk/lib/objmap_sprite_object.hxx	2005-02-28 04:02:43 UTC (rev 491)
+++ trunk/lib/objmap_sprite_object.hxx	2005-03-01 12:48:16 UTC (rev 492)
@@ -37,6 +37,7 @@
                      const CL_Pointf& pos_, 
                      const MetaData& data_);
 
+  void set_rotate(float angle);
   void flip_horizontal();
   void flip_vertical();
   

Modified: trunk/pingus/worldobjs.rb
===================================================================
--- trunk/pingus/worldobjs.rb	2005-02-28 04:02:43 UTC (rev 491)
+++ trunk/pingus/worldobjs.rb	2005-03-01 12:48:16 UTC (rev 492)
@@ -126,7 +126,11 @@
   end
 
   def get_image()
-    return @properties['surface'] || "core/misc/404sprite"
+    if @properties['surface'] then
+      return @properties['surface'][0]
+    else
+      return "core/misc/404sprite"
+    end
   end
 
   def get_pos()
@@ -137,10 +141,32 @@
     @data = data
     if @properties.has_key?('position') then
       @data.to_object().set_pos(get_pos())
-      @properties.delete('position')
+      @properties.delete('position')   
     end
+    set_modifier()
   end
 
+  def set_modifier()
+    if @properties['surface'] then
+      modifier = @properties['surface'][1]
+      case modifier
+      when "ROT0"
+        
+      when "ROT90"
+      when "ROT180"
+      when "ROT270"
+      when "ROT0FLIP"
+        @data.flip_horizontal()
+      when "ROT90FLIP"
+      when "ROT180FLIP"
+        @data.flip_vertical()
+      when "ROT270FLIP"
+      else
+        puts "Error: Unknown modifier: #{modifier}"
+      end
+    end
+  end
+
   def property_dialog()
     puts "Property: #{@properties.inspect}"
 
@@ -162,7 +188,7 @@
       else
         puts "Warning: Ignoring '#{k}' property, type '#{$objects[@typename][k][0]}' is unknown"
       end
-     }
+    }
     dialog.set_callback(proc{|message| 
                           @message = message
                         })

Modified: trunk/pingus/xmlreader.rb
===================================================================
--- trunk/pingus/xmlreader.rb	2005-02-28 04:02:43 UTC (rev 491)
+++ trunk/pingus/xmlreader.rb	2005-03-01 12:48:16 UTC (rev 492)
@@ -34,8 +34,7 @@
 
       when :image
         # FIXME: handle modifier somewhere
-        return ret.elements['image'].text      
-
+        return [ret.elements['image'].text, ret.elements['modifier'].text]
       end
     else
       return default



From grumbel at sheep.berlios.de  Tue Mar 15 14:31:40 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 15 Mar 2005 14:31:40 +0100
Subject: [Flexlay-commit] r493 - in trunk: lib paint pingus
Message-ID: <200503151331.j2FDVeBc027787@sheep.berlios.de>

Author: grumbel
Date: 2005-03-15 14:31:38 +0100 (Tue, 15 Mar 2005)
New Revision: 493

Modified:
   trunk/lib/editor_map_component.cxx
   trunk/lib/editor_map_component.hxx
   trunk/lib/flexlay_wrap.i
   trunk/lib/graphic_context_state.cxx
   trunk/lib/graphic_context_state.hxx
   trunk/lib/minimap.cxx
   trunk/lib/sketch_layer.cxx
   trunk/lib/sketch_stroke_tool.cxx
   trunk/lib/sprite_stroke_drawer.cxx
   trunk/lib/stroke.cxx
   trunk/lib/stroke.hxx
   trunk/lib/tilemap_layer.cxx
   trunk/paint/paint.rb
   trunk/pingus/gui.rb
   trunk/pingus/worldobjs.rb
Log:
- added clipping of strokes that are outside of the screen
- disabled shader based brushes

Modified: trunk/lib/editor_map_component.cxx
===================================================================
--- trunk/lib/editor_map_component.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/editor_map_component.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -177,7 +177,7 @@
   impl->workspace.get_gc_state().zoom_to(rect);
 }
 
-CL_Rect
+CL_Rectf
 EditorMapComponent::get_clip_rect()
 {
   return impl->workspace.get_gc_state().get_clip_rect();

Modified: trunk/lib/editor_map_component.hxx
===================================================================
--- trunk/lib/editor_map_component.hxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/editor_map_component.hxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -61,7 +61,7 @@
 
   CL_Pointf screen2world(const CL_Point& pos);
 
-  CL_Rect get_clip_rect();
+  CL_Rectf get_clip_rect();
 
 private:
   SharedPtr<EditorMapComponentImpl> impl;

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/flexlay_wrap.i	2005-03-15 13:31:38 UTC (rev 493)
@@ -205,4 +205,5 @@
 
 #endif
 
+
 /* EOF */

Modified: trunk/lib/graphic_context_state.cxx
===================================================================
--- trunk/lib/graphic_context_state.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/graphic_context_state.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -87,13 +87,13 @@
   gc->pop_modelview();
 }
 
-CL_Rect
+CL_Rectf
 GraphicContextState::get_clip_rect()
 {
-  return CL_Rect(CL_Point(int(-impl->offset.x),
-                          int(-impl->offset.y)),
-                 CL_Size(int(get_width()  / impl->zoom),
-                         int(get_height() / impl->zoom)));
+  return CL_Rectf(CL_Pointf(-impl->offset.x,
+                            -impl->offset.y),
+                  CL_Sizef(get_width()  / impl->zoom,
+                           get_height() / impl->zoom));
 }
 
 void

Modified: trunk/lib/graphic_context_state.hxx
===================================================================
--- trunk/lib/graphic_context_state.hxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/graphic_context_state.hxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -44,7 +44,7 @@
 
   /** Return a rectangle in world coordinates that represents the area
       visible on the screen */
-  CL_Rect get_clip_rect();
+  CL_Rectf get_clip_rect();
 
   int get_width()  const;
   int get_height() const;

Modified: trunk/lib/minimap.cxx
===================================================================
--- trunk/lib/minimap.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/minimap.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -120,7 +120,7 @@
                                    CL_Size(get_width(), get_height())));
 
       // Draw cursor
-      CL_Rect rect = impl->parent->get_clip_rect();
+      CL_Rect rect(impl->parent->get_clip_rect());
       CL_Rect screen_rect(CL_Point(rect.left  * get_width()  / map_width,
                                    rect.top   * get_height() / map_height),
                           CL_Size(rect.get_width() * get_width() /map_width,

Modified: trunk/lib/sketch_layer.cxx
===================================================================
--- trunk/lib/sketch_layer.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/sketch_layer.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -103,9 +103,18 @@
             parent->get_workspace().get_gc_state().push(canvas->get_gc());
             canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
             //canvas->get_gc()->clear(CL_Color::white);
+
+            CL_Rectf visible_area = parent->get_clip_rect();
+
             for(Strokes::iterator i = strokes.begin(); i != strokes.end(); ++i)
               {
-                i->draw(canvas->get_gc());
+                // canvas->get_gc()->draw_rect(i->get_bounding_rect(), CL_Color(0, 255, 0));
+                // canvas->get_gc()->flush();
+
+                if (visible_area.is_overlapped(i->get_bounding_rect()))
+                  {
+                    i->draw(canvas->get_gc());
+                  }
               }
             parent->get_workspace().get_gc_state().pop(canvas->get_gc());
 

Modified: trunk/lib/sketch_stroke_tool.cxx
===================================================================
--- trunk/lib/sketch_stroke_tool.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/sketch_stroke_tool.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -105,7 +105,7 @@
 
     if (CL_Display::get_current_window()->get_ic()->get_mouse_count() >= 4)
       {
-        CL_InputDevice tablet = CL_Display::get_current_window()->get_ic()->get_mouse(3);
+        CL_InputDevice tablet = CL_Display::get_current_window()->get_ic()->get_mouse(5);
 
         if (0)
           {

Modified: trunk/lib/sprite_stroke_drawer.cxx
===================================================================
--- trunk/lib/sprite_stroke_drawer.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/sprite_stroke_drawer.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -129,6 +129,7 @@
 
         case SpriteStrokeDrawer::DM_SHADER:
           {
+#if 0 
             CL_OpenGLState state(gc);
             state.set_active();
             state.setup_2d();
@@ -186,6 +187,7 @@
             
             state.set_active();
             clUseProgram(0);
+#endif
           }
           break;
               

Modified: trunk/lib/stroke.cxx
===================================================================
--- trunk/lib/stroke.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/stroke.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -31,6 +31,37 @@
   // its for caching only and can be generated
   //typedef std::vector<CL_Pointf> Normals;
   //Normals normals;
+
+  mutable bool bounding_rect_needs_recalc;
+  mutable CL_Rectf bounding_rect;
+
+  CL_Rectf calc_bounding_rect() const
+  {
+    CL_Rectf rect;
+
+    // FIXME: Keep the drawer into account (ie. brushsize)
+    if (dabs.size() > 0)
+      {
+        rect.left = rect.right  = dabs.front().pos.x;
+        rect.top  = rect.bottom = dabs.front().pos.y;
+
+        for(Stroke::Dabs::const_iterator i = dabs.begin()+1; i != dabs.end(); ++i)
+          {
+            rect.left = std::min(i->pos.x, rect.left);
+            rect.top  = std::min(i->pos.y, rect.top);
+
+            rect.right  = std::max(i->pos.x, rect.right);
+            rect.bottom = std::max(i->pos.y, rect.bottom);
+          }
+      }
+    
+    return rect;
+  }
+
+  StrokeImpl() 
+    : bounding_rect_needs_recalc(true)
+  {
+  }
 };
 
 Stroke::Stroke() 
@@ -135,4 +166,16 @@
     }
 */
 
+CL_Rectf
+Stroke::get_bounding_rect() const
+{
+  if (impl->bounding_rect_needs_recalc)
+    {
+      impl->bounding_rect = impl->calc_bounding_rect();
+      impl->bounding_rect_needs_recalc = false;
+    }
+  
+  return impl->bounding_rect;
+}
+
 /* EOF */

Modified: trunk/lib/stroke.hxx
===================================================================
--- trunk/lib/stroke.hxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/stroke.hxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -22,6 +22,7 @@
 
 #include <vector>
 #include <ClanLib/Core/Math/point.h>
+#include <ClanLib/Core/Math/rect.h>
 #include <ClanLib/Core/System/system.h>
 #include "shared_ptr.hxx"
 
@@ -29,6 +30,9 @@
 class StrokeDrawer;
 class CL_GraphicContext;
 
+/** A dab is basically an event send from the mouse to the drawing
+    canvas, it consists of time, position, tilt, pressure and possible
+    additional information that is needed */
 class Dab
 {
 public:
@@ -58,11 +62,12 @@
   {}
 };
 
+/** A Stroke is a series of Dabs */
 class Stroke
 {
 public:
   typedef std::vector<Dab> Dabs;
-
+  
   Stroke();
 
   void draw(CL_GraphicContext* gc) const;
@@ -73,6 +78,8 @@
   Dabs  get_dabs()  const;
 
   int get_dab_count() const;
+
+  CL_Rectf get_bounding_rect() const;
 private:
   SharedPtr<StrokeImpl> impl;
 };

Modified: trunk/lib/tilemap_layer.cxx
===================================================================
--- trunk/lib/tilemap_layer.cxx	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/lib/tilemap_layer.cxx	2005-03-15 13:31:38 UTC (rev 493)
@@ -153,7 +153,7 @@
                           this->background_color);
   CL_Display::flush();
 
-  CL_Rect rect = parent->get_clip_rect();
+  CL_Rect rect(parent->get_clip_rect());
 
   int start_x = std::max(0, rect.left / tile_size);
   int start_y = std::max(0, rect.top  / tile_size);

Modified: trunk/paint/paint.rb
===================================================================
--- trunk/paint/paint.rb	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/paint/paint.rb	2005-03-15 13:31:38 UTC (rev 493)
@@ -26,7 +26,7 @@
 
 flexlay = Flexlay.new()
 
-$screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(1152, 864))
+$screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(800, 600))
 
 flexlay.init($screen_rect.get_width(), $screen_rect.get_height(), false)
 

Modified: trunk/pingus/gui.rb
===================================================================
--- trunk/pingus/gui.rb	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/pingus/gui.rb	2005-03-15 13:31:38 UTC (rev 493)
@@ -107,7 +107,8 @@
     (type, sprite) = get_ruby_object(brush.get_data()) # object type 'groundpiece'
     
     worldobj = WorldObj.new(type, sprite)
-    
+
+    puts "String: #{worldobj.get_image()}"
     obj = ObjMapSpriteObject.new(CL_Sprite.new(worldobj.get_image(), $resources), 
                                  pos, 
                                  make_metadata(worldobj))

Modified: trunk/pingus/worldobjs.rb
===================================================================
--- trunk/pingus/worldobjs.rb	2005-03-01 12:48:16 UTC (rev 492)
+++ trunk/pingus/worldobjs.rb	2005-03-15 13:31:38 UTC (rev 493)
@@ -154,6 +154,8 @@
         
       when "ROT90"
       when "ROT180"
+        @data.flip_vertical()
+        @data.flip_horizontal()
       when "ROT270"
       when "ROT0FLIP"
         @data.flip_horizontal()



From grumbel at sheep.berlios.de  Tue Mar 15 15:06:48 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 15 Mar 2005 15:06:48 +0100
Subject: [Flexlay-commit] r494 - trunk/supertux
Message-ID: <200503151406.j2FE6mdj031261@sheep.berlios.de>

Author: grumbel
Date: 2005-03-15 15:06:47 +0100 (Tue, 15 Mar 2005)
New Revision: 494

Modified:
   trunk/supertux/sector.rb
Log:
- fixed height bug

Modified: trunk/supertux/sector.rb
===================================================================
--- trunk/supertux/sector.rb	2005-03-15 13:31:38 UTC (rev 493)
+++ trunk/supertux/sector.rb	2005-03-15 14:06:47 UTC (rev 494)
@@ -66,7 +66,7 @@
     @gravity = 10.0
     
     @width  = get_value_from_tree(["width", "_"], data, 20)
-    @height = get_value_from_tree(["height""_"], data, 15)
+    @height = get_value_from_tree(["height", "_"], data, 15)
     
     @foreground  = TilemapLayer.new($tileset, @width, @height)
     @foreground.set_data(get_value_from_tree(["foreground-tm"], data, []))



From grumbel at sheep.berlios.de  Fri Mar 18 23:58:42 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Fri, 18 Mar 2005 23:58:42 +0100
Subject: [Flexlay-commit] r495 - trunk/paint
Message-ID: <200503182258.j2IMwgpa028489@sheep.berlios.de>

Author: grumbel
Date: 2005-03-18 23:58:41 +0100 (Fri, 18 Mar 2005)
New Revision: 495

Added:
   trunk/paint/example.scm.bz2
   trunk/paint/example11.scm.bz2
   trunk/paint/example12.scm.bz2
   trunk/paint/example13.scm.bz2
   trunk/paint/example14.scm.bz2
   trunk/paint/example15.scm.bz2
   trunk/paint/example16.scm.bz2
   trunk/paint/example17.scm.bz2
   trunk/paint/example18.scm.bz2
   trunk/paint/example19.scm.bz2
   trunk/paint/example2.scm.bz2
   trunk/paint/example20.scm.bz2
   trunk/paint/example21.scm.bz2
   trunk/paint/example22.scm.bz2
   trunk/paint/example23.scm.bz2
   trunk/paint/example24.scm.bz2
   trunk/paint/example25.scm.bz2
   trunk/paint/example26.scm.bz2
   trunk/paint/example27.scm.bz2
   trunk/paint/example28.scm.bz2
   trunk/paint/example29.scm.bz2
   trunk/paint/example3.scm.bz2
   trunk/paint/example30.scm.bz2
   trunk/paint/example31.scm.bz2
   trunk/paint/example32.scm.bz2
   trunk/paint/example33.scm.bz2
   trunk/paint/example4.scm.bz2
   trunk/paint/example5.scm.bz2
   trunk/paint/example6.scm.bz2
   trunk/paint/example7.scm.bz2
   trunk/paint/example8.scm.bz2
   trunk/paint/example9.scm.bz2
Modified:
   trunk/paint/paint.rb
Log:
- added a bunch of example images
- added toolbar

Added: trunk/paint/example.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example11.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example11.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example12.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example12.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example13.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example13.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example14.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example14.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example15.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example15.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example16.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example16.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example17.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example17.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example18.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example18.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example19.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example19.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example2.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example2.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example20.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example20.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example21.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example21.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example22.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example22.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example23.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example23.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example24.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example24.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example25.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example25.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example26.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example26.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example27.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example27.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example28.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example28.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example29.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example29.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example3.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example3.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example30.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example30.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example31.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example31.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example32.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example32.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example33.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example33.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example4.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example4.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example5.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example5.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example6.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example6.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example7.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example7.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example8.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example8.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/paint/example9.scm.bz2
===================================================================
(Binary files differ)


Property changes on: trunk/paint/example9.scm.bz2
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/paint/paint.rb
===================================================================
--- trunk/paint/paint.rb	2005-03-15 14:06:47 UTC (rev 494)
+++ trunk/paint/paint.rb	2005-03-18 22:58:41 UTC (rev 495)
@@ -27,10 +27,12 @@
 flexlay = Flexlay.new()
 
 $screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(800, 600))
+# $screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(1152, 864))
 
 flexlay.init($screen_rect.get_width(), $screen_rect.get_height(), false)
 
 $sketch_stroke_tool  = SketchStrokeTool.new()
+$layer_move_tool     = LayerMoveTool.new()
 $zoom_tool           = ZoomTool.new()
 
 class PaintGUI
@@ -43,7 +45,8 @@
     @editor_map = EditorMapComponent.new($screen_rect, @gui.get_component())
     @workspace  = Workspace.new($screen_rect.get_width(), $screen_rect.get_height())
     @editor_map.set_workspace(@workspace)
-    @workspace.set_tool($sketch_stroke_tool.to_tool());
+    # @workspace.set_tool($sketch_stroke_tool.to_tool());
+    @workspace.set_tool($layer_move_tool.to_tool());
 
     @selector_window_main = Window.new(CL_Rect.new(CL_Point.new($screen_rect.get_width()-160, 5), 
                                                    CL_Size.new(128 + 6 + 10, 558)),
@@ -144,10 +147,10 @@
                })
 
     connect_v2(@editor_map.sig_on_key("g"),  proc{ |x, y|
-                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() + 1)
+                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() - 10)
                })
     connect_v2(@editor_map.sig_on_key("c"),  proc{ |x, y| 
-                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() - 1)
+                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() + 10)
                })
 
     @normal_mode = CL_Button.new(CL_Rect.new(CL_Point.new(5, 500), CL_Size.new(40, 25)), "Norm", @selector_window)
@@ -172,6 +175,16 @@
               drawer.set_mode(SpriteStrokeDrawer::DM_SHADER)
             })
 
+    button_panel = ButtonPanel.new(0, 0, 33, 33*3, false, @gui.get_component)
+    button_panel.add_icon("../data/images/tools/stock-tool-pencil-22.png", proc{ 
+                            @workspace.set_tool($sketch_stroke_tool.to_tool())
+                          })
+    button_panel.add_icon("../data/images/tools/stock-tool-move-22.png", proc{ 
+                            @workspace.set_tool($layer_move_tool.to_tool())
+                          })
+    button_panel.add_icon("../data/images/tools/stock-tool-zoom-22.png", proc{ 
+                            @workspace.set_tool($zoom_tool.to_tool())
+                          })
   end
 
   def quit()
@@ -204,12 +217,13 @@
   
   def set_active_layer(i)
     if (i >= 0 && i < layers.size) then
-      SketchLayer.set_current(layers[i])
+      BitmapLayer.set_current(layers[i])
     end
   end
 
   def add_layer()
-    layer = SketchLayer.new()
+    layer = BitmapLayer.new(640, 480)
+    layer.to_layer().set_pos(CL_Pointf.new(rand(100)-50, rand(100)-50))
     @layers.push(layer)
     @editormap.add_layer(layer.to_layer()) 
     puts "Add layer: #{layer}" 



From grumbel at sheep.berlios.de  Fri Mar 18 23:59:15 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Fri, 18 Mar 2005 23:59:15 +0100
Subject: [Flexlay-commit] r496 - trunk/lib
Message-ID: <200503182259.j2IMxFxN028526@sheep.berlios.de>

Author: grumbel
Date: 2005-03-18 23:59:13 +0100 (Fri, 18 Mar 2005)
New Revision: 496

Added:
   trunk/lib/bitmap_layer.cxx
   trunk/lib/bitmap_layer.hxx
   trunk/lib/layer_move_tool.cxx
   trunk/lib/layer_move_tool.hxx
   trunk/lib/serializer.cxx
   trunk/lib/serializer.hxx
   trunk/lib/sexpr_serializer.cxx
   trunk/lib/sexpr_serializer.hxx
Modified:
   trunk/lib/SConstruct
   trunk/lib/editor_map.cxx
   trunk/lib/editor_map.hxx
   trunk/lib/flexlay_wrap.i
   trunk/lib/layer.cxx
   trunk/lib/layer.hxx
   trunk/lib/layer_impl.hxx
   trunk/lib/sketch_layer.hxx
   trunk/lib/sketch_stroke_tool.cxx
Log:
- switched the way layers are handled

Modified: trunk/lib/SConstruct
===================================================================
--- trunk/lib/SConstruct	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/SConstruct	2005-03-18 22:59:13 UTC (rev 496)
@@ -67,6 +67,7 @@
     'flexlay.cxx',
     'globals.cxx',
     'layer.cxx',
+    'layer_move_tool.cxx',
     'helper.cxx', 
     'graphic_context_state.cxx',
     'gui_manager.cxx',
@@ -95,6 +96,7 @@
     'menubar.cxx',
     'popup_menu.cxx',
     'lispreader.cxx',
+    'bitmap_layer.cxx',
     'sketch_layer.cxx',
     'sketch_stroke_tool.cxx',
     'stroke.cxx',

Added: trunk/lib/bitmap_layer.cxx
===================================================================
--- trunk/lib/bitmap_layer.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/bitmap_layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,162 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include <assert.h>
+#include <ClanLib/gl.h>
+#include <ClanLib/Core/core_iostream.h>
+#include <ClanLib/Core/System/error.h>
+#include <ClanLib/Display/display.h>
+#include <ClanLib/Display/sprite.h>
+#include <ClanLib/Display/pixel_buffer.h>
+#include <ClanLib/Display/canvas.h>
+#include <ClanLib/Display/blend_func.h>
+#include <ClanLib/Display/graphic_context.h>
+#include <ClanLib/Display/display_window.h>
+#include "flexlay.hxx"
+#include "editor_map_component.hxx"
+#include "workspace.hxx"
+#include "layer_impl.hxx"
+#include "bitmap_layer.hxx"
+#include "math.hxx"
+
+BitmapLayer* BitmapLayer::current_ = 0;
+
+class BitmapLayerImpl : public LayerImpl
+{
+public:
+  typedef std::vector<Stroke> Strokes;
+  /** All strokes done on this image are recorded for possible later
+      playback on a larger size canvas */
+  Strokes strokes;
+
+  /** Used to cache drawings */
+  CL_Surface  surface;
+  CL_Canvas*  canvas;
+  CL_Pointf   last_pos;
+
+  BitmapLayerImpl(CL_Surface surface_)
+    : surface(surface_),
+      canvas(0)
+  {
+    try {
+      canvas = new CL_Canvas(surface);
+      canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
+      canvas->get_gc()->flush();
+      canvas->sync_surface();
+    } catch(CL_Error& err) {
+      std::cout << "CL_Error: " << err.message << std::endl;
+      throw err;
+    }
+  }
+  
+  BitmapLayerImpl(int width, int height) 
+    : surface(CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888)),
+      canvas(0)
+  {
+    try {
+      canvas = new CL_Canvas(surface);
+      canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
+      canvas->get_gc()->flush();
+      canvas->sync_surface();
+    } catch(CL_Error& err) {
+      std::cout << "CL_Error: " << err.message << std::endl;
+      throw err;
+    }
+  }
+
+  ~BitmapLayerImpl() {
+    delete canvas;
+  }
+
+  void draw(EditorMapComponent* parent) 
+  {
+    assert(canvas);
+
+    // Nothing to draw, so we go byebye
+    if (strokes.empty()) 
+      return;
+
+    surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
+    surface.draw(0, 0);
+
+    if (BitmapLayer::current()->impl.get() == this)
+      CL_Display::draw_rect(get_bounding_rect(), CL_Color(155, 155, 155, 100));
+  }
+
+  CL_Rect get_bounding_rect() { 
+    // FIXME: Do we need to handle its position here or does the Layer keep care of that?
+    return CL_Rect(CL_Point(0, 0),
+                   CL_Size(surface.get_width(), surface.get_height())); 
+  }
+
+  bool has_bounding_rect() const { 
+    return true;
+  }
+};
+
+BitmapLayer::BitmapLayer(CL_Surface surface)
+  : impl(new BitmapLayerImpl(surface))
+{
+  current_ = this;
+}
+
+BitmapLayer::BitmapLayer(int width, int height)
+  : impl(new BitmapLayerImpl(width, height))
+{
+  current_ = this;
+}
+
+void
+BitmapLayer::add_stroke(const Stroke& stroke)
+{
+  if (stroke.get_dab_count() > 0)
+    {
+      impl->strokes.push_back(stroke);
+      stroke.draw(impl->canvas->get_gc());
+      impl->canvas->sync_surface();
+    }
+}
+
+Layer
+BitmapLayer::to_layer()
+{
+   return Layer(impl);
+}
+
+std::vector<Stroke>
+BitmapLayer::get_strokes()
+{
+  return impl->strokes;
+}
+
+CL_Surface
+BitmapLayer::get_background_surface()
+{
+  return impl->surface;
+}
+
+CL_PixelBuffer
+BitmapLayer::get_pixeldata() const
+{
+  assert(0); // FIME: implemnet me
+  return CL_PixelBuffer();
+}
+
+/* EOF */

Added: trunk/lib/bitmap_layer.hxx
===================================================================
--- trunk/lib/bitmap_layer.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/bitmap_layer.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,64 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_BITMAP_LAYER_HXX
+#define HEADER_BITMAP_LAYER_HXX
+
+#include <vector>
+#include <ClanLib/Core/Math/point.h>
+#include <ClanLib/Display/color.h>
+#include "layer.hxx"
+#include "stroke.hxx"
+
+class BitmapLayerImpl;
+
+/** This layer holds a simple bitmap, size and color format are
+    configurable, it works similar to the SketchLayer, however it
+    doesn't rerender the image all the time, but simply holds it in a
+    CL_Canvas */
+class BitmapLayer
+{
+  friend class BitmapLayerImpl;
+private:
+  static BitmapLayer* current_;
+public:
+  static BitmapLayer* current() { return current_; }
+  static void set_current(BitmapLayer* c) { current_ = c; }
+
+  BitmapLayer(CL_Surface surface);
+  BitmapLayer(int width, int height);
+  
+  void add_stroke(const Stroke&);
+
+  std::vector<Stroke> get_strokes();
+
+  CL_Surface get_background_surface();
+
+  CL_PixelBuffer get_pixeldata() const;
+  
+  bool is_null() const { return !impl.get(); }
+  Layer to_layer();
+
+private:
+  SharedPtr<BitmapLayerImpl> impl;  
+};
+
+#endif
+
+/* EOF */

Modified: trunk/lib/editor_map.cxx
===================================================================
--- trunk/lib/editor_map.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/editor_map.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -119,6 +119,12 @@
   return impl->serial; 
 }
 
+int
+EditorMap::get_layer_count() const
+{
+  return static_cast<int>(impl->layers.size());
+}
+
 Layer
 EditorMap::get_layer(int i)
 {

Modified: trunk/lib/editor_map.hxx
===================================================================
--- trunk/lib/editor_map.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/editor_map.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -51,6 +51,7 @@
 
   int get_serial() const;
 
+  int get_layer_count() const;
   Layer get_layer(int i);
 
   void   set_metadata(const MetaData& obj);

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/flexlay_wrap.i	2005-03-18 22:59:13 UTC (rev 496)
@@ -56,8 +56,10 @@
 #include "scrollbar.hxx"
 #include "graphic_context_state.hxx"
  
+#include "layer_move_tool.hxx"
 #include "sketch_stroke_tool.hxx"
 #include "sketch_layer.hxx"
+#include "bitmap_layer.hxx"
 #include "stroke.hxx"
 #include "stroke_drawer.hxx"
 #include "sprite_stroke_drawer.hxx"
@@ -169,8 +171,10 @@
 %include "menubar.hxx"
 %include "scrollbar.hxx"
 
+%include "layer_move_tool.hxx"
 %include "sketch_stroke_tool.hxx"
 %include "sketch_layer.hxx"
+%include "bitmap_layer.hxx"
 %include "stroke.hxx"
 %include "stroke_drawer.hxx"
 %include "sprite_stroke_drawer.hxx"
@@ -205,5 +209,4 @@
 
 #endif
 
-
 /* EOF */

Modified: trunk/lib/layer.cxx
===================================================================
--- trunk/lib/layer.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -18,10 +18,12 @@
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
 #include <iostream>
+#include <ClanLib/Display/display.h>
 #include "layer_impl.hxx"
 #include "layer.hxx"
 
 Layer::Layer()
+  : impl(0)
 {
 }
 
@@ -38,7 +40,19 @@
 Layer::draw(EditorMapComponent* parent) 
 { 
   if (impl.get())
-    impl->draw(parent);    
+    {
+      if (impl->pos.x != 0 || impl->pos.y != 0)
+        {
+          CL_Display::push_modelview();
+          CL_Display::add_translate(impl->pos.x, impl->pos.y);
+          impl->draw(parent);    
+          CL_Display::pop_modelview();
+        }
+      else
+        {
+          impl->draw(parent);
+        }
+    }
 }
   
 bool
@@ -53,10 +67,18 @@
 CL_Rect
 Layer::get_bounding_rect() 
 { 
+  CL_Rect rect;
+  
   if (impl.get())
-    return impl->get_bounding_rect();
-  else
-    return CL_Rect();
+    {
+      rect = impl->get_bounding_rect();
+      rect.left   += static_cast<int>(impl->pos.x);
+      rect.top    += static_cast<int>(impl->pos.y);
+      rect.right  += static_cast<int>(impl->pos.x);
+      rect.bottom += static_cast<int>(impl->pos.y);
+    }
+  
+  return rect;
 }
 
 MetaData
@@ -75,4 +97,22 @@
     impl->data = data_;
 }
 
+void
+Layer::set_pos(const CL_Pointf& pos)
+{
+  impl->pos = pos;
+}
+
+CL_Pointf
+Layer::get_pos() const
+{
+  return impl->pos;
+}
+
+bool
+Layer::is_null() const
+{
+  return impl.get() == 0;
+}
+
 /* EOF */

Modified: trunk/lib/layer.hxx
===================================================================
--- trunk/lib/layer.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/layer.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -27,8 +27,8 @@
 class EditorMapComponent;
 class LayerImpl;
 
-/** Each \a EditorMap consists out of one or more \a EditorMapLayer,
-    The \a EditorMapLayer is an abstract base class from which the
+/** Each \a EditorMap consists out of one or more \a Layer,
+    The \a Layer is an abstract base class from which the
     data holding layers derive. The basic functionality of a layer
     consists only of data holding and visualization. (FIXME: move
     visuals off into another class) */
@@ -41,12 +41,23 @@
   ~Layer();
 
   MetaData get_metadata() const;
+  
+  /** Attaches a piece of MetaData to the layer, metadata is some user
+      supplied piece of data that is associated with a layer (ie. the
+      name of the layer or similar properties which aren't handled by
+      the layer itself) */
   void     set_metadata(MetaData data_);
 
   void draw(EditorMapComponent* parent);
   bool has_bounding_rect() const;
   CL_Rect get_bounding_rect();
 
+  /** Moves the layer to the given position */
+  void set_pos(const CL_Pointf& pos);
+
+  /** Returns the current position of the layer */
+  CL_Pointf get_pos() const;
+  bool is_null() const;
 private:
   SharedPtr<LayerImpl> impl;
 };

Modified: trunk/lib/layer_impl.hxx
===================================================================
--- trunk/lib/layer_impl.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/layer_impl.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -28,13 +28,23 @@
 class LayerImpl
 {
 public:
+  /** MetaData attached to the layer, MetaData can be any data
+      supplied by the user, but most commonly it is used to associate
+      the given layer with a scripting language object (PyObj, SCM,
+      etc.), so that the user can attach additional data to a layer
+      from the scripting side. */
   MetaData  data;
+  
+  /** The position of the layer */
+  CL_Pointf pos;
 
   LayerImpl() {}
   virtual ~LayerImpl() {}
 
   virtual void draw(EditorMapComponent* parent) =0;
   virtual bool has_bounding_rect() const =0;
+
+  // FIXME: Should use CL_Rectf
   virtual CL_Rect get_bounding_rect() { return CL_Rect(); }
 };
 

Added: trunk/lib/layer_move_tool.cxx
===================================================================
--- trunk/lib/layer_move_tool.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/layer_move_tool.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,133 @@
+//  $Id$
+// 
+//  Flexlay - A Generic 2D Game Editor
+//  Copyright (C) 2004 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <ClanLib/Core/Math/point.h>
+#include <ClanLib/Display/display.h>
+#include "workspace.hxx"
+#include "tool_impl.hxx"
+#include "editor_map_component.hxx"
+#include "editor_map.hxx"
+#include "layer.hxx"
+#include "layer_move_tool.hxx"
+
+class LayerMoveToolImpl : public ToolImpl
+{
+public:
+  bool scrolling;
+  CL_Pointf click_pos;
+
+  /** Position of the center */
+  CL_Pointf old_trans_offset;
+  Layer layer;
+  
+  Layer find_closed_layer(const CL_Pointf& pos)
+  {
+    Layer layer; 
+
+    EditorMap parent = EditorMapComponent::current()->get_workspace().get_map();
+
+    for(int i = 0; i < parent.get_layer_count(); ++i)
+      {
+        if (parent.get_layer(i).get_bounding_rect().is_inside(CL_Point(pos)))
+          layer = parent.get_layer(i);
+      }
+
+    return layer;
+  }
+
+  void draw() 
+  {
+    for(int i = 0; i < EditorMapComponent::current()->get_workspace().get_map().get_layer_count(); ++i)
+      {
+        Layer layer = EditorMapComponent::current()->get_workspace().get_map().get_layer(i);
+        if (layer.has_bounding_rect())
+          {
+            CL_Rect rect = layer.get_bounding_rect();
+            CL_Display::draw_line(rect.left, rect.top, rect.right, rect.bottom,
+                                  CL_Color(0, 255, 255));
+            CL_Display::draw_line(rect.left, rect.bottom, rect.right, rect.top,
+                                  CL_Color(0, 255, 255));
+          }
+      }
+  }
+
+  void on_mouse_up  (const CL_InputEvent& event) 
+  {
+    if (!layer.is_null())
+      {
+        scrolling = false;
+        update(event);
+        EditorMapComponent::current()->release_mouse();
+        layer = Layer();
+      }
+  }
+
+  void on_mouse_down(const CL_InputEvent& event)
+  {
+    EditorMapComponent* parent = EditorMapComponent::current();
+    CL_Pointf pos = parent->screen2world(event.mouse_pos);
+
+    layer = find_closed_layer(pos);
+    if (!layer.is_null())
+      {
+        scrolling = true;
+        old_trans_offset = layer.get_pos();
+        click_pos = pos;
+        EditorMapComponent::current()->capture_mouse();
+      }
+  }
+
+  void on_mouse_move(const CL_InputEvent& event)
+  {
+    if (!layer.is_null())
+      {
+        if (scrolling)
+          {
+            update(event);
+          }
+      }    
+  }
+
+  void update(const CL_InputEvent& event)
+  {
+    if (!layer.is_null())
+      {
+        EditorMapComponent* parent = EditorMapComponent::current();
+        CL_Pointf pos = parent->screen2world(event.mouse_pos);
+        layer.set_pos(old_trans_offset + (pos - click_pos));
+      }
+  }
+};
+
+LayerMoveTool::LayerMoveTool()
+  : impl(new LayerMoveToolImpl())
+{
+  impl->scrolling = false;
+  impl->click_pos = CL_Point(0, 0);
+  impl->old_trans_offset = CL_Pointf(0,0);
+}
+
+Tool
+LayerMoveTool::to_tool()
+{
+  return Tool(impl);
+}
+
+/* EOF */
+

Added: trunk/lib/layer_move_tool.hxx
===================================================================
--- trunk/lib/layer_move_tool.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/layer_move_tool.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,40 @@
+//  $Id$
+// 
+//  Flexlay - A Generic 2D Game Editor
+//  Copyright (C) 2004 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_LAYER_MOVE_TOOL_HXX
+#define HEADER_LAYER_MOVE_TOOL_HXX
+
+#include "tool.hxx"
+
+class LayerMoveToolImpl;
+
+/** */
+class LayerMoveTool : public Tool
+{
+public:
+  LayerMoveTool();
+
+  Tool to_tool();
+private:
+  SharedPtr<LayerMoveToolImpl> impl;
+};
+
+#endif
+
+/* EOF */

Added: trunk/lib/serializer.cxx
===================================================================
--- trunk/lib/serializer.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/serializer.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,42 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "serializer.hxx"
+
+Serializer
+Serializer::register_group (const char* name)
+{
+}
+
+void
+Serializer::register_float (const char* name, float& value)
+{
+}
+
+void
+Serializer::register_int   (const char* name, int& value)
+{
+}
+
+void
+Serializer::register_string(const char* name, std::string& value)
+{
+}
+
+/* EOF */

Added: trunk/lib/serializer.hxx
===================================================================
--- trunk/lib/serializer.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/serializer.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,44 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_SERIALIZER_HXX
+#define HEADER_SERIALIZER_HXX
+
+/** */
+class Serializer
+{
+private:
+public:
+  Serializer() {}
+  
+  voi  register_group_start (const char* name) =0;
+  voi  register_group_end   () =0;
+
+  void register_float (const char* name, float& value) =0;
+  void register_int   (const char* name, int& value)   =0;
+  void register_string(const char* name, std::string& value) =0;
+
+private:
+  Serializer (const Serializer&);
+  Serializer& operator= (const Serializer&);
+};
+
+#endif
+
+/* EOF */

Added: trunk/lib/sexpr_serializer.cxx
===================================================================
--- trunk/lib/sexpr_serializer.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/sexpr_serializer.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,53 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "sexpr_serializer.hxx"
+
+SexprSerializer::SexprSerializer() 
+{
+}
+  
+void
+SexprSerializer::register_group_start (const char* name)
+{
+  
+}
+
+void
+SexprSerializer::register_group_end   ()
+{
+}
+
+void
+SexprSerializer::register_float (const char* name, float& value)
+{
+  
+}
+
+void
+SexprSerializer::register_int   (const char* name, int& value)
+{
+}
+
+void
+SexprSerializer::register_string(const char* name, std::string& value)
+{
+}
+
+/* EOF */

Added: trunk/lib/sexpr_serializer.hxx
===================================================================
--- trunk/lib/sexpr_serializer.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/sexpr_serializer.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -0,0 +1,44 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_SEXPR_SERIALIZER_HXX
+#define HEADER_SEXPR_SERIALIZER_HXX
+
+/** */
+class SexprSerializer
+{
+private:
+  
+public:
+  SexprSerializer() {}
+  
+  voi  register_group_start (const char* name);
+  voi  register_group_end   ();
+
+  void register_float (const char* name, float& value);
+  void register_int   (const char* name, int& value);
+  void register_string(const char* name, std::string& value);
+
+  /** Return a string representing the serialized objects */
+  std::string get_string();
+};
+
+#endif
+
+/* EOF */

Modified: trunk/lib/sketch_layer.hxx
===================================================================
--- trunk/lib/sketch_layer.hxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/sketch_layer.hxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -28,8 +28,9 @@
 
 class SketchLayerImpl;
 
-/** Simple drawing layer to add sketches and stuff above a regular
-    level */
+/** A drawing layer that holds strokes and renders them more or less
+    efficently to the screen, for larger number of strokes this has
+    serious performance impact, use BitmapLayer instead */
 class SketchLayer
 {
 private:

Modified: trunk/lib/sketch_stroke_tool.cxx
===================================================================
--- trunk/lib/sketch_stroke_tool.cxx	2005-03-18 22:58:41 UTC (rev 495)
+++ trunk/lib/sketch_stroke_tool.cxx	2005-03-18 22:59:13 UTC (rev 496)
@@ -27,7 +27,7 @@
 #include <ClanLib/Display/input_context.h>
 #include "editor_map_component.hxx"
 #include "tool.hxx"
-#include "sketch_layer.hxx"
+#include "bitmap_layer.hxx"
 #include "sketch_stroke_tool.hxx"
 #include "sprite_stroke_drawer.hxx"
 #include "stroke.hxx"
@@ -54,7 +54,12 @@
   {
     if (drawing)
       {
+        // FIXME: This translation is a bit ugly, layer position should be handled somewhat different
+        CL_Display::push_modelview();
+        CL_Display::add_translate(BitmapLayer::current()->to_layer().get_pos().x,
+                                  BitmapLayer::current()->to_layer().get_pos().y);
         stroke.draw(0);
+        CL_Display::pop_modelview();
       }
     else
       {
@@ -80,7 +85,7 @@
         
         add_dab(event);
 
-        SketchLayer::current()->add_stroke(stroke);
+        BitmapLayer::current()->add_stroke(stroke);
       }    
   }
 
@@ -100,9 +105,12 @@
   {
     EditorMapComponent* parent = EditorMapComponent::current();
     CL_Pointf p = parent->screen2world(event.mouse_pos);    
+    
+    // FIXME: This is ugly, events relative to the layer should be handled somewhat differently
+    Dab dab(p.x - BitmapLayer::current()->to_layer().get_pos().x,
+            p.y - BitmapLayer::current()->to_layer().get_pos().y);
 
-    Dab dab(p.x, p.y);
-
+    // FIXME: Make tablet configurable
     if (CL_Display::get_current_window()->get_ic()->get_mouse_count() >= 4)
       {
         CL_InputDevice tablet = CL_Display::get_current_window()->get_ic()->get_mouse(5);



From grumbel at sheep.berlios.de  Sun Mar 20 01:45:56 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Sun, 20 Mar 2005 01:45:56 +0100
Subject: [Flexlay-commit] r498 - trunk/data/images/icons24
Message-ID: <200503200045.j2K0juxx012934@sheep.berlios.de>

Author: grumbel
Date: 2005-03-20 01:44:51 +0100 (Sun, 20 Mar 2005)
New Revision: 498

Added:
   trunk/data/images/icons24/anim_fastbackward.png
   trunk/data/images/icons24/anim_fastforward.png
   trunk/data/images/icons24/anim_next.png
   trunk/data/images/icons24/anim_play.png
   trunk/data/images/icons24/anim_playbackward.png
   trunk/data/images/icons24/anim_previous.png
   trunk/data/images/icons24/anim_skipbackward.png
   trunk/data/images/icons24/anim_skipforward.png
   trunk/data/images/icons24/anim_slowmotion.png
   trunk/data/images/icons24/anim_slowmotionbackward.png
Log:
- added animation button icons

Added: trunk/data/images/icons24/anim_fastbackward.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_fastbackward.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_fastforward.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_fastforward.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_next.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_next.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_play.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_play.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_playbackward.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_playbackward.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_previous.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_previous.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_skipbackward.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_skipbackward.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_skipforward.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_skipforward.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_slowmotion.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_slowmotion.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/data/images/icons24/anim_slowmotionbackward.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/icons24/anim_slowmotionbackward.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From grumbel at sheep.berlios.de  Sun Mar 20 02:42:23 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Sun, 20 Mar 2005 02:42:23 +0100
Subject: [Flexlay-commit] r499 - in trunk: lib paint
Message-ID: <200503200142.j2K1gNnv005938@sheep.berlios.de>

Author: grumbel
Date: 2005-03-20 02:41:52 +0100 (Sun, 20 Mar 2005)
New Revision: 499

Modified:
   trunk/lib/editor_map.cxx
   trunk/lib/editor_map.hxx
   trunk/lib/onion_skin_layer.cxx
   trunk/lib/workspace.cxx
   trunk/paint/animation.rb
   trunk/paint/paint.rb
Log:
fixed onionskin layer a bit

Modified: trunk/lib/editor_map.cxx
===================================================================
--- trunk/lib/editor_map.cxx	2005-03-20 00:44:51 UTC (rev 498)
+++ trunk/lib/editor_map.cxx	2005-03-20 01:41:52 UTC (rev 499)
@@ -80,8 +80,8 @@
   impl->serial += 1;
 }
 
-void
-EditorMap::draw (EditorMapComponent* parent, CL_GraphicContext* gc)
+void 
+EditorMap::draw_gui(CL_GraphicContext* gc)
 {
   CL_Rect rect = get_bounding_rect();
 
@@ -94,7 +94,11 @@
     {
       gc->clear(impl->background_color);
     }
+}
 
+void
+EditorMap::draw (EditorMapComponent* parent, CL_GraphicContext* gc)
+{
   for(EditorMapImpl::Layers::iterator i = impl->layers.begin(); i != impl->layers.end(); ++i)
     (*i).draw(parent, gc);
   

Modified: trunk/lib/editor_map.hxx
===================================================================
--- trunk/lib/editor_map.hxx	2005-03-20 00:44:51 UTC (rev 498)
+++ trunk/lib/editor_map.hxx	2005-03-20 01:41:52 UTC (rev 499)
@@ -43,6 +43,9 @@
 
   /** FIXME: EditorMapComponent parameter shouldn't really be here */
   void draw(EditorMapComponent* parent, CL_GraphicContext* gc);
+  
+  /** Draw stuff that is only relevant on the GUI (bounding rects and such) */
+  void draw_gui(CL_GraphicContext* gc);
 
   void add_layer(const Layer& layer, int pos = -1);
 

Modified: trunk/lib/onion_skin_layer.cxx
===================================================================
--- trunk/lib/onion_skin_layer.cxx	2005-03-20 00:44:51 UTC (rev 498)
+++ trunk/lib/onion_skin_layer.cxx	2005-03-20 01:41:52 UTC (rev 499)
@@ -39,6 +39,7 @@
   void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
   {
     // FIXME: We need to stop onion layer to draw onto itself
+    surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
     surface.draw(0, 0);
   }
 
@@ -76,15 +77,17 @@
 void
 OnionSkinLayer::clear()
 {
-  impl->canvas->get_gc()->clear();
+  impl->canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
   impl->canvas->sync_surface();
 }
 
 void
 OnionSkinLayer::add_map(EditorMap editor_map, float transparency)
 {
+  // FIXME: EditorMap does draw stuff that isn't usefull for onionskin (bounding rects, etc)
+
   // FIXME: Parameter are a bit unclear here
-  impl->canvas2->get_gc()->clear();
+  impl->canvas2->get_gc()->clear(CL_Color(0, 0, 0, 0));
   editor_map.draw(EditorMapComponent::current(), impl->canvas2->get_gc());
   impl->canvas2->sync_surface();
   impl->surface2.set_alpha(transparency);

Modified: trunk/lib/workspace.cxx
===================================================================
--- trunk/lib/workspace.cxx	2005-03-20 00:44:51 UTC (rev 498)
+++ trunk/lib/workspace.cxx	2005-03-20 01:41:52 UTC (rev 499)
@@ -62,6 +62,7 @@
 
   CL_Display::clear(CL_Color(100, 0, 100));
 
+  impl->editor_map.draw_gui(CL_Display::get_current_window()->get_gc());
   impl->editor_map.draw(EditorMapComponent::current(), CL_Display::get_current_window()->get_gc());
   
   if (1) // has_mouse_over()) FIXME: Seperate cursor and state here

Modified: trunk/paint/animation.rb
===================================================================
--- trunk/paint/animation.rb	2005-03-20 00:44:51 UTC (rev 498)
+++ trunk/paint/animation.rb	2005-03-20 01:41:52 UTC (rev 499)
@@ -35,9 +35,13 @@
       # onion_skin.to_layer().set_pos(CL_Pointf.new(-100, -100))
       img.editormap.add_layer(onion_skin.to_layer(), 0)
       
-      if (@current_frame > 0) then
-        onion_skin.add_map(@frames[@current_frame - 1].editormap, 0.5)
+      if (@frames.length > 1) then
+        onion_skin.add_map(@frames[(@current_frame - 1)%@frames.length].editormap, 0.5)
       end
+
+      if (@frames.length > 2) then
+        onion_skin.add_map(@frames[(@current_frame - 2)%@frames.length].editormap, 0.25)
+      end      
     end
   end
 end

Modified: trunk/paint/paint.rb
===================================================================
--- trunk/paint/paint.rb	2005-03-20 00:44:51 UTC (rev 498)
+++ trunk/paint/paint.rb	2005-03-20 01:41:52 UTC (rev 499)
@@ -48,7 +48,7 @@
 $image.activate($gui.workspace)
 
 drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-if true then
+if false then
   drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
                                       32,  # radius
                                       2,   # spikes



From grumbel at sheep.berlios.de  Sun Mar 20 03:10:01 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Sun, 20 Mar 2005 03:10:01 +0100
Subject: [Flexlay-commit] r500 - in trunk: lib paint
Message-ID: <200503200210.j2K2A1ET018312@sheep.berlios.de>

Author: grumbel
Date: 2005-03-20 03:09:45 +0100 (Sun, 20 Mar 2005)
New Revision: 500

Modified:
   trunk/lib/layer.hxx
   trunk/lib/onion_skin_layer.cxx
   trunk/lib/onion_skin_layer.hxx
   trunk/paint/animation.rb
Log:
- some additions to the onionskin

Modified: trunk/lib/layer.hxx
===================================================================
--- trunk/lib/layer.hxx	2005-03-20 01:41:52 UTC (rev 499)
+++ trunk/lib/layer.hxx	2005-03-20 02:09:45 UTC (rev 500)
@@ -59,7 +59,7 @@
   /** Returns the current position of the layer */
   CL_Pointf get_pos() const;
   bool is_null() const;
-private:
+public:
   SharedPtr<LayerImpl> impl;
 };
 

Modified: trunk/lib/onion_skin_layer.cxx
===================================================================
--- trunk/lib/onion_skin_layer.cxx	2005-03-20 01:41:52 UTC (rev 499)
+++ trunk/lib/onion_skin_layer.cxx	2005-03-20 02:09:45 UTC (rev 500)
@@ -18,6 +18,7 @@
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
 #include <iostream>
+#include <vector>
 #include <ClanLib/Core/System/error.h>
 #include <ClanLib/Display/pixel_buffer.h>
 #include <ClanLib/Display/pixel_format.h>
@@ -36,6 +37,9 @@
   CL_Surface  surface2;
   CL_Canvas*  canvas2;
 
+  std::vector<EditorMap> editormaps;
+  std::vector<float> transparency;
+
   void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
   {
     // FIXME: We need to stop onion layer to draw onto itself
@@ -49,6 +53,11 @@
   }
 };
 
+OnionSkinLayer::OnionSkinLayer(Layer layer)
+  : impl(dynamic_cast<OnionSkinLayerImpl*>(layer.impl.get())) // FIXME: WONT WORK WITH REAL SMARTPTR!!!
+{
+}
+
 OnionSkinLayer::OnionSkinLayer(int width, int height)
   : impl(new OnionSkinLayerImpl())
 {
@@ -84,6 +93,8 @@
 void
 OnionSkinLayer::add_map(EditorMap editor_map, float transparency)
 {
+  impl->editormaps.push_back(editor_map);
+
   // FIXME: EditorMap does draw stuff that isn't usefull for onionskin (bounding rects, etc)
 
   // FIXME: Parameter are a bit unclear here
@@ -95,6 +106,21 @@
   impl->canvas->sync_surface();
 }
 
+void
+OnionSkinLayer::update()
+{
+  impl->canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
+  for (std::vector<EditorMap>::iterator i = impl->editormaps.begin(); i != impl->editormaps.end(); ++i)
+    {
+      impl->canvas2->get_gc()->clear(CL_Color(0, 0, 0, 0));
+      i->draw(EditorMapComponent::current(), impl->canvas2->get_gc());
+      impl->canvas2->sync_surface();
+      impl->surface2.set_alpha(0.5f);
+      impl->surface2.draw(0, 0, impl->canvas->get_gc());
+      impl->canvas->sync_surface();
+    }
+}
+
 Layer
 OnionSkinLayer::to_layer()
 {

Modified: trunk/lib/onion_skin_layer.hxx
===================================================================
--- trunk/lib/onion_skin_layer.hxx	2005-03-20 01:41:52 UTC (rev 499)
+++ trunk/lib/onion_skin_layer.hxx	2005-03-20 02:09:45 UTC (rev 500)
@@ -36,12 +36,16 @@
   /** FIXME: Should probally be CL_Rect instead of just
       width/height */
   OnionSkinLayer(int width, int height);
+  OnionSkinLayer(Layer layer);
   
   /** Adds an EditorMap to the OnionSkin */
   void add_map(EditorMap editor_map, float transparency);
 
   void clear();
 
+  /** Refreshes the content of the OnionSkin */
+  void update();
+  
   bool is_null() const { return !impl.get(); }
   Layer to_layer();
 private:

Modified: trunk/paint/animation.rb
===================================================================
--- trunk/paint/animation.rb	2005-03-20 01:41:52 UTC (rev 499)
+++ trunk/paint/animation.rb	2005-03-20 02:09:45 UTC (rev 500)
@@ -7,11 +7,13 @@
   def next_frame()
     @current_frame = (@current_frame + 1) % @frames.length
     get_current_image().activate($gui.workspace)
+    # OnionSkinLayer.new(get_current_image().editormap.get_layer(0)).update()
   end
 
   def previous_frame()
     @current_frame = (@current_frame - 1) % @frames.length
     get_current_image().activate($gui.workspace)
+    # OnionSkinLayer.new(get_current_image().editormap.get_layer(0)).update()
   end
 
   def get_current_image()



From grumbel at sheep.berlios.de  Fri Mar 25 17:01:31 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Fri, 25 Mar 2005 17:01:31 +0100
Subject: [Flexlay-commit] r501 - in trunk: lib paint
Message-ID: <200503251601.j2PG1V2h001379@sheep.berlios.de>

Author: grumbel
Date: 2005-03-25 17:01:28 +0100 (Fri, 25 Mar 2005)
New Revision: 501

Modified:
   trunk/lib/SConstruct
   trunk/lib/bitmap_layer.cxx
   trunk/lib/bitmap_layer.hxx
   trunk/lib/flexlay_wrap.i
   trunk/lib/object_layer.cxx
   trunk/lib/object_layer.hxx
   trunk/lib/onion_skin_layer.cxx
   trunk/lib/onion_skin_layer.hxx
   trunk/lib/sketch_stroke_tool.cxx
   trunk/lib/sketch_stroke_tool.hxx
   trunk/lib/sprite_stroke_drawer.cxx
   trunk/lib/sprite_stroke_drawer.hxx
   trunk/lib/stroke.cxx
   trunk/lib/stroke.hxx
   trunk/paint/animation.rb
   trunk/paint/gui.rb
   trunk/paint/paint.rb
Log:
- moved dab interpolation into stroke class
- added basic smudge tool (not really working)

Modified: trunk/lib/SConstruct
===================================================================
--- trunk/lib/SConstruct	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/SConstruct	2005-03-25 16:01:28 UTC (rev 501)
@@ -61,6 +61,7 @@
     'command.cxx',
     'console.cxx',
     'colorpicker.cxx',
+    'drawer_properties.cxx',
     'editor.cxx',
     'editor_map.cxx',
     'editor_map_component.cxx',

Modified: trunk/lib/bitmap_layer.cxx
===================================================================
--- trunk/lib/bitmap_layer.cxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/bitmap_layer.cxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -130,6 +130,8 @@
     {
       impl->strokes.push_back(stroke);
       stroke.draw(impl->canvas->get_gc());
+      // FIXME: doesn't sync when manually manipulating the canvas
+      impl->canvas->get_gc()->flush();
       impl->canvas->sync_surface();
     }
 }
@@ -152,6 +154,12 @@
   return impl->surface;
 }
 
+CL_Canvas*
+BitmapLayer::get_canvas() const
+{
+  return impl->canvas;
+}
+
 CL_PixelBuffer
 BitmapLayer::get_pixeldata() const
 {

Modified: trunk/lib/bitmap_layer.hxx
===================================================================
--- trunk/lib/bitmap_layer.hxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/bitmap_layer.hxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -51,12 +51,13 @@
   CL_Surface get_background_surface();
 
   CL_PixelBuffer get_pixeldata() const;
+  CL_Canvas*     get_canvas() const;
   
   bool is_null() const { return !impl.get(); }
   Layer to_layer();
 
 private:
-  SharedPtr<BitmapLayerImpl> impl;  
+  SharedPtr<BitmapLayerImpl> impl;
 };
 
 #endif

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/flexlay_wrap.i	2005-03-25 16:01:28 UTC (rev 501)
@@ -63,6 +63,7 @@
 #include "bitmap_layer.hxx"
 #include "stroke.hxx"
 #include "stroke_drawer.hxx"
+#include "drawer_properties.hxx"
 #include "sprite_stroke_drawer.hxx"
 #include "brushmask.hxx"
 #include "brush.hxx"
@@ -180,6 +181,7 @@
 %include "bitmap_layer.hxx"
 %include "stroke.hxx"
 %include "stroke_drawer.hxx"
+%include "drawer_properties.hxx"
 %include "sprite_stroke_drawer.hxx"
 %include "brushmask.hxx"
 %include "brush.hxx"

Modified: trunk/lib/object_layer.cxx
===================================================================
--- trunk/lib/object_layer.cxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/object_layer.cxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -154,4 +154,14 @@
   return Layer(impl);
 }
 
+void
+ObjectLayer::raise(const ObjMapObject& obj)
+{
+}
+
+void
+ObjectLayer::lower(const ObjMapObject& obj)
+{
+}
+
 /* EOF */

Modified: trunk/lib/object_layer.hxx
===================================================================
--- trunk/lib/object_layer.hxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/object_layer.hxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -33,8 +33,9 @@
 class ObjectLayerImpl;
 
 /** The ObjectLayer provides a simple Layer for holding positioned
-    objects. Objects consist of a CL_Sprite and some properties
-    accessible from scripting languages */
+    objects. Objects can consist of a CL_Sprite and some properties
+    accessible from scripting languages or any other thing that is a
+    ObjMapObject. */
 class ObjectLayer
 {
 public:
@@ -52,6 +53,12 @@
   void add_object(const ObjMapObject& obj);
   void delete_object(const ObjMapObject& obj);
 
+  /** Moved the given object one position up in the object stack */
+  void raise(const ObjMapObject& obj);
+
+  /** Moved the given object one position down in the object stack */
+  void lower(const ObjMapObject& obj);
+
   void add_control_point(const ObjMapControlPoint& obj);
   void delete_control_points();
 

Modified: trunk/lib/onion_skin_layer.cxx
===================================================================
--- trunk/lib/onion_skin_layer.cxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/onion_skin_layer.cxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -28,6 +28,8 @@
 #include "layer_impl.hxx"
 #include "onion_skin_layer.hxx"
 
+#define SCALE 4
+
 class OnionSkinLayerImpl : public LayerImpl
 {
 public:
@@ -38,12 +40,13 @@
   CL_Canvas*  canvas2;
 
   std::vector<EditorMap> editormaps;
-  std::vector<float> transparency;
+  std::vector<CL_Color>  color;
 
   void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
   {
     // FIXME: We need to stop onion layer to draw onto itself
     surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
+    surface.set_scale(SCALE, SCALE);
     surface.draw(0, 0);
   }
 
@@ -61,8 +64,8 @@
 OnionSkinLayer::OnionSkinLayer(int width, int height)
   : impl(new OnionSkinLayerImpl())
 {
-  impl->surface  = CL_Surface(CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888));
-  impl->surface2 = CL_Surface(CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888));
+  impl->surface  = CL_Surface(CL_PixelBuffer(width/SCALE, height/SCALE, width*4/SCALE, CL_PixelFormat::rgba8888));
+  impl->surface2 = CL_Surface(CL_PixelBuffer(width/SCALE, height/SCALE, width*4/SCALE, CL_PixelFormat::rgba8888));
 
   try
     {
@@ -91,31 +94,29 @@
 }
 
 void
-OnionSkinLayer::add_map(EditorMap editor_map, float transparency)
+OnionSkinLayer::add_map(EditorMap editor_map, const CL_Color& color)
 {
   impl->editormaps.push_back(editor_map);
-
-  // FIXME: EditorMap does draw stuff that isn't usefull for onionskin (bounding rects, etc)
-
-  // FIXME: Parameter are a bit unclear here
-  impl->canvas2->get_gc()->clear(CL_Color(0, 0, 0, 0));
-  editor_map.draw(EditorMapComponent::current(), impl->canvas2->get_gc());
-  impl->canvas2->sync_surface();
-  impl->surface2.set_alpha(transparency);
-  impl->surface2.draw(0, 0, impl->canvas->get_gc());
-  impl->canvas->sync_surface();
+  impl->color.push_back(color);
 }
 
 void
 OnionSkinLayer::update()
 {
   impl->canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
-  for (std::vector<EditorMap>::iterator i = impl->editormaps.begin(); i != impl->editormaps.end(); ++i)
+  for (std::vector<EditorMap>::size_type i = 0; i < impl->editormaps.size(); ++i)
     {
       impl->canvas2->get_gc()->clear(CL_Color(0, 0, 0, 0));
-      i->draw(EditorMapComponent::current(), impl->canvas2->get_gc());
+      impl->canvas2->get_gc()->push_modelview();
+      impl->canvas2->get_gc()->add_scale(1.0f/SCALE, 1.0f/SCALE);
+
+      impl->editormaps[i].draw(EditorMapComponent::current(), impl->canvas2->get_gc());
+
+      impl->canvas2->get_gc()->pop_modelview();
+
       impl->canvas2->sync_surface();
-      impl->surface2.set_alpha(0.5f);
+
+      impl->surface2.set_color(impl->color[i]);
       impl->surface2.draw(0, 0, impl->canvas->get_gc());
       impl->canvas->sync_surface();
     }

Modified: trunk/lib/onion_skin_layer.hxx
===================================================================
--- trunk/lib/onion_skin_layer.hxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/onion_skin_layer.hxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -39,7 +39,7 @@
   OnionSkinLayer(Layer layer);
   
   /** Adds an EditorMap to the OnionSkin */
-  void add_map(EditorMap editor_map, float transparency);
+  void add_map(EditorMap editor_map, const CL_Color& color);
 
   void clear();
 

Modified: trunk/lib/sketch_stroke_tool.cxx
===================================================================
--- trunk/lib/sketch_stroke_tool.cxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/sketch_stroke_tool.cxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -32,6 +32,7 @@
 #include "sprite_stroke_drawer.hxx"
 #include "stroke.hxx"
 #include "stroke_drawer.hxx"
+#include "drawer_properties.hxx"
 #include "flexlay.hxx"
 
 class SketchStrokeToolImpl : public ToolImpl
@@ -46,8 +47,6 @@
   {
     sprite_drawer.set_mode(SpriteStrokeDrawer::DM_NORMAL);
     //sprite_drawer.set_sprite(CL_Sprite("brush", &(Flexlay::current()->resources)));
-    sprite_drawer.set_color(CL_Color(255, 255, 255, 255));
-    sprite_drawer.set_size(1.0f);  
   }
 
   void draw() 
@@ -66,10 +65,10 @@
         EditorMapComponent* parent = EditorMapComponent::current();
         CL_Pointf p = parent->screen2world(CL_Point(CL_Mouse::get_x() - parent->get_screen_x(), 
                                                     CL_Mouse::get_y() - parent->get_screen_y()));
-        CL_Sprite s = sprite_drawer.get_brush().get_sprite();
-        s.set_color(sprite_drawer.get_color());
+        CL_Sprite s = DrawerProperties::current()->get_brush().get_sprite();
+        s.set_color(DrawerProperties::current()->get_color());
         // FIXME: when using mouse 1.0, when tablet .5f
-        s.set_scale(sprite_drawer.get_size()*0.5f, sprite_drawer.get_size()*0.5f);
+        s.set_scale(DrawerProperties::current()->get_size()*0.5f, DrawerProperties::current()->get_size()*0.5f);
         s.set_alpha(0.5);
         s.draw(p.x, p.y);
       }
@@ -151,18 +150,6 @@
 {
 }
 
-void 
-SketchStrokeTool::set_color(const CL_Color& color_)
-{
-  impl->sprite_drawer.set_color(color_);
-}
-
-void
-SketchStrokeTool::set_size(float size_)
-{
-  impl->sprite_drawer.set_size(size_);
-}
-
 Tool
 SketchStrokeTool::to_tool()
 {

Modified: trunk/lib/sketch_stroke_tool.hxx
===================================================================
--- trunk/lib/sketch_stroke_tool.hxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/sketch_stroke_tool.hxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -32,8 +32,6 @@
 public:
   SketchStrokeTool();
 
-  void set_size(float size);
-  void set_color(const CL_Color& color);
   StrokeDrawer get_drawer();
 
   Tool to_tool();

Modified: trunk/lib/sprite_stroke_drawer.cxx
===================================================================
--- trunk/lib/sprite_stroke_drawer.cxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/sprite_stroke_drawer.cxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -20,12 +20,15 @@
 #include <iostream>
 #include <assert.h>
 #include <ClanLib/Display/blend_func.h>
+#include <ClanLib/Display/canvas.h>
 #include <ClanLib/gl.h>
 #include <ClanLib/GL/opengl_wrap.h>
 #include "stroke.hxx"
 #include "flexlay.hxx"
 #include "stroke_drawer_impl.hxx"
 #include "sprite_stroke_drawer.hxx"
+#include "drawer_properties.hxx"
+#include "bitmap_layer.hxx"
 #include "sketch_layer.hxx"
 
 CL_ProgramObject* program = 0;
@@ -34,10 +37,6 @@
 {
 public:
   SpriteStrokeDrawer::DrawMode mode;
-  CL_Color  color;
-  float     base_size;
-  float     spacing;
-  Brush     brush;
   
   SpriteStrokeDrawerImpl() {}
 
@@ -57,20 +56,19 @@
 SpriteStrokeDrawer::SpriteStrokeDrawer()
   : impl(new SpriteStrokeDrawerImpl())
 {
-  impl->base_size = 1.0f;
-  impl->spacing   = 15.0f;
   impl->mode      = SpriteStrokeDrawer::DM_NORMAL;
 }
 
 void
 SpriteStrokeDrawerImpl::draw_dab(const Dab& dab, CL_GraphicContext* gc)
 {
-  CL_Sprite sprite = brush.get_sprite();
+  CL_Sprite sprite = DrawerProperties::current()->get_brush().get_sprite();
 
+  CL_Color color = DrawerProperties::current()->get_color();
   sprite.set_color(color);
   sprite.set_alpha((color.get_alpha()/255.0f) * dab.pressure);
-  sprite.set_scale(base_size * dab.pressure,
-                   base_size * dab.pressure);
+  sprite.set_scale(DrawerProperties::current()->get_size() * dab.pressure,
+                   DrawerProperties::current()->get_size() * dab.pressure);
 
   if (gc != 0)
     {
@@ -126,7 +124,33 @@
           sprite.set_blend_func(blend_zero, blend_one_minus_src_alpha);
           sprite.draw(dab.pos.x, dab.pos.y, gc);
           break;
+          
+        case SpriteStrokeDrawer::DM_SMUDGE:
+          {
+            // FIXME: These need to get reset on a new stroke
+            static int last_pos_x = 0;
+            static int last_pos_y = 0;
 
+            if (last_pos_y != 0 || last_pos_x != 0)
+              {
+                CL_Canvas* canvas = BitmapLayer::current()->get_canvas();
+                CL_PixelBuffer buffer = canvas->get_pixeldata(CL_Rect(CL_Point(last_pos_x - sprite.get_width()/2,
+                                                                               last_pos_y - sprite.get_height()/2),
+                                                                      CL_Size(sprite.get_width(), sprite.get_height())));
+                CL_Surface surface(buffer);
+                //surface.set_blend_func_separate(blend_src_alpha, blend_one_minus_src_alpha,
+                //                                blend_one, blend_zero);
+                //surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
+                surface.set_alignment(origin_center);
+                surface.set_alpha(0.8);
+                surface.draw(dab.pos.x, dab.pos.y, gc);
+              }
+
+            last_pos_x = static_cast<int>(dab.pos.x);
+            last_pos_y = static_cast<int>(dab.pos.y);
+          }
+          break;
+
         case SpriteStrokeDrawer::DM_SHADER:
           {
 #if 0 
@@ -162,9 +186,9 @@
             glEnable(GL_TEXTURE_2D);
 
             /*CL_OpenGLSurface glsurface2(SketchLayer::current()->get_background_surface());
-            glActiveTexture(GL_TEXTURE1);
-            glsurface2.bind();
-            glEnable(GL_TEXTURE_2D);*/
+              glActiveTexture(GL_TEXTURE1);
+              glsurface2.bind();
+              glEnable(GL_TEXTURE_2D);*/
             
             clUniform1i(program->get_attribute_location("mytex"), 0);
             //clUniform1i(program->get_attribute_location("background"), 1);
@@ -202,7 +226,7 @@
         {
         case SpriteStrokeDrawer::DM_NORMAL:  
           sprite.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);  
+          sprite.draw(dab.pos.x, dab.pos.y, gc);
           break;
               
         case SpriteStrokeDrawer::DM_ADDITION:
@@ -214,6 +238,11 @@
           sprite.set_blend_func(blend_zero, blend_one_minus_src_alpha);
           sprite.draw(dab.pos.x, dab.pos.y, gc);
           break; 
+          
+        case SpriteStrokeDrawer::DM_SMUDGE:
+          sprite.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
+          sprite.draw(dab.pos.x, dab.pos.y, gc);          
+          break;
 
         default:
           std::cout << "Error: SpriteStrokeDrawer: Unknown draw mode: " << mode << std::endl;
@@ -225,92 +254,21 @@
 void
 SpriteStrokeDrawerImpl::draw(const Stroke& stroke, CL_GraphicContext* gc)
 {
-  if (brush.is_null() || stroke.get_dab_count() == 0)
+  if (DrawerProperties::current()->get_brush().is_null() || stroke.get_dab_count() == 0)
     return;
-    
-  draw_dab(stroke.get_dabs().front(), gc);
   
-  float overspace = 0.0f;
-  Stroke::Dabs dabs = stroke.get_dabs();
-  for(unsigned int j = 0; j < dabs.size()-1; ++j)
-    {
-      CL_Pointf dist = dabs[j+1].pos - dabs[j].pos;
-      float length = sqrt(dist.x * dist.x + dist.y * dist.y);
-      int n = 1;
-    
-      // Spacing is keep relative to the brush size
-      float local_spacing = spacing * base_size * dabs[j].pressure;
+  Stroke::Dabs dabs = stroke.get_interpolated_dabs(DrawerProperties::current()->get_spacing()
+                                                   * DrawerProperties::current()->get_size(),
+                                                   DrawerProperties::current()->get_spacing()
+                                                   * DrawerProperties::current()->get_size());
 
-      while (length + overspace > (local_spacing * n))
-        {
-          float factor = (local_spacing/length) * n - (overspace/length);
-          
-          // FIXME: Interpolate tilting, pressure, etc. along the line
-          draw_dab(Dab(dabs[j].pos.x + dist.x * factor,
-                       dabs[j].pos.y + dist.y * factor,
-                       dabs[j].pressure),
-                   gc);
-              
-          n += 1;
-        }
-
-      // calculate the space that wasn't used in the last iteration
-      overspace = (length + overspace) - (local_spacing * (n-1));
+  for(Stroke::Dabs::iterator i = dabs.begin(); i != dabs.end(); ++i)
+    {
+      draw_dab(*i, gc);
     }
 }
 
 void
-SpriteStrokeDrawer::set_spacing(float spacing_)
-{
-  impl->spacing = spacing_;
-}
-
-float
-SpriteStrokeDrawer::get_spacing() const
-{
-  return impl->spacing;
-}
-
-void
-SpriteStrokeDrawer::set_size(float s)
-{
-  impl->base_size = s;
-}
-
-float
-SpriteStrokeDrawer::get_size() const
-{
-  return impl->base_size;
-}
-
-void
-SpriteStrokeDrawer::set_color(const CL_Color& color_)
-{
-  impl->color = color_;
-}
-
-CL_Color
-SpriteStrokeDrawer::get_color() const
-{
-  return impl->color;
-}
-
-void
-SpriteStrokeDrawer::set_sprite(const CL_Sprite& sprite_)
-{
-  assert(!"No longer supported");
-  //impl->brush = sprite_;
-  //impl->brush.set_alignment(origin_center);
-}
-
-CL_Sprite
-SpriteStrokeDrawer::get_sprite() const
-{
-  assert(!"No longer supported");
-  return CL_Sprite();//impl->brush;
-}
-
-void
 SpriteStrokeDrawer::set_mode(DrawMode mode)
 {
   impl->mode = mode;
@@ -328,8 +286,7 @@
   SpriteStrokeDrawerImpl* drawer = new SpriteStrokeDrawerImpl();
   
   *drawer = *this;
-  drawer->brush = brush.clone();
-  
+    
   return drawer;
 }
 
@@ -339,16 +296,4 @@
   return StrokeDrawer(impl);
 }
 
-void
-SpriteStrokeDrawer::set_brush(const Brush& brush)
-{
-  impl->brush = brush;
-}
-
-Brush
-SpriteStrokeDrawer::get_brush() const
-{
-  return impl->brush;
-}
-
 /* EOF */

Modified: trunk/lib/sprite_stroke_drawer.hxx
===================================================================
--- trunk/lib/sprite_stroke_drawer.hxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/sprite_stroke_drawer.hxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -32,37 +32,11 @@
 class SpriteStrokeDrawer
 {
 public:
-  enum DrawMode { DM_NORMAL, DM_ERASE, DM_ADDITION, DM_SHADER };
+  enum DrawMode { DM_NORMAL, DM_ERASE, DM_ADDITION, DM_SHADER, DM_SMUDGE  };
 
   SpriteStrokeDrawer(StrokeDrawer drawer);
   SpriteStrokeDrawer();
 
-  /** Set the spacing that will be between the sprites that are drawn
-      along the dabs */
-  void  set_spacing(float spacing);
-  float get_spacing() const;
-
-  /** Set the base size of the Sprite, the real size itself can be
-      affected by pressure and is than calculated by combining
-      basesize and pressure or tilting */
-  void  set_size(float s);
-  float get_size() const;
-
-  /** Set the base color, the real color itself is calculated from
-      combining the base color with the current pressure or tilting */
-  void     set_color(const CL_Color& color);
-  CL_Color get_color() const;
-
-  /** Set the sprite to be used, its color and size settings are
-      ignored */
-  void      set_sprite(const CL_Sprite& sprite);
-  CL_Sprite get_sprite() const;
-
-  /** Set the brush to be used, its color and size settings are
-      ignored */
-  void  set_brush(const Brush& brush);
-  Brush get_brush() const;
-
   /** The modus in which the drawing affects the image (normal, erase, addition, color, etc.) */
   void set_mode(DrawMode mode);
   DrawMode get_mode();

Modified: trunk/lib/stroke.cxx
===================================================================
--- trunk/lib/stroke.cxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/stroke.cxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -82,6 +82,55 @@
 }
 
 Stroke::Dabs
+Stroke::get_interpolated_dabs(float x_spacing, float y_spacing) const
+{
+  if (impl->dabs.size() > 0)
+    {
+      Dabs interpolated_dabs;
+
+      interpolated_dabs.push_back(impl->dabs.front());
+
+      // The following code basically takes all the event dabs as recieved
+      // by from the InputDevice and interpolates new dabs inbetween to
+      // give them an equal spacing (ie. every dab is only 'spacing' away
+      // from the next)
+      float overspace = 0.0f;
+      const Stroke::Dabs& dabs = impl->dabs;
+      for(unsigned int j = 0; j < dabs.size()-1; ++j)
+        {
+          CL_Pointf dist = dabs[j+1].pos - dabs[j].pos;
+          float length = sqrt(dist.x * dist.x + dist.y * dist.y);
+          int n = 1;
+    
+          // Spacing is keep relative to the brush size
+          // FIXME: This is specific to a Sprite based drawer, might not work for others
+          // FIXME: y_spacing isn't taken into account either
+          float local_spacing = x_spacing * dabs[j].pressure;
+
+          while (length + overspace > (local_spacing * n))
+            {
+              float factor = (local_spacing/length) * n - (overspace/length);
+          
+              // FIXME: Interpolate tilting, pressure, etc. along the line
+              interpolated_dabs.push_back(Dab(dabs[j].pos.x + dist.x * factor,
+                                              dabs[j].pos.y + dist.y * factor,
+                                              dabs[j].pressure));
+              n += 1;
+            }
+
+          // calculate the space that wasn't used in the last iteration
+          overspace = (length + overspace) - (local_spacing * (n-1));
+        }
+      return interpolated_dabs;
+    }
+  else
+    {
+      // No dabs available, so nothing to interpolate
+      return impl->dabs;
+    }
+}
+
+Stroke::Dabs
 Stroke::get_dabs() const
 {
   return impl->dabs; 
@@ -178,4 +227,10 @@
   return impl->bounding_rect;
 }
 
+bool
+Stroke::empty() const
+{
+  return (impl->dabs.size() == 0);
+}
+
 /* EOF */

Modified: trunk/lib/stroke.hxx
===================================================================
--- trunk/lib/stroke.hxx	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/lib/stroke.hxx	2005-03-25 16:01:28 UTC (rev 501)
@@ -70,13 +70,23 @@
   
   Stroke();
 
+  /** Return true if the Stroke doesn't contain any dabs */
+  bool empty() const;
+
   void draw(CL_GraphicContext* gc) const;
 
   void  set_drawer(const StrokeDrawer& drawer_);
   StrokeDrawer get_drawer();
   void  add_dab(const Dab& dab);
+  
+  /** Returns the real dabs as recieved by the InputDevice */
   Dabs  get_dabs()  const;
 
+  /** Returns interpolated dabs, meaning the holes in get_dabs() are
+      closed with interpolated dabs so that all dabs are equally
+      spread (ie. every dab is 'spacing' away from the next) */
+  Dabs  get_interpolated_dabs(float x_spacing, float y_spacing) const;
+
   int get_dab_count() const;
 
   CL_Rectf get_bounding_rect() const;

Modified: trunk/paint/animation.rb
===================================================================
--- trunk/paint/animation.rb	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/paint/animation.rb	2005-03-25 16:01:28 UTC (rev 501)
@@ -1,3 +1,21 @@
+class Image
+  # OnionSkinLayer.new(get_current_image().editormap.get_layer(0)).update()  
+  def add_onion_skin(onion_skin)
+    if not @onion_skin then
+      @editormap.add_layer(onion_skin.to_layer(), 0)
+      @onion_skin = onion_skin
+    else
+      puts "Already have onion skin!!"
+    end
+  end
+
+  def update_onion_skin()
+    if @onion_skin then
+      @onion_skin.update()
+    end
+  end
+end
+
 class Animation
   def initialize()
     @frames = [Image.new()]
@@ -7,13 +25,13 @@
   def next_frame()
     @current_frame = (@current_frame + 1) % @frames.length
     get_current_image().activate($gui.workspace)
-    # OnionSkinLayer.new(get_current_image().editormap.get_layer(0)).update()
+    get_current_image().update_onion_skin()
   end
 
   def previous_frame()
     @current_frame = (@current_frame - 1) % @frames.length
     get_current_image().activate($gui.workspace)
-    # OnionSkinLayer.new(get_current_image().editormap.get_layer(0)).update()
+    get_current_image().update_onion_skin()
   end
 
   def get_current_image()
@@ -35,15 +53,19 @@
       # Hack for Onion_Skin
       onion_skin = OnionSkinLayer.new(1024, 768)
       # onion_skin.to_layer().set_pos(CL_Pointf.new(-100, -100))
-      img.editormap.add_layer(onion_skin.to_layer(), 0)
+      img.add_onion_skin(onion_skin)
       
       if (@frames.length > 1) then
-        onion_skin.add_map(@frames[(@current_frame - 1)%@frames.length].editormap, 0.5)
+        onion_skin.add_map(@frames[(@current_frame - 1)%@frames.length].editormap, 
+                           CL_Color.new(255, 255, 255, 150))
       end
 
       if (@frames.length > 2) then
-        onion_skin.add_map(@frames[(@current_frame - 2)%@frames.length].editormap, 0.25)
+        onion_skin.add_map(@frames[(@current_frame - 2)%@frames.length].editormap, 
+                           CL_Color.new(255, 255, 255, 75))
       end      
+      
+      img.update_onion_skin()
     end
   end
 end

Modified: trunk/paint/gui.rb
===================================================================
--- trunk/paint/gui.rb	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/paint/gui.rb	2005-03-25 16:01:28 UTC (rev 501)
@@ -12,7 +12,7 @@
     # @workspace.set_tool($layer_move_tool.to_tool());
 
     @selector_window_main = Window.new(CL_Rect.new(CL_Point.new($screen_rect.get_width()-160, 5), 
-                                                   CL_Size.new(128 + 6 + 10, 558)),
+                                                   CL_Size.new(128 + 6 + 10, 658)),
                                        "ColorPicker",
                                        @gui.get_component())
     @selector_window = @selector_window_main.get_client_area()
@@ -21,7 +21,7 @@
                                    @selector_window)
 
     connect_v1_Color(@colorpicker.sig_color_change(), proc{|color|
-                       $sketch_stroke_tool.set_color(color)
+                       DrawerProperties.current().set_color(color)
                      })
 
     @bgcolorpicker = ColorPicker.new(CL_Rect.new(CL_Point.new(3, 300), CL_Size.new(128, 128)),
@@ -36,7 +36,7 @@
     @size_slider.set_value(1.0)
     connect_v1_float(@size_slider.sig_on_change, proc{|value|
                        # puts "Value: #{value}"
-                       $sketch_stroke_tool.set_size(value)
+                       DrawerProperties.current().set_size(value)
                      })
 
     @brush_hardness = Slider.new(CL_Rect.new(CL_Point.new(3, 170), CL_Size.new(128, 16)),
@@ -44,8 +44,7 @@
     @brush_hardness.set_range(0.0, 1.0)
     @brush_hardness.set_value(0.75)
     connect_v1_float(@brush_hardness.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_hardness(value)
+                       GeneratedBrush.new(DrawerProperties.current().get_brush()).set_hardness(value)
                      })
 
     @brush_spikes = Slider.new(CL_Rect.new(CL_Point.new(3, 190), CL_Size.new(128, 16)),
@@ -53,8 +52,7 @@
     @brush_spikes.set_range(2, 20)
     @brush_spikes.set_value(2)
     connect_v1_float(@brush_spikes.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_spikes(value.to_i)
+                       GeneratedBrush.new(DrawerProperties.current().get_brush()).set_spikes(value.to_i)
                      })
 
     @brush_aspects = Slider.new(CL_Rect.new(CL_Point.new(3, 210), CL_Size.new(128, 16)),
@@ -62,8 +60,7 @@
     @brush_aspects.set_range(0.1, 10)
     @brush_aspects.set_value(1)
     connect_v1_float(@brush_aspects.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_aspect_ratio(value)
+                       GeneratedBrush.new(DrawerProperties.current().get_brush()).set_aspect_ratio(value)
                      })
 
     @brush_angles = Slider.new(CL_Rect.new(CL_Point.new(3, 230), CL_Size.new(128, 16)),
@@ -71,8 +68,7 @@
     @brush_angles.set_range(0, 360)
     @brush_angles.set_value(0)
     connect_v1_float(@brush_angles.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_angle(value)
+                       GeneratedBrush.new(DrawerProperties.current().get_brush()).set_angle(value)
                      })
 
     @brush_shape_circle  = CL_Button.new(CL_Rect.new(CL_Point.new(5, 250), CL_Size.new(40, 25)), "Circ", @selector_window)
@@ -80,16 +76,14 @@
     @brush_shape_diamond = CL_Button.new(CL_Rect.new(CL_Point.new(85, 250), CL_Size.new(40, 25)), "Diam", @selector_window)
 
     connect(@brush_shape_circle.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_CIRCLE)
+              GeneratedBrush.new(DrawerProperties.current().get_brush()).set_shape(BRUSH_SHAPE_CIRCLE)
             })
     connect(@brush_shape_rect.sig_clicked(), proc{ 
               drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_SQUARE)
+              GeneratedBrush.new(DrawerProperties.current().get_brush()).set_shape(BRUSH_SHAPE_SQUARE)
             })
     connect(@brush_shape_diamond.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_DIAMOND)
+              GeneratedBrush.new(DrawerProperties.current().get_brush()).set_shape(BRUSH_SHAPE_DIAMOND)
             })
 
 #    @zoom_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 182), CL_Size.new(128, 16)), @selector_window)
@@ -123,7 +117,8 @@
     @normal_mode = CL_Button.new(CL_Rect.new(CL_Point.new(5, 500), CL_Size.new(40, 25)), "Norm", @selector_window)
     @erase_mode  = CL_Button.new(CL_Rect.new(CL_Point.new(45, 500), CL_Size.new(40, 25)), "Erase", @selector_window)
     @add_mode    = CL_Button.new(CL_Rect.new(CL_Point.new(85, 500), CL_Size.new(40, 25)), "Add", @selector_window)
-    @shader_mode = CL_Button.new(CL_Rect.new(CL_Point.new(125, 500), CL_Size.new(40, 25)), "Shad", @selector_window)
+    @shader_mode = CL_Button.new(CL_Rect.new(CL_Point.new(5, 525), CL_Size.new(40, 25)), "Shad", @selector_window)
+    @smudge_mode = CL_Button.new(CL_Rect.new(CL_Point.new(45, 525), CL_Size.new(40, 25)), "Smudge", @selector_window)
 
     connect(@normal_mode.sig_clicked(), proc{ 
               drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
@@ -141,6 +136,10 @@
               drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
               drawer.set_mode(SpriteStrokeDrawer::DM_SHADER)
             })
+    connect(@smudge_mode.sig_clicked(),    proc{
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              drawer.set_mode(SpriteStrokeDrawer::DM_SMUDGE)
+            })
 
     button_panel = ButtonPanel.new(0, 0, 33, 33*3, false, @gui.get_component)
     button_panel.add_icon("../data/images/tools/stock-tool-pencil-22.png", proc{ 
@@ -153,23 +152,23 @@
                             @workspace.set_tool($layer_move_tool.to_tool())
                           })
 
-    anim_panel = ButtonPanel.new($screen_rect.get_width()/2 - (32*10)/2-16-32, 0, 32*11+1+16, 33,
+    anim_panel = ButtonPanel.new($screen_rect.get_width()/2 - (32*3)/2-16-32, 0, 32*3+1+16, 33,
                                  true, @gui.get_component)
     anim_panel.add_icon("../data/images/icons24/stock_new.png",
                         proc{ $animation.add_frame() })
     anim_panel.add_seperator()
-    anim_panel.add_icon("../data/images/icons24/anim_skipbackward.png")
-    anim_panel.add_icon("../data/images/icons24/anim_fastbackward.png")
-    anim_panel.add_icon("../data/images/icons24/anim_playbackward.png")
-    anim_panel.add_icon("../data/images/icons24/anim_slowmotionbackward.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_skipbackward.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_fastbackward.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_playbackward.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_slowmotionbackward.png")
     anim_panel.add_icon("../data/images/icons24/anim_previous.png",
                         proc{ $animation.previous_frame()})
     anim_panel.add_icon("../data/images/icons24/anim_next.png",
                         proc{ $animation.next_frame()})
-    anim_panel.add_icon("../data/images/icons24/anim_slowmotion.png")
-    anim_panel.add_icon("../data/images/icons24/anim_play.png")
-    anim_panel.add_icon("../data/images/icons24/anim_fastforward.png")
-    anim_panel.add_icon("../data/images/icons24/anim_skipforward.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_slowmotion.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_play.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_fastforward.png")
+    #anim_panel.add_icon("../data/images/icons24/anim_skipforward.png")
   end
 
   def quit()

Modified: trunk/paint/paint.rb
===================================================================
--- trunk/paint/paint.rb	2005-03-20 02:09:45 UTC (rev 500)
+++ trunk/paint/paint.rb	2005-03-25 16:01:28 UTC (rev 501)
@@ -38,7 +38,7 @@
 $layer_move_tool     = LayerMoveTool.new()
 $zoom_tool           = ZoomTool.new()
 
-$sketch_stroke_tool.set_color(CL_Color.new(0, 0, 0, 50))
+DrawerProperties.current().set_color(CL_Color.new(0, 0, 0, 50))
 
 $gui   = PaintGUI.new()
 
@@ -48,15 +48,15 @@
 $image.activate($gui.workspace)
 
 drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-if false then
-  drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
+if true then
+  DrawerProperties.current().set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
                                       32,  # radius
                                       2,   # spikes
                                       0.75, # hardness
                                       1.0, # aspect
                                       0).to_brush()) # angle
 else
-  drawer.set_brush(SpriteBrush.new(make_sprite("../data/images/brush/brush8.png")).to_brush)
+  DrawerProperties.current().set_brush(SpriteBrush.new(make_sprite("../data/images/brush/brush8.png")).to_brush)
 end
 
 $image.layers_count.times {|i|



From grumbel at sheep.berlios.de  Fri Mar 25 17:57:05 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Fri, 25 Mar 2005 17:57:05 +0100
Subject: [Flexlay-commit] r502 - in trunk: lib paint
Message-ID: <200503251657.j2PGv5ZG003959@sheep.berlios.de>

Author: grumbel
Date: 2005-03-25 17:57:04 +0100 (Fri, 25 Mar 2005)
New Revision: 502

Modified:
   trunk/lib/sprite_stroke_drawer.cxx
   trunk/paint/gui.rb
   trunk/paint/image.rb
Log:
- some refactoring
- some little fixes to the smudge tool

Modified: trunk/lib/sprite_stroke_drawer.cxx
===================================================================
--- trunk/lib/sprite_stroke_drawer.cxx	2005-03-25 16:01:28 UTC (rev 501)
+++ trunk/lib/sprite_stroke_drawer.cxx	2005-03-25 16:57:04 UTC (rev 502)
@@ -41,7 +41,6 @@
   SpriteStrokeDrawerImpl() {}
 
   void draw(const Stroke& stroke, CL_GraphicContext* gc);
-  void draw_dab(const Dab& dab, CL_GraphicContext* gc);
 
   StrokeDrawerImpl* clone() const;
 };
@@ -60,215 +59,205 @@
 }
 
 void
-SpriteStrokeDrawerImpl::draw_dab(const Dab& dab, CL_GraphicContext* gc)
+SpriteStrokeDrawerImpl::draw(const Stroke& stroke, CL_GraphicContext* gc)
 {
-  CL_Sprite sprite = DrawerProperties::current()->get_brush().get_sprite();
+  if (DrawerProperties::current()->get_brush().is_null() || stroke.get_dab_count() == 0)
+    return;
+  
+  Stroke::Dabs dabs = stroke.get_interpolated_dabs(DrawerProperties::current()->get_spacing()
+                                                   * DrawerProperties::current()->get_size(),
+                                                   DrawerProperties::current()->get_spacing()
+                                                   * DrawerProperties::current()->get_size());
 
-  CL_Color color = DrawerProperties::current()->get_color();
-  sprite.set_color(color);
-  sprite.set_alpha((color.get_alpha()/255.0f) * dab.pressure);
-  sprite.set_scale(DrawerProperties::current()->get_size() * dab.pressure,
-                   DrawerProperties::current()->get_size() * dab.pressure);
-
-  if (gc != 0)
+  for(Stroke::Dabs::iterator i = dabs.begin(); i != dabs.end(); ++i)
     {
-      /* Correct function:
-         1: dest
-         2: src
+      Dab& dab = *i;
+
+      CL_Sprite sprite = DrawerProperties::current()->get_brush().get_sprite();
+
+      CL_Color color = DrawerProperties::current()->get_color();
+      sprite.set_color(color);
+      sprite.set_alpha((color.get_alpha()/255.0f) * dab.pressure);
+      sprite.set_scale(DrawerProperties::current()->get_size() * dab.pressure,
+                       DrawerProperties::current()->get_size() * dab.pressure);
+
+      if (gc != 0)
+        {
+          /* Correct function:
+             1: dest
+             2: src
              
-         R = R1 A1 (1 - A2) + R2 A2
-         G = G1 A1 (1 - A2) + G2 A2
-         B = B1 A1 (1 - A2) + B2 A2
-         A = A1 (1 - A2) + A2
+             R = R1 A1 (1 - A2) + R2 A2
+             G = G1 A1 (1 - A2) + G2 A2
+             B = B1 A1 (1 - A2) + B2 A2
+             A = A1 (1 - A2) + A2
 
-         // This is currently used, leads to premultiplied alpha
-         Aout  = Afgd + (1 - Afgd) * Abkg 
-         Cout' = Cfgd' + (1 - Afgd) * Cbkg' 
-         where
-         Cfgd' = Cfgd * Afgd
-         Cbkg' = Cbkg * Abkg
-         Cout' = Cout * Aout
+             // This is currently used, leads to premultiplied alpha
+             Aout  = Afgd + (1 - Afgd) * Abkg 
+             Cout' = Cfgd' + (1 - Afgd) * Cbkg' 
+             where
+             Cfgd' = Cfgd * Afgd
+             Cbkg' = Cbkg * Abkg
+             Cout' = Cout * Aout
 
-         Aout = (1 - (1 - Afgd) * (1 - Abkg)) 
-         Cout = (Cfgd * Afgd) + (1 - Afgd * Cbkg * Abkg) / Aout 
-         where
-         Cfgd = red, green, blue of foreground
-         Cbkg = red, green, blue of background
-         Afgd = alpha of foreground
-         Abkg = alpha of background
-      */
+             Aout = (1 - (1 - Afgd) * (1 - Abkg)) 
+             Cout = (Cfgd * Afgd) + (1 - Afgd * Cbkg * Abkg) / Aout 
+             where
+             Cfgd = red, green, blue of foreground
+             Cbkg = red, green, blue of background
+             Afgd = alpha of foreground
+             Abkg = alpha of background
+          */
 
-      // DO Multipass:
-      // 1: GL_ZERO, GL_DST_ALPHA
-      // 2: GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA
-      /*brush.set_blend_func_separate(blend_zero, blend_dst_alpha,
-        blend_zero, blend_one);
-        brush.draw(dab.pos.x, dab.pos.y, gc);*/
+          // DO Multipass:
+          // 1: GL_ZERO, GL_DST_ALPHA
+          // 2: GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA
+          /*brush.set_blend_func_separate(blend_zero, blend_dst_alpha,
+            blend_zero, blend_one);
+            brush.draw(dab.pos.x, dab.pos.y, gc);*/
           
-      switch (mode)
-        {
-        case SpriteStrokeDrawer::DM_NORMAL:
-          sprite.set_blend_func_separate(blend_src_alpha, blend_one_minus_src_alpha,
-                                         blend_one, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);
-          break;
+          switch (mode)
+            {
+            case SpriteStrokeDrawer::DM_NORMAL:
+              sprite.set_blend_func_separate(blend_src_alpha, blend_one_minus_src_alpha,
+                                             blend_one, blend_one_minus_src_alpha);
+              sprite.draw(dab.pos.x, dab.pos.y, gc);
+              break;
 
-        case SpriteStrokeDrawer::DM_ADDITION:
-          sprite.set_blend_func_separate(blend_src_alpha, blend_one,
-                                         blend_zero, blend_one);
-          //blend_one, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);
-          break;
+            case SpriteStrokeDrawer::DM_ADDITION:
+              sprite.set_blend_func_separate(blend_src_alpha, blend_one,
+                                             blend_zero, blend_one);
+              //blend_one, blend_one_minus_src_alpha);
+              sprite.draw(dab.pos.x, dab.pos.y, gc);
+              break;
               
-        case SpriteStrokeDrawer::DM_ERASE:
-          sprite.set_blend_func(blend_zero, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);
-          break;
+            case SpriteStrokeDrawer::DM_ERASE:
+              sprite.set_blend_func(blend_zero, blend_one_minus_src_alpha);
+              sprite.draw(dab.pos.x, dab.pos.y, gc);
+              break;
           
-        case SpriteStrokeDrawer::DM_SMUDGE:
-          {
-            // FIXME: These need to get reset on a new stroke
-            static int last_pos_x = 0;
-            static int last_pos_y = 0;
-
-            if (last_pos_y != 0 || last_pos_x != 0)
+            case SpriteStrokeDrawer::DM_SMUDGE:
               {
-                CL_Canvas* canvas = BitmapLayer::current()->get_canvas();
-                CL_PixelBuffer buffer = canvas->get_pixeldata(CL_Rect(CL_Point(last_pos_x - sprite.get_width()/2,
-                                                                               last_pos_y - sprite.get_height()/2),
-                                                                      CL_Size(sprite.get_width(), sprite.get_height())));
-                CL_Surface surface(buffer);
-                //surface.set_blend_func_separate(blend_src_alpha, blend_one_minus_src_alpha,
-                //                                blend_one, blend_zero);
-                //surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
-                surface.set_alignment(origin_center);
-                surface.set_alpha(0.8);
-                surface.draw(dab.pos.x, dab.pos.y, gc);
+                if (i != dabs.begin())
+                  {
+                    CL_Canvas* canvas = BitmapLayer::current()->get_canvas();
+                    CL_PixelBuffer buffer = canvas->get_pixeldata(CL_Rect(CL_Point(static_cast<int>((i-1)->pos.x) - sprite.get_width()/2,
+                                                                                   static_cast<int>((i-1)->pos.y) - sprite.get_height()/2),
+                                                                          CL_Size(sprite.get_width(), sprite.get_height())));
+                    CL_Surface surface(buffer);
+                    //surface.set_blend_func_separate(blend_src_alpha, blend_one_minus_src_alpha,
+                    //                                blend_one, blend_zero);
+                    surface.set_alignment(origin_center);
+                    surface.set_alpha(0.8);
+                    //surface.set_scale(DrawerProperties::current()->get_size(),
+                    //                 DrawerProperties::current()->get_size());
+                    surface.draw(dab.pos.x, dab.pos.y, gc);
+                  }
               }
+              break;
 
-            last_pos_x = static_cast<int>(dab.pos.x);
-            last_pos_y = static_cast<int>(dab.pos.y);
-          }
-          break;
-
-        case SpriteStrokeDrawer::DM_SHADER:
-          {
+            case SpriteStrokeDrawer::DM_SHADER:
+              {
 #if 0 
-            CL_OpenGLState state(gc);
-            state.set_active();
-            state.setup_2d();
+                CL_OpenGLState state(gc);
+                state.set_active();
+                state.setup_2d();
 
-            if (program == 0)
-              {
-                program = new CL_ProgramObject();
+                if (program == 0)
+                  {
+                    program = new CL_ProgramObject();
                 
-                CL_ShaderObject shader("shader", &(Flexlay::current()->resources));
-                std::cout << "Shader status: " << (shader.get_compile_status() ? "true" : "false") << std::endl;
-                std::cout << "Shader log: " << shader.get_info_log() << std::endl;
-                std::cout << "Shader handle: " << shader.get_handle() << std::endl;
+                    CL_ShaderObject shader("shader", &(Flexlay::current()->resources));
+                    std::cout << "Shader status: " << (shader.get_compile_status() ? "true" : "false") << std::endl;
+                    std::cout << "Shader log: " << shader.get_info_log() << std::endl;
+                    std::cout << "Shader handle: " << shader.get_handle() << std::endl;
 
-                program->attach(shader);
-                program->link();
-                std::cout << "Program status: " << (program->get_link_status() ? "true" : "false") << std::endl;
-                std::cout << "Program log: " << program->get_info_log() << std::endl;
-                std::cout << "Program handle: " << program->get_handle() << std::endl;
+                    program->attach(shader);
+                    program->link();
+                    std::cout << "Program status: " << (program->get_link_status() ? "true" : "false") << std::endl;
+                    std::cout << "Program log: " << program->get_info_log() << std::endl;
+                    std::cout << "Program handle: " << program->get_handle() << std::endl;
 
-                clUseProgram(program->get_handle());
-              }
-            else
-              {
-                clUseProgram(program->get_handle());
-              }
+                    clUseProgram(program->get_handle());
+                  }
+                else
+                  {
+                    clUseProgram(program->get_handle());
+                  }
             
-            CL_OpenGLSurface glsurface(sprite.get_frame_surface(0));
-            glActiveTexture(GL_TEXTURE0);
-            glsurface.bind();
-            glEnable(GL_TEXTURE_2D);
+                CL_OpenGLSurface glsurface(sprite.get_frame_surface(0));
+                glActiveTexture(GL_TEXTURE0);
+                glsurface.bind();
+                glEnable(GL_TEXTURE_2D);
 
-            /*CL_OpenGLSurface glsurface2(SketchLayer::current()->get_background_surface());
-              glActiveTexture(GL_TEXTURE1);
-              glsurface2.bind();
-              glEnable(GL_TEXTURE_2D);*/
+                /*CL_OpenGLSurface glsurface2(SketchLayer::current()->get_background_surface());
+                  glActiveTexture(GL_TEXTURE1);
+                  glsurface2.bind();
+                  glEnable(GL_TEXTURE_2D);*/
             
-            clUniform1i(program->get_attribute_location("mytex"), 0);
-            //clUniform1i(program->get_attribute_location("background"), 1);
-            //program->validate();
-            //std::cout << "Program validate status: " << (program->get_validate_status() ? "true" : "false") << std::endl;
-            //std::cout << "Program log: " << program->get_info_log() << std::endl;
+                clUniform1i(program->get_attribute_location("mytex"), 0);
+                //clUniform1i(program->get_attribute_location("background"), 1);
+                //program->validate();
+                //std::cout << "Program validate status: " << (program->get_validate_status() ? "true" : "false") << std::endl;
+                //std::cout << "Program log: " << program->get_info_log() << std::endl;
 
-            clBegin(CL_QUADS);
-            clColor4b(color.get_red(), color.get_green(), color.get_blue(), color.get_alpha());
-            float size = base_size * dab.pressure;
-            clVertex2f((dab.pos.x - sprite.get_width()/2) * size, (dab.pos.y - sprite.get_height()/2) * size);
-            clTexCoord2d(0.0, 0.0);
-            clVertex2f((dab.pos.x + sprite.get_width()/2) * size, (dab.pos.y - sprite.get_height()/2) * size);
-            clTexCoord2d(1.0, 0.0);
-            clVertex2f((dab.pos.x + sprite.get_width()/2) * size, (dab.pos.y + sprite.get_height()/2) * size);
-            clTexCoord2d(1.0, 1.0);
-            clVertex2f((dab.pos.x - sprite.get_width()/2) * size, (dab.pos.y + sprite.get_height()/2) * size);
-            clTexCoord2d(0.0, 1.0);
-            clEnd();
+                clBegin(CL_QUADS);
+                clColor4b(color.get_red(), color.get_green(), color.get_blue(), color.get_alpha());
+                float size = base_size * dab.pressure;
+                clVertex2f((dab.pos.x - sprite.get_width()/2) * size, (dab.pos.y - sprite.get_height()/2) * size);
+                clTexCoord2d(0.0, 0.0);
+                clVertex2f((dab.pos.x + sprite.get_width()/2) * size, (dab.pos.y - sprite.get_height()/2) * size);
+                clTexCoord2d(1.0, 0.0);
+                clVertex2f((dab.pos.x + sprite.get_width()/2) * size, (dab.pos.y + sprite.get_height()/2) * size);
+                clTexCoord2d(1.0, 1.0);
+                clVertex2f((dab.pos.x - sprite.get_width()/2) * size, (dab.pos.y + sprite.get_height()/2) * size);
+                clTexCoord2d(0.0, 1.0);
+                clEnd();
             
-            state.set_active();
-            clUseProgram(0);
+                state.set_active();
+                clUseProgram(0);
 #endif
-          }
-          break;
+              }
+              break;
               
-        default:
-          std::cout << "Error: SpriteStrokeDrawer: Unknown draw mode: " << mode << std::endl;
-          break;
+            default:
+              std::cout << "Error: SpriteStrokeDrawer: Unknown draw mode: " << mode << std::endl;
+              break;
+            }
         }
-    }
-  else
-    {
-      switch (mode)
+      else
         {
-        case SpriteStrokeDrawer::DM_NORMAL:  
-          sprite.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);
-          break;
+          switch (mode)
+            {
+            case SpriteStrokeDrawer::DM_NORMAL:  
+              sprite.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
+              sprite.draw(dab.pos.x, dab.pos.y, gc);
+              break;
               
-        case SpriteStrokeDrawer::DM_ADDITION:
-          sprite.set_blend_func(blend_src_alpha, blend_one);
-          sprite.draw(dab.pos.x, dab.pos.y, gc); 
-          break;
+            case SpriteStrokeDrawer::DM_ADDITION:
+              sprite.set_blend_func(blend_src_alpha, blend_one);
+              sprite.draw(dab.pos.x, dab.pos.y, gc); 
+              break;
             
-        case SpriteStrokeDrawer::DM_ERASE:
-          sprite.set_blend_func(blend_zero, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);
-          break; 
+            case SpriteStrokeDrawer::DM_ERASE:
+              sprite.set_blend_func(blend_zero, blend_one_minus_src_alpha);
+              sprite.draw(dab.pos.x, dab.pos.y, gc);
+              break; 
           
-        case SpriteStrokeDrawer::DM_SMUDGE:
-          sprite.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
-          sprite.draw(dab.pos.x, dab.pos.y, gc);          
-          break;
+            case SpriteStrokeDrawer::DM_SMUDGE:
+              sprite.set_blend_func(blend_src_alpha, blend_one_minus_src_alpha);
+              sprite.draw(dab.pos.x, dab.pos.y, gc);          
+              break;
 
-        default:
-          std::cout << "Error: SpriteStrokeDrawer: Unknown draw mode: " << mode << std::endl;
-          break;
+            default:
+              std::cout << "Error: SpriteStrokeDrawer: Unknown draw mode: " << mode << std::endl;
+              break;
+            }
         }
     }
 }
 
 void
-SpriteStrokeDrawerImpl::draw(const Stroke& stroke, CL_GraphicContext* gc)
-{
-  if (DrawerProperties::current()->get_brush().is_null() || stroke.get_dab_count() == 0)
-    return;
-  
-  Stroke::Dabs dabs = stroke.get_interpolated_dabs(DrawerProperties::current()->get_spacing()
-                                                   * DrawerProperties::current()->get_size(),
-                                                   DrawerProperties::current()->get_spacing()
-                                                   * DrawerProperties::current()->get_size());
-
-  for(Stroke::Dabs::iterator i = dabs.begin(); i != dabs.end(); ++i)
-    {
-      draw_dab(*i, gc);
-    }
-}
-
-void
 SpriteStrokeDrawer::set_mode(DrawMode mode)
 {
   impl->mode = mode;

Modified: trunk/paint/gui.rb
===================================================================
--- trunk/paint/gui.rb	2005-03-25 16:01:28 UTC (rev 501)
+++ trunk/paint/gui.rb	2005-03-25 16:57:04 UTC (rev 502)
@@ -71,6 +71,14 @@
                        GeneratedBrush.new(DrawerProperties.current().get_brush()).set_angle(value)
                      })
 
+    @spacing_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 600), CL_Size.new(128, 16)),
+                                 @selector_window)
+    @spacing_slider.set_range(1, 250)
+    @spacing_slider.set_value(20)
+    connect_v1_float(@spacing_slider.sig_on_change, proc{|value|
+                       DrawerProperties.current().set_spacing(value)
+                     })
+
     @brush_shape_circle  = CL_Button.new(CL_Rect.new(CL_Point.new(5, 250), CL_Size.new(40, 25)), "Circ", @selector_window)
     @brush_shape_rect    = CL_Button.new(CL_Rect.new(CL_Point.new(45, 250), CL_Size.new(40, 25)), "Squa", @selector_window)
     @brush_shape_diamond = CL_Button.new(CL_Rect.new(CL_Point.new(85, 250), CL_Size.new(40, 25)), "Diam", @selector_window)
@@ -79,7 +87,6 @@
               GeneratedBrush.new(DrawerProperties.current().get_brush()).set_shape(BRUSH_SHAPE_CIRCLE)
             })
     connect(@brush_shape_rect.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
               GeneratedBrush.new(DrawerProperties.current().get_brush()).set_shape(BRUSH_SHAPE_SQUARE)
             })
     connect(@brush_shape_diamond.sig_clicked(), proc{ 

Modified: trunk/paint/image.rb
===================================================================
--- trunk/paint/image.rb	2005-03-25 16:01:28 UTC (rev 501)
+++ trunk/paint/image.rb	2005-03-25 16:57:04 UTC (rev 502)
@@ -88,12 +88,12 @@
 
     sprite_drawer = SpriteStrokeDrawer.new()
     # FIXME: insert loader for brush here
-    sprite_drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
-                                               32,  # radius
-                                               2,   # spikes
-                                               0.75, # hardness
-                                               1.0, # aspect
-                                               0).to_brush()) # angle
+    DrawerProperties.current().set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
+                                                            32,  # radius
+                                                            2,   # spikes
+                                                            0.75, # hardness
+                                                            1.0, # aspect
+                                                            0).to_brush()) # angle
     
     sprite_drawer.set_color(CL_Color.new(0, 0, 0, 155))
     sprite_drawer.set_size(1.0)



From grumbel at sheep.berlios.de  Sun Mar 27 01:59:19 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Sun, 27 Mar 2005 01:59:19 +0100
Subject: [Flexlay-commit] r503 - in trunk: lib paint
Message-ID: <200503270059.j2R0xJ4B010705@sheep.berlios.de>

Author: grumbel
Date: 2005-03-27 01:58:57 +0100 (Sun, 27 Mar 2005)
New Revision: 503

Modified:
   trunk/lib/SConstruct
   trunk/lib/bitmap_layer.cxx
   trunk/lib/bitmap_layer.hxx
   trunk/lib/clanlib.i
   trunk/lib/flexlay_wrap.i
   trunk/lib/marker_stroke_drawer.cxx
   trunk/lib/marker_stroke_drawer.hxx
   trunk/lib/sketch_stroke_tool.cxx
   trunk/lib/sprite_stroke_drawer.cxx
   trunk/paint/gui.rb
   trunk/paint/image.rb
   trunk/paint/paint.rb
Log:
- fixed MarkerDrawer to be usable again, still same old overdraw problem

Modified: trunk/lib/SConstruct
===================================================================
--- trunk/lib/SConstruct	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/SConstruct	2005-03-27 00:58:57 UTC (rev 503)
@@ -105,7 +105,7 @@
     'stroke_drawer.cxx',
     'sprite_stroke_drawer.cxx',
     'sprite_brush.cxx',
-#    'marker_stroke_drawer.cxx',
+    'marker_stroke_drawer.cxx',
     'slider.cxx', 
     'scrollbar.cxx',
     'tile.cxx',

Modified: trunk/lib/bitmap_layer.cxx
===================================================================
--- trunk/lib/bitmap_layer.cxx	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/bitmap_layer.cxx	2005-03-27 00:58:57 UTC (rev 503)
@@ -34,11 +34,12 @@
 #include "workspace.hxx"
 #include "layer_impl.hxx"
 #include "bitmap_layer.hxx"
+#include "objmap_object_impl.hxx"
 #include "math.hxx"
 
 BitmapLayer* BitmapLayer::current_ = 0;
 
-class BitmapLayerImpl : public LayerImpl
+class BitmapLayerImpl : public ObjMapObjectImpl
 {
 public:
   typedef std::vector<Stroke> Strokes;
@@ -57,8 +58,6 @@
   {
     try {
       canvas = new CL_Canvas(surface);
-      canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
-      canvas->get_gc()->flush();
       canvas->sync_surface();
     } catch(CL_Error& err) {
       std::cout << "CL_Error: " << err.message << std::endl;
@@ -66,6 +65,19 @@
     }
   }
   
+  BitmapLayerImpl(CL_PixelBuffer buffer)
+    : surface(buffer),
+      canvas(0)
+  {
+    try {
+      canvas = new CL_Canvas(surface);
+      canvas->sync_surface();
+    } catch(CL_Error& err) {
+      std::cout << "CL_Error: " << err.message << std::endl;
+      throw err;
+    }
+  }
+
   BitmapLayerImpl(int width, int height) 
     : surface(CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888)),
       canvas(0)
@@ -85,7 +97,7 @@
     delete canvas;
   }
 
-  void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
+  void draw(CL_GraphicContext* gc)
   {
     assert(canvas);
 
@@ -94,12 +106,16 @@
       return;
 
     surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
-    surface.draw(0, 0, gc);
+    surface.draw(pos.x, pos.y, gc);
 
-    if (BitmapLayer::current()->impl.get() == this)
-      gc->draw_rect(get_bounding_rect(), CL_Color(155, 155, 155, 100));
+    gc->draw_rect(get_bounding_rect(), CL_Color(155, 155, 155, 100));
   }
 
+  CL_Rectf get_bound_rect() const  
+  {
+    return CL_Rectf(CL_Pointf(ObjMapObjectImpl::pos), CL_Sizef(surface.get_width(), surface.get_height()));
+  }
+
   CL_Rect get_bounding_rect() { 
     // FIXME: Do we need to handle its position here or does the Layer keep care of that?
     return CL_Rect(CL_Point(0, 0),
@@ -123,6 +139,12 @@
   current_ = this;
 }
 
+BitmapLayer::BitmapLayer(CL_PixelBuffer buffer)
+  : impl(new BitmapLayerImpl(buffer))
+{
+  current_ = this;
+}
+
 void
 BitmapLayer::add_stroke(const Stroke& stroke)
 {
@@ -136,12 +158,6 @@
     }
 }
 
-Layer
-BitmapLayer::to_layer()
-{
-   return Layer(impl);
-}
-
 std::vector<Stroke>
 BitmapLayer::get_strokes()
 {
@@ -160,11 +176,25 @@
   return impl->canvas;
 }
 
+void
+BitmapLayer::set_pixeldata(CL_PixelBuffer buffer)
+{
+  //impl->canvas->set_pixeldata(buffer);
+  CL_Surface(buffer).draw(0, 0, impl->canvas->get_gc());
+  impl->canvas->get_gc()->flush();
+  impl->canvas->sync_surface();
+}
+
 CL_PixelBuffer
 BitmapLayer::get_pixeldata() const
 {
-  assert(0); // FIME: implemnet me
-  return CL_PixelBuffer();
+  return impl->canvas->get_pixeldata();
 }
 
+ObjMapObject
+BitmapLayer::to_object()
+{
+  return ObjMapObject(impl);
+}
+
 /* EOF */

Modified: trunk/lib/bitmap_layer.hxx
===================================================================
--- trunk/lib/bitmap_layer.hxx	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/bitmap_layer.hxx	2005-03-27 00:58:57 UTC (rev 503)
@@ -23,6 +23,7 @@
 #include <vector>
 #include <ClanLib/Core/Math/point.h>
 #include <ClanLib/Display/color.h>
+#include "objmap_object.hxx"
 #include "layer.hxx"
 #include "stroke.hxx"
 
@@ -31,7 +32,7 @@
 /** This layer holds a simple bitmap, size and color format are
     configurable, it works similar to the SketchLayer, however it
     doesn't rerender the image all the time, but simply holds it in a
-    CL_Canvas */
+    CL_Canvas making it a whole lot faster. */
 class BitmapLayer
 {
   friend class BitmapLayerImpl;
@@ -42,6 +43,7 @@
   static void set_current(BitmapLayer* c) { current_ = c; }
 
   BitmapLayer(CL_Surface surface);
+  BitmapLayer(CL_PixelBuffer buffer);
   BitmapLayer(int width, int height);
   
   void add_stroke(const Stroke&);
@@ -50,11 +52,12 @@
 
   CL_Surface get_background_surface();
 
+  void set_pixeldata(CL_PixelBuffer buffer);
   CL_PixelBuffer get_pixeldata() const;
   CL_Canvas*     get_canvas() const;
   
   bool is_null() const { return !impl.get(); }
-  Layer to_layer();
+  ObjMapObject to_object();
 
 private:
   SharedPtr<BitmapLayerImpl> impl;

Modified: trunk/lib/clanlib.i
===================================================================
--- trunk/lib/clanlib.i	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/clanlib.i	2005-03-27 00:58:57 UTC (rev 503)
@@ -237,5 +237,20 @@
 	void set_checked(bool check = true);
 };
 
+class CL_ProviderFactory
+{
+public:
+	static CL_PixelBuffer load(
+		const std::string &filename,
+		const std::string &type = "",
+		CL_InputSourceProvider *input_provider = 0);
+
+	static void save(
+		CL_PixelBuffer buffer,
+		const std::string &filename,
+		const std::string &type = "",
+		CL_OutputSourceProvider *output_provider = 0);
+};
+
 /* EOF */
 

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/flexlay_wrap.i	2005-03-27 00:58:57 UTC (rev 503)
@@ -16,6 +16,7 @@
  
 %{
 #include <ClanLib/Display/color.h>
+#include <ClanLib/Display/Providers/provider_factory.h>
 #include <ClanLib/GUI/component.h>
 #include <ClanLib/GUI/button.h>
 #include <ClanLib/GUI/window.h>
@@ -65,6 +66,7 @@
 #include "stroke_drawer.hxx"
 #include "drawer_properties.hxx"
 #include "sprite_stroke_drawer.hxx"
+#include "marker_stroke_drawer.hxx"
 #include "brushmask.hxx"
 #include "brush.hxx"
 #include "generated_brush.hxx"
@@ -183,6 +185,7 @@
 %include "stroke_drawer.hxx"
 %include "drawer_properties.hxx"
 %include "sprite_stroke_drawer.hxx"
+%include "marker_stroke_drawer.hxx"
 %include "brushmask.hxx"
 %include "brush.hxx"
 %include "generated_brush.hxx"
@@ -215,4 +218,5 @@
 
 #endif
 
+
 /* EOF */

Modified: trunk/lib/marker_stroke_drawer.cxx
===================================================================
--- trunk/lib/marker_stroke_drawer.cxx	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/marker_stroke_drawer.cxx	2005-03-27 00:58:57 UTC (rev 503)
@@ -19,60 +19,118 @@
 
 #include <ClanLib/gl.h>
 #include <ClanLib/Display/display.h>
+#include "stroke_drawer_impl.hxx"
+#include "stroke.hxx"
+#include "drawer_properties.hxx"
 #include "marker_stroke_drawer.hxx"
 
-void
-MarkerStrokeDrawer::draw(const Stroke& stroke)
+class MarkerStrokeDrawerImpl : public StrokeDrawerImpl
 {
-  CL_OpenGLState state(CL_Display::get_current_window()->get_gc());
-  state.set_active();
-  state.setup_2d();
+public:
+  MarkerStrokeDrawerImpl() {}
 
-  if (stroke.points.size() >= 2)
-    {
-      float len  = stroke.get_size()*8.0f;
-      float len2 = stroke.get_size()*16.0f;
+  void draw(const Stroke& stroke, CL_GraphicContext* gc)
+  {
+    CL_OpenGLState state(CL_Display::get_current_window()->get_gc());
+    state.set_active();
+    state.setup_2d();
+
+    CL_Color color = DrawerProperties::current()->get_color();
+
+    const Stroke::Dabs& dabs = stroke.get_interpolated_dabs(DrawerProperties::current()->get_spacing(),
+                                                            DrawerProperties::current()->get_spacing());
+
+    if (dabs.size() >= 2)
+      {
+        std::vector<CL_Pointf> normals;
+        
+        if (stroke.get_dab_count() == 2)
+          {
+            normals.push_back(CL_Pointf(1.0f, 1.0f));
+            normals.push_back(CL_Pointf(1.0f, 1.0f));
+          }
+        else if (stroke.get_dab_count() >= 3)
+          {
+            for(Stroke::Dabs::size_type i = 0; i < dabs.size()-1; ++i)
+              {
+                CL_Pointf normal((dabs[i].pos.y - dabs[i+1].pos.y),
+                                 -(dabs[i].pos.x - dabs[i+1].pos.x));
+
+                float length = sqrt(normal.x * normal.x + normal.y * normal.y);
+
+                normal.x /= length;
+                normal.y /= length;
+          
+                normals.push_back(normal);
+              }
+      
+            normals.push_back(CL_Pointf(1.0f, 1.0f));
+          }
+
+        float len  = DrawerProperties::current()->get_size() * 8.0f;
+        float len2 = DrawerProperties::current()->get_size() * 16.0f;
             
-      glEnable(GL_BLEND);
-      glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
+        glEnable(GL_BLEND);
+        glBlendFunc( GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA );
 
-      glBegin(GL_QUAD_STRIP);
-      for(unsigned int j = 0; j < stroke.points.size()-2; ++j)
-        {
-          glColor4ub(stroke.color.get_red(), stroke.color.get_green(), stroke.color.get_blue(), stroke.color.get_alpha());
-          glVertex2f(stroke.points[j].x + stroke.normals[j].x * len,
-                     stroke.points[j].y + stroke.normals[j].y * len);
+        glBegin(GL_QUAD_STRIP);
+        for(unsigned int j = 0; j < dabs.size()-2; ++j)
+          {
+            glColor4ub(color.get_red(), color.get_green(), color.get_blue(), color.get_alpha());
+            glVertex2f(dabs[j].pos.x + normals[j].x * len,
+                       dabs[j].pos.y + normals[j].y * len);
 
-          glColor4ub(stroke.color.get_red(), stroke.color.get_green(), stroke.color.get_blue(), 0);
-          glVertex2f(stroke.points[j].x + stroke.normals[j].x * len2,
-                     stroke.points[j].y + stroke.normals[j].y * len2);
-        }
-      glEnd();
+            glColor4ub(color.get_red(), color.get_green(), color.get_blue(), 0);
+            glVertex2f(dabs[j].pos.x + normals[j].x * len2,
+                       dabs[j].pos.y + normals[j].y * len2);
+          }
+        glEnd();
 
-      glBegin(GL_QUAD_STRIP);
-      for(unsigned int j = 0; j < stroke.points.size()-2; ++j)
-        {
-          glColor4ub(stroke.color.get_red(), stroke.color.get_green(), stroke.color.get_blue(), 0);
-          glVertex2f(stroke.points[j].x - stroke.normals[j].x * len2,
-                     stroke.points[j].y - stroke.normals[j].y * len2);
+        glBegin(GL_QUAD_STRIP);
+        for(unsigned int j = 0; j < dabs.size()-2; ++j)
+          {
+            glColor4ub(color.get_red(), color.get_green(), color.get_blue(), 0);
+            glVertex2f(dabs[j].pos.x - normals[j].x * len2,
+                       dabs[j].pos.y - normals[j].y * len2);
 
-          glColor4ub(stroke.color.get_red(), stroke.color.get_green(), stroke.color.get_blue(), stroke.color.get_alpha());
-          glVertex2f(stroke.points[j].x - stroke.normals[j].x * len,
-                     stroke.points[j].y - stroke.normals[j].y * len);
-        }
-      glEnd();
+            glColor4ub(color.get_red(), color.get_green(), color.get_blue(), color.get_alpha());
+            glVertex2f(dabs[j].pos.x - normals[j].x * len,
+                       dabs[j].pos.y - normals[j].y * len);
+          }
+        glEnd();
 
-      glBegin(GL_QUAD_STRIP);
-      glColor4ub(stroke.color.get_red(), stroke.color.get_green(), stroke.color.get_blue(), stroke.color.get_alpha());
-      for(unsigned int j = 0; j < stroke.points.size()-2; ++j)
-        {
-          glVertex2f(stroke.points[j].x + stroke.normals[j].x * len,
-                     stroke.points[j].y + stroke.normals[j].y * len);
-          glVertex2f(stroke.points[j].x - stroke.normals[j].x * len,
-                     stroke.points[j].y - stroke.normals[j].y * len);
-        }
-      glEnd();
-    }
+        glBegin(GL_QUAD_STRIP);
+        glColor4ub(color.get_red(), color.get_green(), color.get_blue(), color.get_alpha());
+        for(unsigned int j = 0; j < dabs.size()-2; ++j)
+          {
+            glVertex2f(dabs[j].pos.x + normals[j].x * len,
+                       dabs[j].pos.y + normals[j].y * len);
+            glVertex2f(dabs[j].pos.x - normals[j].x * len,
+                       dabs[j].pos.y - normals[j].y * len);
+          }
+        glEnd();
+      }
+  }
+
+  StrokeDrawerImpl* clone() const 
+  {
+    MarkerStrokeDrawerImpl* drawer = new MarkerStrokeDrawerImpl();
+  
+    *drawer = *this;
+    
+    return drawer;
+  }
+};
+
+MarkerStrokeDrawer::MarkerStrokeDrawer()
+  : impl(new MarkerStrokeDrawerImpl())
+{
 }
 
+StrokeDrawer
+MarkerStrokeDrawer::to_drawer()
+{
+  return StrokeDrawer(impl);
+}
+
 /* EOF */

Modified: trunk/lib/marker_stroke_drawer.hxx
===================================================================
--- trunk/lib/marker_stroke_drawer.hxx	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/marker_stroke_drawer.hxx	2005-03-27 00:58:57 UTC (rev 503)
@@ -20,6 +20,10 @@
 #ifndef HEADER_MARKER_STROKE_DRAWER_HXX
 #define HEADER_MARKER_STROKE_DRAWER_HXX
 
+#include "stroke_drawer.hxx"
+
+class MarkerStrokeDrawerImpl;
+
 /** */
 class MarkerStrokeDrawer
 {
@@ -27,7 +31,10 @@
 public:
   MarkerStrokeDrawer();
   
-  void draw(const Stroke& stroke);
+  StrokeDrawer to_drawer();
+
+private:
+  SharedPtr<MarkerStrokeDrawerImpl> impl;
 };
 
 #endif

Modified: trunk/lib/sketch_stroke_tool.cxx
===================================================================
--- trunk/lib/sketch_stroke_tool.cxx	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/sketch_stroke_tool.cxx	2005-03-27 00:58:57 UTC (rev 503)
@@ -30,6 +30,7 @@
 #include "bitmap_layer.hxx"
 #include "sketch_stroke_tool.hxx"
 #include "sprite_stroke_drawer.hxx"
+#include "marker_stroke_drawer.hxx"
 #include "stroke.hxx"
 #include "stroke_drawer.hxx"
 #include "drawer_properties.hxx"
@@ -40,13 +41,13 @@
 public:
   bool drawing;
   Stroke   stroke;
-  SpriteStrokeDrawer sprite_drawer;
-
+  StrokeDrawer   drawer;
+  
   SketchStrokeToolImpl()
     : drawing(false)
   {
-    sprite_drawer.set_mode(SpriteStrokeDrawer::DM_NORMAL);
-    //sprite_drawer.set_sprite(CL_Sprite("brush", &(Flexlay::current()->resources)));
+    drawer = SpriteStrokeDrawer().to_drawer();
+    //drawer = MarkerStrokeDrawer().to_drawer();
   }
 
   void draw() 
@@ -55,8 +56,8 @@
       {
         // FIXME: This translation is a bit ugly, layer position should be handled somewhat different
         CL_Display::push_modelview();
-        CL_Display::add_translate(BitmapLayer::current()->to_layer().get_pos().x,
-                                  BitmapLayer::current()->to_layer().get_pos().y);
+        CL_Display::add_translate(BitmapLayer::current()->to_object().get_pos().x,
+                                  BitmapLayer::current()->to_object().get_pos().y);
         stroke.draw(0);
         CL_Display::pop_modelview();
       }
@@ -95,7 +96,7 @@
         EditorMapComponent* parent = EditorMapComponent::current();
         parent->capture_mouse();
         stroke = Stroke();
-        stroke.set_drawer(sprite_drawer.to_drawer().clone());
+        stroke.set_drawer(drawer.clone());
         add_dab(event);
       }
   }
@@ -106,8 +107,8 @@
     CL_Pointf p = parent->screen2world(event.mouse_pos);    
     
     // FIXME: This is ugly, events relative to the layer should be handled somewhat differently
-    Dab dab(p.x - BitmapLayer::current()->to_layer().get_pos().x,
-            p.y - BitmapLayer::current()->to_layer().get_pos().y);
+    Dab dab(p.x - BitmapLayer::current()->to_object().get_pos().x,
+            p.y - BitmapLayer::current()->to_object().get_pos().y);
 
     // FIXME: Make tablet configurable
     if (CL_Display::get_current_window()->get_ic()->get_mouse_count() >= 4)
@@ -159,7 +160,7 @@
 StrokeDrawer
 SketchStrokeTool::get_drawer()
 {
-  return impl->sprite_drawer.to_drawer();
+  return impl->drawer;
 }
 
 /* EOF */

Modified: trunk/lib/sprite_stroke_drawer.cxx
===================================================================
--- trunk/lib/sprite_stroke_drawer.cxx	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/lib/sprite_stroke_drawer.cxx	2005-03-27 00:58:57 UTC (rev 503)
@@ -148,7 +148,7 @@
                     //surface.set_blend_func_separate(blend_src_alpha, blend_one_minus_src_alpha,
                     //                                blend_one, blend_zero);
                     surface.set_alignment(origin_center);
-                    surface.set_alpha(0.8);
+                    surface.set_alpha(0.5);
                     //surface.set_scale(DrawerProperties::current()->get_size(),
                     //                 DrawerProperties::current()->get_size());
                     surface.draw(dab.pos.x, dab.pos.y, gc);

Modified: trunk/paint/gui.rb
===================================================================
--- trunk/paint/gui.rb	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/paint/gui.rb	2005-03-27 00:58:57 UTC (rev 503)
@@ -101,10 +101,23 @@
 #                       self.gui_set_zoom(value)
 #                     })
 
+    connect_v2(@editor_map.sig_on_key("a"), proc{ |x,y|
+                 gc = @editor_map.get_workspace().get_gc_state()
+                 gc.set_zoom(CL_Pointf.new(x, y), gc.get_zoom() * 1.25)
+               })
+
+    connect_v2(@editor_map.sig_on_key("o"), proc{ |x,y|
+                 gc = @editor_map.get_workspace().get_gc_state()
+                 gc.set_zoom(CL_Pointf.new(x, y), gc.get_zoom() / 1.25)
+               })
+
     connect_v2(@editor_map.sig_on_key("escape"),  proc{ |x, y| puts "bye, bye"})
     connect_v2(@editor_map.sig_on_key("esc"),  proc{ |x, y| puts "bye, bye2"})
     connect_v2(@editor_map.sig_on_key("q"),  proc{ |x, y| $gui.quit()})
-    connect_v2(@editor_map.sig_on_key("s"),  proc{ |x, y| $image.save("/tmp/test.scm")})
+    connect_v2(@editor_map.sig_on_key("s"),  proc{ |x, y| 
+                 CL_ProviderFactory.save(BitmapLayer.current().get_pixeldata(), "/tmp/bla.png")
+                 # $image.save("/tmp/test.scm")
+               })
     connect_v2(@editor_map.sig_on_key("l"),  proc{ |x, y| 
                  $image = Image.new("/tmp/test.scm")
                  $image.activate($gui.workspace())
@@ -148,7 +161,7 @@
               drawer.set_mode(SpriteStrokeDrawer::DM_SMUDGE)
             })
 
-    button_panel = ButtonPanel.new(0, 0, 33, 33*3, false, @gui.get_component)
+    button_panel = ButtonPanel.new(0, 0, 33, 33*4, false, @gui.get_component)
     button_panel.add_icon("../data/images/tools/stock-tool-pencil-22.png", proc{ 
                             @workspace.set_tool($sketch_stroke_tool.to_tool())
                           })
@@ -159,6 +172,10 @@
                             @workspace.set_tool($layer_move_tool.to_tool())
                           })
 
+    button_panel.add_icon("../data/images/tools/stock-tool-clone-22.png", proc{ 
+                            @workspace.set_tool($objmap_select_tool.to_tool())
+                          })
+
     anim_panel = ButtonPanel.new($screen_rect.get_width()/2 - (32*3)/2-16-32, 0, 32*3+1+16, 33,
                                  true, @gui.get_component)
     anim_panel.add_icon("../data/images/icons24/stock_new.png",
@@ -185,6 +202,9 @@
   def run()
     @gui.run()
   end
+
+  def on_map_change()
+  end
 end
 
 # EOF #

Modified: trunk/paint/image.rb
===================================================================
--- trunk/paint/image.rb	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/paint/image.rb	2005-03-27 00:58:57 UTC (rev 503)
@@ -6,6 +6,10 @@
     @editormap = EditorMap.new()
     @editormap.set_bounding_rect(CL_Rect.new(0, 0, 1024, 768))
     @editormap.set_background_color(CL_Color.new(255, 255, 255))
+
+    @objectmap = ObjectLayer.new()
+    @editormap.add_layer(@objectmap.to_layer()) 
+
     @layers  = []
     
     if filename then
@@ -18,27 +22,33 @@
   end
   
   def set_active_layer(i)
-    if (i >= 0 && i < layers.size) then
-      BitmapLayer.set_current(layers[i])
+    if (i >= 0 && i < @layers.size) then
+      BitmapLayer.set_current(@layers[i])
     end
   end
 
-  def add_layer()
-    layer = BitmapLayer.new(1024, 768)
-    layer.to_layer().set_pos(CL_Pointf.new(0, 0))
-    @layers.push(layer)
-    @editormap.add_layer(layer.to_layer()) 
-    puts "Add layer: #{layer}" 
-    return layer
+  def add_layer(filename = nil)
+    if filename then
+      layer = BitmapLayer.new(make_pixelbuffer(filename))
+      @layers.push(layer)
+      @objectmap.add_object(layer.to_object())
+      return layer
+    else
+      layer = BitmapLayer.new(1024, 768)
+      @layers.push(layer)
+      @objectmap.add_object(layer.to_object())
+      return layer
+    end
   end
 
   def layers_count()
-    return layers.size
+    return @layers.size
   end
 
   def activate(workspace)
     workspace.set_map(@editormap)
-    BitmapLayer.set_current(layers[0])
+    BitmapLayer.set_current(@layers[0])
+    ObjectLayer.set_current(@objectmap)
     connect(@editormap.sig_change(), proc{$gui.on_map_change()})
   end
 

Modified: trunk/paint/paint.rb
===================================================================
--- trunk/paint/paint.rb	2005-03-25 16:57:04 UTC (rev 502)
+++ trunk/paint/paint.rb	2005-03-27 00:58:57 UTC (rev 503)
@@ -37,6 +37,7 @@
 $sketch_stroke_tool  = SketchStrokeTool.new()
 $layer_move_tool     = LayerMoveTool.new()
 $zoom_tool           = ZoomTool.new()
+$objmap_select_tool  = ObjMapSelectTool.new()
 
 DrawerProperties.current().set_color(CL_Color.new(0, 0, 0, 50))
 
@@ -44,17 +45,21 @@
 
 $animation = Animation.new()
 $image = $animation.get_current_image()
+# $image.add_layer("/tmp/img.png")
+# $image.layers[0].set_pixeldata(make_pixelbuffer("/tmp/img.png"))
+# BitmapLayer.set_current($image.layers[0])
 
 $image.activate($gui.workspace)
 
-drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+# drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+
 if true then
   DrawerProperties.current().set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
-                                      32,  # radius
-                                      2,   # spikes
-                                      0.75, # hardness
-                                      1.0, # aspect
-                                      0).to_brush()) # angle
+                                                          32,  # radius
+                                                          2,   # spikes
+                                                          0.75, # hardness
+                                                          1.0, # aspect
+                                                          0).to_brush()) # angle
 else
   DrawerProperties.current().set_brush(SpriteBrush.new(make_sprite("../data/images/brush/brush8.png")).to_brush)
 end



From grumbel at sheep.berlios.de  Tue Mar 29 17:54:12 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 17:54:12 +0200
Subject: [Flexlay-commit] r504 - in trunk: lib netpanzer ruby
Message-ID: <200503291554.j2TFsC54003540@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 17:54:11 +0200 (Tue, 29 Mar 2005)
New Revision: 504

Added:
   trunk/lib/drawer_properties.cxx
   trunk/lib/drawer_properties.hxx
Modified:
   trunk/lib/flexlay_wrap.i
   trunk/netpanzer/SConstruct
   trunk/netpanzer/netpanzer.i
   trunk/ruby/SConstruct
Log:
- some changes

Added: trunk/lib/drawer_properties.cxx
===================================================================
--- trunk/lib/drawer_properties.cxx	2005-03-27 00:58:57 UTC (rev 503)
+++ trunk/lib/drawer_properties.cxx	2005-03-29 15:54:11 UTC (rev 504)
@@ -0,0 +1,100 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "drawer_properties.hxx"
+
+DrawerProperties* DrawerProperties::current_ = 0;
+
+class DrawerPropertiesImpl
+{
+public:
+  CL_Color  color;
+  float     base_size;
+  float     spacing;
+  Brush     brush;
+};
+
+DrawerProperties*
+DrawerProperties::current()
+{
+  if (!current_)
+    return (current_ = new DrawerProperties());
+  else
+    return current_;
+}
+
+DrawerProperties::DrawerProperties()
+  : impl(new DrawerPropertiesImpl())
+{
+  impl->color     = CL_Color(255, 255, 255, 255);
+  impl->base_size = 1.0f;
+    
+  impl->base_size = 1.0f;
+  impl->spacing   = 15.0f;
+}
+
+void
+DrawerProperties::set_spacing(float spacing_)
+{
+  impl->spacing = spacing_;
+}
+
+float
+DrawerProperties::get_spacing() const
+{
+  return impl->spacing;
+}
+
+void
+DrawerProperties::set_size(float s)
+{
+  impl->base_size = s;
+}
+
+float
+DrawerProperties::get_size() const
+{
+  return impl->base_size;
+}
+
+void
+DrawerProperties::set_color(const CL_Color& color_)
+{
+  impl->color = color_;
+}
+
+CL_Color
+DrawerProperties::get_color() const
+{
+  return impl->color;
+}
+
+void
+DrawerProperties::set_brush(const Brush& brush)
+{
+  impl->brush = brush;
+}
+
+Brush
+DrawerProperties::get_brush() const
+{
+  return impl->brush;
+}
+
+/* EOF */

Added: trunk/lib/drawer_properties.hxx
===================================================================
--- trunk/lib/drawer_properties.hxx	2005-03-27 00:58:57 UTC (rev 503)
+++ trunk/lib/drawer_properties.hxx	2005-03-29 15:54:11 UTC (rev 504)
@@ -0,0 +1,66 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_DRAWER_PROPERTIES_HXX
+#define HEADER_DRAWER_PROPERTIES_HXX
+
+#include <ClanLib/Display/color.h>
+#include "brush.hxx"
+
+class DrawerPropertiesImpl;
+
+/** */
+class DrawerProperties
+{
+private:
+  static DrawerProperties* current_;
+public:
+  static DrawerProperties* current();
+
+  DrawerProperties();
+  ~DrawerProperties();
+
+  /** Set the spacing that will be between the sprites that are drawn
+      along the dabs */
+  void  set_spacing(float spacing);
+  float get_spacing() const;
+
+  /** Set the base size of the Sprite, the real size itself can be
+      affected by pressure and is than calculated by combining
+      basesize and pressure or tilting */
+  void  set_size(float s);
+  float get_size() const;
+
+  /** Set the base color, the real color itself is calculated from
+      combining the base color with the current pressure or tilting */
+  void     set_color(const CL_Color& color);
+  CL_Color get_color() const;
+
+  /** Set the brush to be used, its color and size settings are
+      ignored */
+  void  set_brush(const Brush& brush);
+  Brush get_brush() const;
+
+private:
+  SharedPtr<DrawerPropertiesImpl> impl;
+};
+
+#endif
+
+/* EOF */

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-27 00:58:57 UTC (rev 503)
+++ trunk/lib/flexlay_wrap.i	2005-03-29 15:54:11 UTC (rev 504)
@@ -86,12 +86,6 @@
 // #include "netpanzer.hxx" 
 #include "helper.hxx"
 
-#ifdef SWIGPYTHON
-#include "sexpr_parser.hxx"
-#include "python_meta_data.hxx"
-#include "python_functor.hxx"
-#endif
-
 #ifdef SWIGRUBY
 #include "ruby_sexpr_parser.hxx"
 #include "ruby_meta_data.hxx"
@@ -127,7 +121,6 @@
  CL_Point* resultptr = new CL_Point(arg);
  return SWIG_NewPointerObj((void *) resultptr, SWIGTYPE_p_CL_Point, 1);
 }
-
 #endif
 %}
 
@@ -207,15 +200,9 @@
 // %include "netpanzer.hxx" 
 %include "helper.hxx"
 
-#ifdef SWIGPYTHON
-%include "python_meta_data.hxx"
-%include "sexpr_parser.hxx"
-#endif
-
 #ifdef SWIGRUBY
 %include "../ruby/ruby_meta_data.hxx"
 %include "../ruby/ruby_sexpr_parser.hxx"
-
 #endif
 
 

Modified: trunk/netpanzer/SConstruct
===================================================================
--- trunk/netpanzer/SConstruct	2005-03-27 00:58:57 UTC (rev 503)
+++ trunk/netpanzer/SConstruct	2005-03-29 15:54:11 UTC (rev 504)
@@ -38,7 +38,7 @@
 
 Depends('netpanzer.i', ['netpanzer.hxx'])
 env.Command('netpanzer_wrap.cxx', 'netpanzer.i',
-            "swig -noruntime -ruby   -o netpanzer_wrap.cxx -c++ $SOURCE")
+            "swig -c++ -ruby -o netpanzer_wrap.cxx  $SOURCE")
 
 clanLib_env = Environment()
 clanLib_env.ParseConfig("pkg-config --cflags --libs clanCore-0.7 clanDisplay-0.7 clanGL-0.7 clanSignals-0.7 clanGUI-0.7 clanGUIStyleSilver-0.7")

Modified: trunk/netpanzer/netpanzer.i
===================================================================
--- trunk/netpanzer/netpanzer.i	2005-03-27 00:58:57 UTC (rev 503)
+++ trunk/netpanzer/netpanzer.i	2005-03-29 15:54:11 UTC (rev 504)
@@ -2,9 +2,12 @@
 %include "std_string.i"
 
 %{
+#include <iostream>
+#include <ClanLib/Core/System/error.h>
 #include "netpanzer.hxx"
 %}
 
+%import  "../lib/flexlay_wrap.i"
 %include "netpanzer.hxx"
 
 // EOF //

Modified: trunk/ruby/SConstruct
===================================================================
--- trunk/ruby/SConstruct	2005-03-27 00:58:57 UTC (rev 503)
+++ trunk/ruby/SConstruct	2005-03-29 15:54:11 UTC (rev 504)
@@ -37,12 +37,6 @@
                   options=opts)
 Help(opts.GenerateHelpText(env))
 
-env.Command('swigrun_wrap.cxx', 'swigrun.i',
-            "swig -runtime -ruby -o $TARGET -c++ $SOURCE")
-
-env.SharedLibrary(target='libswigrun.so', source='swigrun_wrap.cxx',
-              CPPPATH=['$USER_CPPPATH','$RUBYDIR'])
-
 def gen_i_depends(path, filename):
     print os.getcwd()
     lst = []
@@ -57,7 +51,7 @@
 
 Depends('../lib/flexlay_wrap.i', gen_i_depends(Dir("../lib").abspath, File("../lib/flexlay_wrap.i").abspath))
 env.Command('flexlay_ruby_wrap.cxx', '../lib/flexlay_wrap.i',
-            "swig -noruntime -ruby -o $TARGET -c++ $SOURCE")
+            "swig -c++ -ruby -o $TARGET $SOURCE")
 
 clanLib_env = Environment()
 clanLib_env.ParseConfig("pkg-config --cflags --libs clanCore-0.7 clanDisplay-0.7 clanGL-0.7 clanSignals-0.7 clanGUI-0.7 clanGUIStyleSilver-0.7")
@@ -76,7 +70,7 @@
     CPPPATH=['$USER_CPPPATH','$RUBYDIR','../lib/'] + clanLib_env['CPPPATH'],
     LINKFLAGS = clanLib_env['LINKFLAGS'],
     LIBPATH=['../lib', '.'] + clanLib_env['LIBPATH'],
-    LIBS=['swigrun', 'flexlay'] + clanLib_env['LIBS'])
+    LIBS=['flexlay'] + clanLib_env['LIBS'])
 
 # install_ruby = env.Alias('install_headers', Install(env['DESTDIR'] + env['PREFIX'] + '/include/flexlay', flexlay_headers))
 # env.Alias('install', [install_ruby])



From grumbel at sheep.berlios.de  Tue Mar 29 19:10:39 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 19:10:39 +0200
Subject: [Flexlay-commit] r505 - trunk/netpanzer
Message-ID: <200503291710.j2THAdjX013246@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 19:10:27 +0200 (Tue, 29 Mar 2005)
New Revision: 505

Modified:
   trunk/netpanzer/netpanzer.rb
Log:
- 'fixed' crash at exit

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 15:54:11 UTC (rev 504)
+++ trunk/netpanzer/netpanzer.rb	2005-03-29 17:10:27 UTC (rev 505)
@@ -325,7 +325,7 @@
 
 $gui.run()
 
-flexlay.deinit()
-print "deinit done"
+# flexlay.deinit()
+# print "deinit done"
 
 # EOF #



From grumbel at sheep.berlios.de  Tue Mar 29 19:13:06 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 19:13:06 +0200
Subject: [Flexlay-commit] r506 - in trunk: . data/images/brush
Message-ID: <200503291713.j2THD6Tj016164@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 19:12:54 +0200 (Tue, 29 Mar 2005)
New Revision: 506

Added:
   trunk/data/images/brush/brush8.png
Modified:
   trunk/SConstruct
Log:
- added netpanzer to the top-level SCons file

Modified: trunk/SConstruct
===================================================================
--- trunk/SConstruct	2005-03-29 17:10:27 UTC (rev 505)
+++ trunk/SConstruct	2005-03-29 17:12:54 UTC (rev 506)
@@ -1,6 +1,7 @@
 SConscript(['lib/SConstruct'])
 SConscript(['ruby/SConstruct'])
 SConscript(['supertux/SConstruct'])
+SConscript(['netpanzer/SConstruct'])
 
 # EOF #
 

Added: trunk/data/images/brush/brush8.png
===================================================================
(Binary files differ)


Property changes on: trunk/data/images/brush/brush8.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From grumbel at sheep.berlios.de  Tue Mar 29 22:15:37 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 22:15:37 +0200
Subject: [Flexlay-commit] r507 - trunk/netpanzer
Message-ID: <200503292015.j2TKFbTb020684@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 22:15:35 +0200 (Tue, 29 Mar 2005)
New Revision: 507

Modified:
   trunk/netpanzer/netpanzer.rb
   trunk/netpanzer/netpanzersprites.xml
Log:
- added support for object dropping

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 17:12:54 UTC (rev 506)
+++ trunk/netpanzer/netpanzer.rb	2005-03-29 20:15:35 UTC (rev 507)
@@ -26,6 +26,24 @@
 
 require "netpanzerbrushes.rb"
 
+module GameObjects
+  class GameObject
+    attr_accessor :data
+  end
+
+  class Outpost < GameObject
+    def Outpost.get_sprite()
+      return make_sprite_from_resource("sprites/outpost", $resources)
+    end
+  end
+  
+  class SpawnPoint < GameObject
+    def SpawnPoint.get_sprite()
+      return make_sprite_from_resource("sprites/spawnpoint", $resources)
+    end
+  end
+end
+
 class Config
   attr_accessor :datadir, :recent_files
 
@@ -111,13 +129,39 @@
 $workspace  = Workspace.new(myrect.get_width(), myrect.get_height())
 $editor_map.set_workspace($workspace)
 
-option_panel = Panel.new(CL_Rect.new(CL_Point.new(666, 56), CL_Size.new(134, 488+56)), $gui.get_component())
+$option_panel = Panel.new(CL_Rect.new(CL_Point.new(666, 56), CL_Size.new(134, 488+56)), $gui.get_component())
 
-brushbox = CL_ListBox.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 488+56-128-9)), option_panel)
+$brushbox = CL_ListBox.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 488+56-128-9)), $option_panel)
+$brushbox.show(false)
 
+$objectselector = ObjectSelector.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 488+56-128-9)),
+                                     42, 42, $option_panel)
+
+$resources = CL_ResourceManager.new("netpanzersprites.xml")
+
+$objectselector.add_brush(ObjectBrush.new(GameObjects::Outpost.get_sprite(),
+                                          make_metadata(proc{GameObjects::Outpost.new()})))
+$objectselector.add_brush(ObjectBrush.new(GameObjects::SpawnPoint.get_sprite(),
+                                          make_metadata(proc{GameObjects::SpawnPoint.new()})))
+
+$objectselector.show(true)
+
+def on_object_drop(brush, pos)
+  obj = get_ruby_object(brush.get_data()).call()
+  pos = $editor_map.screen2world(pos)
+  sprite_obj = ObjMapSpriteObject.new(obj.class.get_sprite(), pos, make_metadata(obj))
+  obj.data = obj
+  
+  cmd = ObjectAddCommand.new(get_ruby_object($workspace.get_map().get_metadata()).objects)
+  cmd.add_object(sprite_obj.to_object)
+  $workspace.get_map().execute(cmd.to_command())
+end
+
+connect_v2_ObjectBrush_Point($objectselector.sig_drop(), method(:on_object_drop))
+
 $brushes.each {|i|
   (index, width, height, name) = i
-  brushbox.insert_item("%s - %sx%s" % [name, width, height])
+  $brushbox.insert_item("%s - %sx%s" % [name, width, height])
 }
 
 def brushbox_change(index)
@@ -127,7 +171,7 @@
   $tilemap_paint_tool.set_brush(brush)
 end
 
-connect_v1(brushbox.sig_highlighted(), method(:brushbox_change))
+connect_v1($brushbox.sig_highlighted(), method(:brushbox_change))
 
 # Tools
 $tilemap_paint_tool  = TileMapPaintTool.new()
@@ -152,9 +196,9 @@
 #   end
 end
 
-startlevel = Level.new(256, 256)
-startlevel.activate($workspace)
-connect(startlevel.editormap.sig_change(), proc{on_map_change})
+$startlevel = Level.new(256, 256)
+$startlevel.activate($workspace)
+connect($startlevel.editormap.sig_change(), proc{on_map_change})
 
 def gui_level_save_as()
   $save_dialog.set_filename(File::dirname($save_dialog.get_filename()) + "/")
@@ -314,7 +358,7 @@
 menu.add_item("Zoom/4:1 (400%) ", proc{ gui_set_zoom(4.0) })
 
 # minimap_panel = Panel(CL_Rect(CL_Point(0, 600-56), CL_Size(800-134, 56)), $gui.get_component())
-minimap = Minimap.new($editor_map, CL_Rect.new(CL_Point.new(3, 488+56 - 128-3), CL_Size.new(128, 128)), option_panel)
+minimap = Minimap.new($editor_map, CL_Rect.new(CL_Point.new(3, 488+56 - 128-3), CL_Size.new(128, 128)), $option_panel)
 
 $load_dialog = SimpleFileDialog.new("Load netPanzer Level", "Load", "Cancel", $gui.get_component())
 $load_dialog.set_filename($config.datadir + "maps/")

Modified: trunk/netpanzer/netpanzersprites.xml
===================================================================
--- trunk/netpanzer/netpanzersprites.xml	2005-03-29 17:12:54 UTC (rev 506)
+++ trunk/netpanzer/netpanzersprites.xml	2005-03-29 20:15:35 UTC (rev 507)
@@ -1,12 +1,12 @@
 <resources>
   <section name="sprites">
     <sprite name="spawnpoint">
-      <image file="images/netpanzersprites/spawnpoint.png" />
+      <image file="netpanzersprites/spawnpoint.png" />
       <translation origin="center" />
     </sprite>
 
     <sprite name="outpost">
-      <image file="images/netpanzersprites/outpost.png" />
+      <image file="netpanzersprites/outpost.png" />
       <translation origin="center" />
     </sprite>
   </section>



From grumbel at sheep.berlios.de  Tue Mar 29 22:25:39 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 22:25:39 +0200
Subject: [Flexlay-commit] r508 - trunk/netpanzer
Message-ID: <200503292025.j2TKPdKN021520@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 22:25:38 +0200 (Tue, 29 Mar 2005)
New Revision: 508

Added:
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/level.rb
Modified:
   trunk/netpanzer/netpanzer.rb
   trunk/netpanzer/netpanzerbrushes.rb
Log:
- some code splitting

Added: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-29 20:15:35 UTC (rev 507)
+++ trunk/netpanzer/gameobjects.rb	2005-03-29 20:25:38 UTC (rev 508)
@@ -0,0 +1,47 @@
+##  $Id$
+## 
+##  Flexlay - A Generic 2D Game Editor
+##  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+##
+##  This program is free software; you can redistribute it and/or
+##  modify it under the terms of the GNU General Public License
+##  as published by the Free Software Foundation; either version 2
+##  of the License, or (at your option) any later version.
+##
+##  This program is distributed in the hope that it will be useful,
+##  but WITHOUT ANY WARRANTY; without even the implied warranty of
+##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+##  GNU General Public License for more details.
+## 
+##  You should have received a copy of the GNU General Public License
+##  along with this program; if not, write to the Free Software
+##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+module GameObjects
+  class GameObject
+    attr_accessor :data
+  end
+
+  class Outpost < GameObject
+    def Outpost.get_sprite()
+      return make_sprite_from_resource("sprites/outpost", $resources)
+    end
+  end
+  
+  class SpawnPoint < GameObject
+    def SpawnPoint.get_sprite()
+      return make_sprite_from_resource("sprites/spawnpoint", $resources)
+    end
+  end
+end
+
+class Config
+  attr_accessor :datadir, :recent_files
+
+  def initialize()
+    @datadir      = "./"
+    @recent_files = []
+  end
+end
+
+# EOF #

Added: trunk/netpanzer/level.rb
===================================================================
--- trunk/netpanzer/level.rb	2005-03-29 20:15:35 UTC (rev 507)
+++ trunk/netpanzer/level.rb	2005-03-29 20:25:38 UTC (rev 508)
@@ -0,0 +1,80 @@
+##  $Id$
+## 
+##  Flexlay - A Generic 2D Game Editor
+##  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+##
+##  This program is free software; you can redistribute it and/or
+##  modify it under the terms of the GNU General Public License
+##  as published by the Free Software Foundation; either version 2
+##  of the License, or (at your option) any later version.
+##
+##  This program is distributed in the hope that it will be useful,
+##  but WITHOUT ANY WARRANTY; without even the implied warranty of
+##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+##  GNU General Public License for more details.
+## 
+##  You should have received a copy of the GNU General Public License
+##  along with this program; if not, write to the Free Software
+##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+class Level
+  attr_accessor :filename, :data, :editormap, :objects
+
+  def initialize(*params)
+    if params.length == 2 then
+      (width, height) = params
+      @data = NetPanzerFileStruct.new($tileset, width, height)
+
+    elsif params.length == 1 then
+      (@filename,) = params
+      @data = NetPanzerFileStruct.new($tileset, @filename)
+    end      
+
+    @objects   = ObjectLayer.new()
+    @editormap = EditorMap.new()
+    @editormap.add_layer(@data.get_tilemap().to_layer())
+    @editormap.add_layer(@objects.to_layer())
+
+    # FIXME: Data might not get freed since its 'recursively' refcounted
+    @editormap.set_metadata(make_metadata(self))
+  end
+
+  def save_optfile(filename)
+    outposts = [] # FIXME
+    
+    f = open(filename, "w")
+    f.write("ObjectiveCount: %d\n\n" % outposts.length)
+    outposts.each {|name, x , y|
+        f.write("Name: %s\n" % "Foobar")
+      f.write("Location: %d %d\n\n" % x.to_i/32, y.to_i/32)
+    }
+  end
+
+  def save_spnfile(filename)
+    spawnpoints = []
+    f = open(filename, "w")
+
+    f.write("SpawnCount: %d\n\n" % spawnpoints.length)
+    spawnpoints.each {|x, y|
+      f.print("Location: %d %d\n" % [x.to_i/32, y.to_i/32])
+    }
+  end
+
+  def save(filename)
+    if filename[-4..-1] == ".npm"
+      data.save(filename)
+      save_optfile(filename[0..-5] + ".opt")
+      save_optfile(filename[0..-5] + ".spn")
+    else
+      raise "Fileextension not valid, must be .npm!"
+    end
+  end
+
+  def activate(workspace)
+    $workspace.set_map(@editormap)
+    TilemapLayer.set_current(@data.get_tilemap())
+    ObjectLayer.set_current(@objects)
+  end
+end
+
+# EOF #

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 20:15:35 UTC (rev 507)
+++ trunk/netpanzer/netpanzer.rb	2005-03-29 20:25:38 UTC (rev 508)
@@ -25,94 +25,9 @@
 include Netpanzer_wrap
 
 require "netpanzerbrushes.rb"
+require "level.rb"
+require "gameobjects.rb"
 
-module GameObjects
-  class GameObject
-    attr_accessor :data
-  end
-
-  class Outpost < GameObject
-    def Outpost.get_sprite()
-      return make_sprite_from_resource("sprites/outpost", $resources)
-    end
-  end
-  
-  class SpawnPoint < GameObject
-    def SpawnPoint.get_sprite()
-      return make_sprite_from_resource("sprites/spawnpoint", $resources)
-    end
-  end
-end
-
-class Config
-  attr_accessor :datadir, :recent_files
-
-  def initialize()
-    @datadir      = "./"
-    @recent_files = []
-  end
-end
-
-class Level
-  attr_accessor :filename, :data, :editormap, :objects
-
-  def initialize(*params)
-    if params.length == 2 then
-      (width, height) = params
-      @data = NetPanzerFileStruct.new($tileset, width, height)
-
-    elsif params.length == 1 then
-      (@filename,) = params
-      @data = NetPanzerFileStruct.new($tileset, @filename)
-    end      
-
-    @objects   = ObjectLayer.new()
-    @editormap = EditorMap.new()
-    @editormap.add_layer(@data.get_tilemap().to_layer())
-    @editormap.add_layer(@objects.to_layer())
-
-    # FIXME: Data might not get freed since its 'recursively' refcounted
-    @editormap.set_metadata(make_metadata(self))
-  end
-
-  def save_optfile(filename)
-    outposts = [] # FIXME
-    
-    f = open(filename, "w")
-    f.write("ObjectiveCount: %d\n\n" % outposts.length)
-    outposts.each {|name, x , y|
-        f.write("Name: %s\n" % "Foobar")
-      f.write("Location: %d %d\n\n" % x.to_i/32, y.to_i/32)
-    }
-  end
-
-  def save_spnfile(filename)
-    spawnpoints = []
-    f = open(filename, "w")
-
-    f.write("SpawnCount: %d\n\n" % spawnpoints.length)
-    spawnpoints.each {|x, y|
-      f.print("Location: %d %d\n" % [x.to_i/32, y.to_i/32])
-    }
-  end
-
-  def save(filename)
-    if filename[-4..-1] == ".npm"
-      data.save(filename)
-      save_optfile(filename[0..-5] + ".opt")
-      save_optfile(filename[0..-5] + ".spn")
-    else
-      raise "Fileextension not valid, must be .npm!"
-    end
-  end
-
-  def activate(workspace)
-    $workspace.set_map(@editormap)
-    TilemapLayer.set_current(@data.get_tilemap())
-    ObjectLayer.set_current(@objects)
-  end
-end
-
 flexlay = Flexlay.new()
 flexlay.init()
 

Modified: trunk/netpanzer/netpanzerbrushes.rb
===================================================================
--- trunk/netpanzer/netpanzerbrushes.rb	2005-03-29 20:15:35 UTC (rev 507)
+++ trunk/netpanzer/netpanzerbrushes.rb	2005-03-29 20:25:38 UTC (rev 508)
@@ -1,3 +1,24 @@
+##  $Id$
+## 
+##  Flexlay - A Generic 2D Game Editor
+##  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+##
+##  This program is free software; you can redistribute it and/or
+##  modify it under the terms of the GNU General Public License
+##  as published by the Free Software Foundation; either version 2
+##  of the License, or (at your option) any later version.
+##
+##  This program is distributed in the hope that it will be useful,
+##  but WITHOUT ANY WARRANTY; without even the implied warranty of
+##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+##  GNU General Public License for more details.
+## 
+##  You should have received a copy of the GNU General Public License
+##  along with this program; if not, write to the Free Software
+##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+# This file defines the mappings of Tile IDs to images/sprite
+
 $brushes = [
     [0, 8, 6, "House1"], 
     [48, 8, 6, "House2"],



From grumbel at sheep.berlios.de  Tue Mar 29 22:48:56 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 22:48:56 +0200
Subject: [Flexlay-commit] r509 - trunk/netpanzer
Message-ID: <200503292048.j2TKmuRo023464@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 22:48:54 +0200 (Tue, 29 Mar 2005)
New Revision: 509

Modified:
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/level.rb
   trunk/netpanzer/netpanzer.rb
Log:
- added spawnpoint and outpost handling (save only, no load)

Modified: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-29 20:25:38 UTC (rev 508)
+++ trunk/netpanzer/gameobjects.rb	2005-03-29 20:48:54 UTC (rev 509)
@@ -19,16 +19,50 @@
 
 module GameObjects
   class GameObject
-    attr_accessor :data
+    attr_reader :data
+    
+    def data=(data)
+      @data = data
+      connect_v1_ObjMapObject(@data.to_object.sig_move(), method(:on_move))
+    end
+
+    def on_move(data)
+      pos = @data.to_object.get_pos()
+      pos.x = (((pos.x+16)/32).to_i)*32
+      pos.y = (((pos.y+16)/32).to_i)*32
+      @data.to_object.set_pos(pos)
+    end
   end
 
   class Outpost < GameObject
+    attr_accessor :name
+
+    def initialize()
+      @name = "Foobar"
+    end
+
+    def x()
+      return (@data.to_object.get_pos.x()/32).to_i
+    end
+
+    def y()
+      return (@data.to_object.get_pos.y()/32).to_i
+    end
+
     def Outpost.get_sprite()
       return make_sprite_from_resource("sprites/outpost", $resources)
     end
   end
   
   class SpawnPoint < GameObject
+    def x()
+      return (@data.to_object.get_pos.x()/32).to_i
+    end
+
+    def y()
+      return (@data.to_object.get_pos.y()/32).to_i
+    end
+
     def SpawnPoint.get_sprite()
       return make_sprite_from_resource("sprites/spawnpoint", $resources)
     end

Modified: trunk/netpanzer/level.rb
===================================================================
--- trunk/netpanzer/level.rb	2005-03-29 20:25:38 UTC (rev 508)
+++ trunk/netpanzer/level.rb	2005-03-29 20:48:54 UTC (rev 509)
@@ -17,6 +17,8 @@
 ##  along with this program; if not, write to the Free Software
 ##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+require "gameobjects.rb"
+
 class Level
   attr_accessor :filename, :data, :editormap, :objects
 
@@ -40,24 +42,31 @@
   end
 
   def save_optfile(filename)
-    outposts = [] # FIXME
-    
+    outposts = @objects.get_objects().
+      find_all {|obj| obj.get_data().is_a? GameObjects::Outpost }.
+      map {|obj| obj.get_data() }    
+
     f = open(filename, "w")
     f.write("ObjectiveCount: %d\n\n" % outposts.length)
-    outposts.each {|name, x , y|
-        f.write("Name: %s\n" % "Foobar")
-      f.write("Location: %d %d\n\n" % x.to_i/32, y.to_i/32)
+    outposts.each {|obj|
+      f.write("Name: %s\n" % obj.name)
+      f.write("Location: %d %d\n\n" % [obj.x, obj.y])
     }
+    f.close()
   end
 
   def save_spnfile(filename)
-    spawnpoints = []
+    spawnpoints = @objects.get_objects().
+      find_all {|obj| obj.get_data().is_a? GameObjects::SpawnPoint }.
+      map {|obj| obj.get_data() }
+
     f = open(filename, "w")
 
     f.write("SpawnCount: %d\n\n" % spawnpoints.length)
-    spawnpoints.each {|x, y|
-      f.print("Location: %d %d\n" % [x.to_i/32, y.to_i/32])
+    spawnpoints.each {|obj|
+      f.print("Location: %d %d\n" % [obj.x, obj.y])
     }
+    f.close()
   end
 
   def save(filename)

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 20:25:38 UTC (rev 508)
+++ trunk/netpanzer/netpanzer.rb	2005-03-29 20:48:54 UTC (rev 509)
@@ -65,7 +65,7 @@
   obj = get_ruby_object(brush.get_data()).call()
   pos = $editor_map.screen2world(pos)
   sprite_obj = ObjMapSpriteObject.new(obj.class.get_sprite(), pos, make_metadata(obj))
-  obj.data = obj
+  obj.data = sprite_obj
   
   cmd = ObjectAddCommand.new(get_ruby_object($workspace.get_map().get_metadata()).objects)
   cmd.add_object(sprite_obj.to_object)
@@ -180,14 +180,20 @@
   $select.set_up()
   $zoom.set_up()
   $object.set_up()
+
+  $brushbox.show(true)
+  $objectselector.show(false)
 end
 
 def set_tilemap_select_tool()
   $workspace.set_tool($tilemap_select_tool.to_tool())
   $paint.set_up()
-   $select.set_down()
+  $select.set_down()
   $zoom.set_up()
   $object.set_up()
+
+  $brushbox.show(false)
+  $objectselector.show(false)
 end
 
 def set_zoom_tool()
@@ -196,6 +202,9 @@
   $select.set_up()
   $zoom.set_down()
   $object.set_up()
+
+  $brushbox.show(false)
+  $objectselector.show(false)
 end
 
 def set_objmap_select_tool()
@@ -204,6 +213,9 @@
   $select.set_up()
   $zoom.set_up()
   $object.set_down()
+
+  $brushbox.show(false)
+  $objectselector.show(true)
 end
 
 $toolbar = Panel.new(CL_Rect.new(CL_Point.new(0, 23+33), CL_Size.new(33, 32*4+2)), $gui.get_component())
@@ -227,16 +239,15 @@
   level.activate($workspace)
   connect(level.editormap.sig_change(), proc{on_map_change})
   
-  if not(has_element(config.recent_files, filename))
-    config.recent_files.append(filename)
-    recent_files_menu.add_item(mysprite, filename, proc{ netpanzer_load_level(filename) })
-
-    minimap.update_minimap()
-  end
+#  if not(has_element($config.recent_files, filename))
+#    $config.recent_files.push(filename)
+#    recent_files_menu.add_item(mysprite, filename, proc{ netpanzer_load_level(filename) })
+#  end
+  $minimap.update_minimap()
 end
 
 def netpanzer_save_level(filename)
-  $workspace.get_map().get_metadata().save(filename)
+  get_ruby_object($workspace.get_map().get_metadata()).save(filename)
 end
 
 recent_files_menu = Menu.new(CL_Point.new(32*2, 54), $gui.get_component())
@@ -250,7 +261,7 @@
       return True
     end
   }
-  return False
+  return false
 end
 
 menu = CL_Menu.new($gui.get_component())
@@ -273,7 +284,7 @@
 menu.add_item("Zoom/4:1 (400%) ", proc{ gui_set_zoom(4.0) })
 
 # minimap_panel = Panel(CL_Rect(CL_Point(0, 600-56), CL_Size(800-134, 56)), $gui.get_component())
-minimap = Minimap.new($editor_map, CL_Rect.new(CL_Point.new(3, 488+56 - 128-3), CL_Size.new(128, 128)), $option_panel)
+$minimap = Minimap.new($editor_map, CL_Rect.new(CL_Point.new(3, 488+56 - 128-3), CL_Size.new(128, 128)), $option_panel)
 
 $load_dialog = SimpleFileDialog.new("Load netPanzer Level", "Load", "Cancel", $gui.get_component())
 $load_dialog.set_filename($config.datadir + "maps/")



From grumbel at sheep.berlios.de  Tue Mar 29 23:19:50 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Tue, 29 Mar 2005 23:19:50 +0200
Subject: [Flexlay-commit] r510 - trunk/netpanzer
Message-ID: <200503292119.j2TLJoxn025003@sheep.berlios.de>

Author: grumbel
Date: 2005-03-29 23:19:49 +0200 (Tue, 29 Mar 2005)
New Revision: 510

Modified:
   trunk/netpanzer/level.rb
Log:
- some load support (not fully working)

Modified: trunk/netpanzer/level.rb
===================================================================
--- trunk/netpanzer/level.rb	2005-03-29 20:48:54 UTC (rev 509)
+++ trunk/netpanzer/level.rb	2005-03-29 21:19:49 UTC (rev 510)
@@ -30,6 +30,9 @@
     elsif params.length == 1 then
       (@filename,) = params
       @data = NetPanzerFileStruct.new($tileset, @filename)
+
+      load_optfile(@filename[0..-5] + ".opt")
+      load_spnfile(@filename[0..-5] + ".spn")
     end      
 
     @objects   = ObjectLayer.new()
@@ -41,6 +44,29 @@
     @editormap.set_metadata(make_metadata(self))
   end
 
+  def load_optfile(filename)
+    f = File.new(filename)
+    count = /ObjectiveCount: ([0-9]+)/.match(f.readline())[1].to_i
+    f.readline() # Skip empty line
+    count.times{|i|
+      name = /Name: (.+)/.match(f.readline())
+      loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline())
+      f.readline() # Skip empty line
+    }
+    f.close()
+  end
+
+  def load_spnfile(filename)
+    f = File.new(filename)
+    count = /SpawnCount: ([0-9]+)/.match(f.readline())[1].to_i
+    f.readline() # Skip empty line
+    count.times{|i|
+      loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline())
+      puts "Location: #{loc[1].to_i} #{loc[2].to_i}"
+    }
+    f.close()
+  end
+
   def save_optfile(filename)
     outposts = @objects.get_objects().
       find_all {|obj| obj.get_data().is_a? GameObjects::Outpost }.
@@ -73,7 +99,7 @@
     if filename[-4..-1] == ".npm"
       data.save(filename)
       save_optfile(filename[0..-5] + ".opt")
-      save_optfile(filename[0..-5] + ".spn")
+      save_spnfile(filename[0..-5] + ".spn")
     else
       raise "Fileextension not valid, must be .npm!"
     end



From grumbel at sheep.berlios.de  Wed Mar 30 00:00:36 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 00:00:36 +0200
Subject: [Flexlay-commit] r511 - trunk/netpanzer
Message-ID: <200503292200.j2TM0acP027354@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 00:00:31 +0200 (Wed, 30 Mar 2005)
New Revision: 511

Modified:
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/level.rb
   trunk/netpanzer/netpanzer.rb
Log:
- added load support

Modified: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-29 21:19:49 UTC (rev 510)
+++ trunk/netpanzer/gameobjects.rb	2005-03-29 22:00:31 UTC (rev 511)
@@ -52,6 +52,17 @@
     def Outpost.get_sprite()
       return make_sprite_from_resource("sprites/outpost", $resources)
     end
+
+    def Outpost.create(objmap, name, x, y)
+      obj = Outpost.new()
+      obj.name = name
+      sprite_obj = ObjMapSpriteObject.new(get_sprite(), CL_Pointf.new(x*32, y*32),
+                                          make_metadata(obj))
+      obj.data = sprite_obj
+      objmap.add_object(sprite_obj.to_object)
+      
+      return obj
+    end
   end
   
   class SpawnPoint < GameObject
@@ -63,6 +74,16 @@
       return (@data.to_object.get_pos.y()/32).to_i
     end
 
+    def SpawnPoint.create(objmap, x, y)
+      obj = SpawnPoint.new()
+      sprite_obj = ObjMapSpriteObject.new(get_sprite(), CL_Pointf.new(x*32, y*32),
+                                          make_metadata(obj))
+      obj.data = sprite_obj
+      objmap.add_object(sprite_obj.to_object)
+      
+      return obj
+    end
+
     def SpawnPoint.get_sprite()
       return make_sprite_from_resource("sprites/spawnpoint", $resources)
     end

Modified: trunk/netpanzer/level.rb
===================================================================
--- trunk/netpanzer/level.rb	2005-03-29 21:19:49 UTC (rev 510)
+++ trunk/netpanzer/level.rb	2005-03-29 22:00:31 UTC (rev 511)
@@ -30,9 +30,6 @@
     elsif params.length == 1 then
       (@filename,) = params
       @data = NetPanzerFileStruct.new($tileset, @filename)
-
-      load_optfile(@filename[0..-5] + ".opt")
-      load_spnfile(@filename[0..-5] + ".spn")
     end      
 
     @objects   = ObjectLayer.new()
@@ -40,29 +37,38 @@
     @editormap.add_layer(@data.get_tilemap().to_layer())
     @editormap.add_layer(@objects.to_layer())
 
+    if @filename then
+      load_optfile(@filename[0..-5] + ".opt")
+      load_spnfile(@filename[0..-5] + ".spn")
+    end
+
     # FIXME: Data might not get freed since its 'recursively' refcounted
-    @editormap.set_metadata(make_metadata(self))
+    @editormap.set_data(self)
   end
 
   def load_optfile(filename)
     f = File.new(filename)
-    count = /ObjectiveCount: ([0-9]+)/.match(f.readline())[1].to_i
+    count = /ObjectiveCount: ([0-9]+)/.match(f.readline().chop)[1].to_i
     f.readline() # Skip empty line
     count.times{|i|
-      name = /Name: (.+)/.match(f.readline())
-      loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline())
+      name = /Name: (.+)/.match(f.readline().chop)
+      loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline().chop)
       f.readline() # Skip empty line
+      GameObjects::Outpost.create(@objects,
+                                  name,
+                                  loc[1].to_i, loc[2].to_i)
     }
     f.close()
   end
 
   def load_spnfile(filename)
     f = File.new(filename)
-    count = /SpawnCount: ([0-9]+)/.match(f.readline())[1].to_i
+    count = /SpawnCount: ([0-9]+)/.match(f.readline().chop)[1].to_i
     f.readline() # Skip empty line
     count.times{|i|
-      loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline())
-      puts "Location: #{loc[1].to_i} #{loc[2].to_i}"
+      loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline().chop)
+      GameObjects::SpawnPoint.create(@objects,
+                                     loc[1].to_i, loc[2].to_i)
     }
     f.close()
   end

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 21:19:49 UTC (rev 510)
+++ trunk/netpanzer/netpanzer.rb	2005-03-29 22:00:31 UTC (rev 511)
@@ -67,7 +67,7 @@
   sprite_obj = ObjMapSpriteObject.new(obj.class.get_sprite(), pos, make_metadata(obj))
   obj.data = sprite_obj
   
-  cmd = ObjectAddCommand.new(get_ruby_object($workspace.get_map().get_metadata()).objects)
+  cmd = ObjectAddCommand.new($workspace.get_map().get_data().objects)
   cmd.add_object(sprite_obj.to_object)
   $workspace.get_map().execute(cmd.to_command())
 end
@@ -247,7 +247,7 @@
 end
 
 def netpanzer_save_level(filename)
-  get_ruby_object($workspace.get_map().get_metadata()).save(filename)
+  $workspace.get_map().get_data().save(filename)
 end
 
 recent_files_menu = Menu.new(CL_Point.new(32*2, 54), $gui.get_component())



From grumbel at sheep.berlios.de  Wed Mar 30 01:25:14 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 01:25:14 +0200
Subject: [Flexlay-commit] r512 - trunk/netpanzer
Message-ID: <200503292325.j2TNPEx7012307@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 01:24:54 +0200 (Wed, 30 Mar 2005)
New Revision: 512

Modified:
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/level.rb
   trunk/netpanzer/netpanzer.rb
Log:
- added basic support tile objects

Modified: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-29 22:00:31 UTC (rev 511)
+++ trunk/netpanzer/gameobjects.rb	2005-03-29 23:24:54 UTC (rev 512)
@@ -17,6 +17,9 @@
 ##  along with this program; if not, write to the Free Software
 ##  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+require "flexlay_wrap"
+include Flexlay_wrap
+
 module GameObjects
   class GameObject
     attr_reader :data
@@ -32,6 +35,10 @@
       pos.y = (((pos.y+16)/32).to_i)*32
       @data.to_object.set_pos(pos)
     end
+
+    def draw_to_tilemap(tilemap)
+      # Draws the GameObject to the given TilemapLayer
+    end
   end
 
   class Outpost < GameObject
@@ -63,6 +70,16 @@
       
       return obj
     end
+
+    def draw_to_tilemap(tilemap)
+      start  = 9541
+      width  = 32
+      height = 18
+
+      brush = TileBrush.new(width, height)
+      brush.set_data(Range.new(start, start + (width*height)-1).to_a)
+      tilemap.draw_tile(brush, CL_Point.new(x(), y()))
+    end
   end
   
   class SpawnPoint < GameObject
@@ -88,6 +105,43 @@
       return make_sprite_from_resource("sprites/spawnpoint", $resources)
     end
   end
+
+  # TileObject is used to hold tilebrushes
+  class TileObject < GameObject
+    def initialize(brushindex)
+      (start, width, height, @name) = $brushes[brushindex]
+      
+      # FIXME: Could be shared among all TileObjects
+      @brush = TileBrush.new(width, height)
+      @brush.set_data(Range.new(start, start + (width*height)-1).to_a)
+    end
+
+    def x()
+      return (@data.to_object.get_pos.x()/32).to_i
+    end
+
+    def y()
+      return (@data.to_object.get_pos.y()/32).to_i
+    end
+
+    def draw_to_tilemap(tilemap)
+      tilemap.draw_tile(@brush, CL_Point.new(x(), y()))
+    end
+
+    def TileObject.create(objmap, brushindex, x, y)
+      obj = TileObject.new(brushindex)
+      sprite_obj = ObjMapSpriteObject.new(get_sprite(), CL_Pointf.new(x*32, y*32),
+                                          make_metadata(obj))
+      obj.data = sprite_obj
+      objmap.add_object(sprite_obj.to_object)
+      
+      return obj
+    end
+    
+    def TileObject.get_sprite()
+      return make_sprite_from_resource("sprites/spawnpoint", $resources)
+    end
+  end
 end
 
 class Config

Modified: trunk/netpanzer/level.rb
===================================================================
--- trunk/netpanzer/level.rb	2005-03-29 22:00:31 UTC (rev 511)
+++ trunk/netpanzer/level.rb	2005-03-29 23:24:54 UTC (rev 512)
@@ -26,7 +26,7 @@
     if params.length == 2 then
       (width, height) = params
       @data = NetPanzerFileStruct.new($tileset, width, height)
-
+      @filename = nil
     elsif params.length == 1 then
       (@filename,) = params
       @data = NetPanzerFileStruct.new($tileset, @filename)
@@ -36,6 +36,7 @@
     @editormap = EditorMap.new()
     @editormap.add_layer(@data.get_tilemap().to_layer())
     @editormap.add_layer(@objects.to_layer())
+    @tilemap = @data.get_tilemap()
 
     if @filename then
       load_optfile(@filename[0..-5] + ".opt")
@@ -102,6 +103,8 @@
   end
 
   def save(filename)
+    flatten()
+
     if filename[-4..-1] == ".npm"
       data.save(filename)
       save_optfile(filename[0..-5] + ".opt")
@@ -111,6 +114,12 @@
     end
   end
 
+  def flatten()
+    @objects.get_objects().each { |obj|
+      obj.get_data().draw_to_tilemap(@tilemap)
+    }
+  end
+
   def activate(workspace)
     $workspace.set_map(@editormap)
     TilemapLayer.set_current(@data.get_tilemap())

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 22:00:31 UTC (rev 511)
+++ trunk/netpanzer/netpanzer.rb	2005-03-29 23:24:54 UTC (rev 512)
@@ -59,6 +59,11 @@
 $objectselector.add_brush(ObjectBrush.new(GameObjects::SpawnPoint.get_sprite(),
                                           make_metadata(proc{GameObjects::SpawnPoint.new()})))
 
+$brushes.size.times {|i|
+  $objectselector.add_brush(ObjectBrush.new(GameObjects::TileObject.get_sprite(),
+                                            make_metadata(proc{GameObjects::TileObject.new(i)})))
+}
+
 $objectselector.show(true)
 
 def on_object_drop(brush, pos)



From grumbel at sheep.berlios.de  Wed Mar 30 01:26:32 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 01:26:32 +0200
Subject: [Flexlay-commit] r513 - in trunk: lib ruby
Message-ID: <200503292326.j2TNQWa2013283@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 01:26:08 +0200 (Wed, 30 Mar 2005)
New Revision: 513

Modified:
   trunk/lib/flexlay_wrap.i
   trunk/lib/paint_command.cxx
   trunk/lib/tilemap_layer.cxx
   trunk/lib/tilemap_layer.hxx
   trunk/ruby/flexlay.rb
Log:
- some little fixes and renaming

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-29 23:24:54 UTC (rev 512)
+++ trunk/lib/flexlay_wrap.i	2005-03-29 23:26:08 UTC (rev 513)
@@ -205,5 +205,4 @@
 %include "../ruby/ruby_sexpr_parser.hxx"
 #endif
 
-
 /* EOF */

Modified: trunk/lib/paint_command.cxx
===================================================================
--- trunk/lib/paint_command.cxx	2005-03-29 23:24:54 UTC (rev 512)
+++ trunk/lib/paint_command.cxx	2005-03-29 23:26:08 UTC (rev 513)
@@ -115,13 +115,13 @@
 void
 PaintCommandImpl::redo()
 {
-  TilemapLayer::draw_tile(tilemap.get_field(), *redo_brush, pos);
+  TilemapLayer::draw_tiles(tilemap.get_field(), *redo_brush, pos);
 }
 
 void
 PaintCommandImpl::undo()
 {
-  TilemapLayer::draw_tile(tilemap.get_field(), *undo_brush, pos);
+  TilemapLayer::draw_tiles(tilemap.get_field(), *undo_brush, pos);
 }
 
 std::string

Modified: trunk/lib/tilemap_layer.cxx
===================================================================
--- trunk/lib/tilemap_layer.cxx	2005-03-29 23:24:54 UTC (rev 512)
+++ trunk/lib/tilemap_layer.cxx	2005-03-29 23:26:08 UTC (rev 513)
@@ -218,11 +218,11 @@
 void
 TilemapLayer::draw_tile(const TileBrush& brush, const CL_Point& pos)
 {
-  draw_tile(&impl->field, brush, pos);
+  draw_tiles(&impl->field, brush, pos);
 }
 
 void
-TilemapLayer::draw_tile(Field<int>* field, const TileBrush& brush, const CL_Point& pos)
+TilemapLayer::draw_tiles(Field<int>* field, const TileBrush& brush, const CL_Point& pos)
 {
   int start_x = std::max(0, -pos.x);
   int start_y = std::max(0, -pos.y);

Modified: trunk/lib/tilemap_layer.hxx
===================================================================
--- trunk/lib/tilemap_layer.hxx	2005-03-29 23:24:54 UTC (rev 512)
+++ trunk/lib/tilemap_layer.hxx	2005-03-29 23:26:08 UTC (rev 513)
@@ -64,6 +64,7 @@
   /** Draw the given single tile to the map */
   void draw_tile(int id, const CL_Point& pos);
 
+  /** FIXME: Very bad naming */
   void draw_tile(int id, int x, int y, bool attribute, CL_GraphicContext* gc);
 
   int get_width()  const;
@@ -80,7 +81,7 @@
 
   CL_PixelBuffer create_pixelbuffer();
 
-  static void draw_tile(Field<int>* field, const TileBrush& brush, const CL_Point& pos);
+  static void draw_tiles(Field<int>* field, const TileBrush& brush, const CL_Point& pos);
 
   bool has_bounding_rect() const;
   CL_Rect get_bounding_rect();

Modified: trunk/ruby/flexlay.rb
===================================================================
--- trunk/ruby/flexlay.rb	2005-03-29 23:24:54 UTC (rev 512)
+++ trunk/ruby/flexlay.rb	2005-03-29 23:26:08 UTC (rev 513)
@@ -2,6 +2,14 @@
   alias orig_get_metadata get_metadata
   alias orig_set_metadata set_metadata
 
+  def set_data(data)
+    orig_set_metadata(make_metadata(data))
+  end
+
+  def get_data()
+    return get_ruby_object(orig_get_metadata())
+  end
+
   def set_metadata(data)
     orig_set_metadata(make_metadata(data))
   end



From grumbel at sheep.berlios.de  Wed Mar 30 14:36:35 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 14:36:35 +0200
Subject: [Flexlay-commit] r515 - in trunk/netpanzer: . thumbnails
Message-ID: <200503301236.j2UCaZrA026830@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 14:36:30 +0200 (Wed, 30 Mar 2005)
New Revision: 515

Added:
   trunk/netpanzer/thumbnails/
   trunk/netpanzer/thumbnails/0.png
   trunk/netpanzer/thumbnails/1.png
   trunk/netpanzer/thumbnails/10.png
   trunk/netpanzer/thumbnails/100.png
   trunk/netpanzer/thumbnails/101.png
   trunk/netpanzer/thumbnails/102.png
   trunk/netpanzer/thumbnails/103.png
   trunk/netpanzer/thumbnails/104.png
   trunk/netpanzer/thumbnails/105.png
   trunk/netpanzer/thumbnails/106.png
   trunk/netpanzer/thumbnails/107.png
   trunk/netpanzer/thumbnails/108.png
   trunk/netpanzer/thumbnails/109.png
   trunk/netpanzer/thumbnails/11.png
   trunk/netpanzer/thumbnails/110.png
   trunk/netpanzer/thumbnails/111.png
   trunk/netpanzer/thumbnails/112.png
   trunk/netpanzer/thumbnails/113.png
   trunk/netpanzer/thumbnails/114.png
   trunk/netpanzer/thumbnails/115.png
   trunk/netpanzer/thumbnails/12.png
   trunk/netpanzer/thumbnails/13.png
   trunk/netpanzer/thumbnails/14.png
   trunk/netpanzer/thumbnails/15.png
   trunk/netpanzer/thumbnails/16.png
   trunk/netpanzer/thumbnails/17.png
   trunk/netpanzer/thumbnails/18.png
   trunk/netpanzer/thumbnails/19.png
   trunk/netpanzer/thumbnails/2.png
   trunk/netpanzer/thumbnails/20.png
   trunk/netpanzer/thumbnails/21.png
   trunk/netpanzer/thumbnails/22.png
   trunk/netpanzer/thumbnails/23.png
   trunk/netpanzer/thumbnails/24.png
   trunk/netpanzer/thumbnails/25.png
   trunk/netpanzer/thumbnails/26.png
   trunk/netpanzer/thumbnails/27.png
   trunk/netpanzer/thumbnails/28.png
   trunk/netpanzer/thumbnails/29.png
   trunk/netpanzer/thumbnails/3.png
   trunk/netpanzer/thumbnails/30.png
   trunk/netpanzer/thumbnails/31.png
   trunk/netpanzer/thumbnails/32.png
   trunk/netpanzer/thumbnails/33.png
   trunk/netpanzer/thumbnails/34.png
   trunk/netpanzer/thumbnails/35.png
   trunk/netpanzer/thumbnails/36.png
   trunk/netpanzer/thumbnails/37.png
   trunk/netpanzer/thumbnails/38.png
   trunk/netpanzer/thumbnails/39.png
   trunk/netpanzer/thumbnails/4.png
   trunk/netpanzer/thumbnails/40.png
   trunk/netpanzer/thumbnails/41.png
   trunk/netpanzer/thumbnails/42.png
   trunk/netpanzer/thumbnails/43.png
   trunk/netpanzer/thumbnails/44.png
   trunk/netpanzer/thumbnails/45.png
   trunk/netpanzer/thumbnails/46.png
   trunk/netpanzer/thumbnails/47.png
   trunk/netpanzer/thumbnails/48.png
   trunk/netpanzer/thumbnails/49.png
   trunk/netpanzer/thumbnails/5.png
   trunk/netpanzer/thumbnails/50.png
   trunk/netpanzer/thumbnails/51.png
   trunk/netpanzer/thumbnails/52.png
   trunk/netpanzer/thumbnails/53.png
   trunk/netpanzer/thumbnails/54.png
   trunk/netpanzer/thumbnails/55.png
   trunk/netpanzer/thumbnails/56.png
   trunk/netpanzer/thumbnails/57.png
   trunk/netpanzer/thumbnails/58.png
   trunk/netpanzer/thumbnails/59.png
   trunk/netpanzer/thumbnails/6.png
   trunk/netpanzer/thumbnails/60.png
   trunk/netpanzer/thumbnails/61.png
   trunk/netpanzer/thumbnails/62.png
   trunk/netpanzer/thumbnails/63.png
   trunk/netpanzer/thumbnails/64.png
   trunk/netpanzer/thumbnails/65.png
   trunk/netpanzer/thumbnails/66.png
   trunk/netpanzer/thumbnails/67.png
   trunk/netpanzer/thumbnails/68.png
   trunk/netpanzer/thumbnails/69.png
   trunk/netpanzer/thumbnails/7.png
   trunk/netpanzer/thumbnails/70.png
   trunk/netpanzer/thumbnails/71.png
   trunk/netpanzer/thumbnails/72.png
   trunk/netpanzer/thumbnails/73.png
   trunk/netpanzer/thumbnails/74.png
   trunk/netpanzer/thumbnails/75.png
   trunk/netpanzer/thumbnails/76.png
   trunk/netpanzer/thumbnails/77.png
   trunk/netpanzer/thumbnails/78.png
   trunk/netpanzer/thumbnails/79.png
   trunk/netpanzer/thumbnails/8.png
   trunk/netpanzer/thumbnails/80.png
   trunk/netpanzer/thumbnails/81.png
   trunk/netpanzer/thumbnails/82.png
   trunk/netpanzer/thumbnails/83.png
   trunk/netpanzer/thumbnails/84.png
   trunk/netpanzer/thumbnails/85.png
   trunk/netpanzer/thumbnails/86.png
   trunk/netpanzer/thumbnails/87.png
   trunk/netpanzer/thumbnails/88.png
   trunk/netpanzer/thumbnails/89.png
   trunk/netpanzer/thumbnails/9.png
   trunk/netpanzer/thumbnails/90.png
   trunk/netpanzer/thumbnails/91.png
   trunk/netpanzer/thumbnails/92.png
   trunk/netpanzer/thumbnails/93.png
   trunk/netpanzer/thumbnails/94.png
   trunk/netpanzer/thumbnails/95.png
   trunk/netpanzer/thumbnails/96.png
   trunk/netpanzer/thumbnails/97.png
   trunk/netpanzer/thumbnails/98.png
   trunk/netpanzer/thumbnails/99.png
Log:
- added thumbnails for netpanzer sprites

Added: trunk/netpanzer/thumbnails/0.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/0.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/1.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/1.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/10.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/10.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/100.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/100.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/101.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/101.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/102.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/102.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/103.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/103.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/104.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/104.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/105.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/105.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/106.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/106.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/107.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/107.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/108.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/108.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/109.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/109.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/11.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/11.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/110.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/110.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/111.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/111.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/112.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/112.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/113.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/113.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/114.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/114.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/115.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/115.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/12.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/12.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/13.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/13.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/14.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/14.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/15.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/15.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/16.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/16.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/17.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/17.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/18.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/18.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/19.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/19.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/2.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/2.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/20.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/20.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/21.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/21.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/22.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/22.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/23.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/23.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/24.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/24.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/25.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/25.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/26.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/26.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/27.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/27.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/28.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/28.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/29.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/29.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/3.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/3.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/30.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/30.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/31.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/31.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/32.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/32.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/33.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/33.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/34.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/34.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/35.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/35.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/36.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/36.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/37.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/37.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/38.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/38.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/39.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/39.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/4.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/4.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/40.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/40.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/41.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/41.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/42.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/42.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/43.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/43.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/44.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/44.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/45.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/45.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/46.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/46.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/47.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/47.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/48.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/48.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/49.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/49.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/5.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/5.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/50.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/50.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/51.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/51.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/52.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/52.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/53.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/53.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/54.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/54.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/55.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/55.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/56.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/56.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/57.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/57.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/58.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/58.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/59.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/59.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/6.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/6.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/60.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/60.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/61.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/61.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/62.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/62.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/63.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/63.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/64.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/64.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/65.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/65.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/66.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/66.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/67.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/67.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/68.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/68.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/69.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/69.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/7.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/7.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/70.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/70.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/71.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/71.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/72.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/72.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/73.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/73.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/74.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/74.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/75.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/75.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/76.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/76.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/77.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/77.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/78.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/78.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/79.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/79.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/8.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/8.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/80.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/80.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/81.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/81.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/82.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/82.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/83.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/83.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/84.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/84.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/85.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/85.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/86.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/86.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/87.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/87.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/88.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/88.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/89.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/89.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/9.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/9.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/90.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/90.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/91.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/91.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/92.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/92.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/93.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/93.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/94.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/94.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/95.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/95.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/96.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/96.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/97.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/97.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/98.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/98.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/thumbnails/99.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/thumbnails/99.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From grumbel at sheep.berlios.de  Wed Mar 30 14:43:35 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 14:43:35 +0200
Subject: [Flexlay-commit] r516 - trunk/netpanzer/sprites
Message-ID: <200503301243.j2UChZ3D027697@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 14:43:32 +0200 (Wed, 30 Mar 2005)
New Revision: 516

Modified:
   trunk/netpanzer/sprites/0.png
   trunk/netpanzer/sprites/1.png
   trunk/netpanzer/sprites/10.png
   trunk/netpanzer/sprites/100.png
   trunk/netpanzer/sprites/101.png
   trunk/netpanzer/sprites/102.png
   trunk/netpanzer/sprites/103.png
   trunk/netpanzer/sprites/104.png
   trunk/netpanzer/sprites/105.png
   trunk/netpanzer/sprites/106.png
   trunk/netpanzer/sprites/107.png
   trunk/netpanzer/sprites/108.png
   trunk/netpanzer/sprites/109.png
   trunk/netpanzer/sprites/11.png
   trunk/netpanzer/sprites/110.png
   trunk/netpanzer/sprites/111.png
   trunk/netpanzer/sprites/112.png
   trunk/netpanzer/sprites/113.png
   trunk/netpanzer/sprites/114.png
   trunk/netpanzer/sprites/115.png
   trunk/netpanzer/sprites/12.png
   trunk/netpanzer/sprites/13.png
   trunk/netpanzer/sprites/14.png
   trunk/netpanzer/sprites/15.png
   trunk/netpanzer/sprites/16.png
   trunk/netpanzer/sprites/17.png
   trunk/netpanzer/sprites/18.png
   trunk/netpanzer/sprites/19.png
   trunk/netpanzer/sprites/2.png
   trunk/netpanzer/sprites/20.png
   trunk/netpanzer/sprites/21.png
   trunk/netpanzer/sprites/22.png
   trunk/netpanzer/sprites/23.png
   trunk/netpanzer/sprites/24.png
   trunk/netpanzer/sprites/25.png
   trunk/netpanzer/sprites/26.png
   trunk/netpanzer/sprites/27.png
   trunk/netpanzer/sprites/28.png
   trunk/netpanzer/sprites/29.png
   trunk/netpanzer/sprites/3.png
   trunk/netpanzer/sprites/30.png
   trunk/netpanzer/sprites/31.png
   trunk/netpanzer/sprites/32.png
   trunk/netpanzer/sprites/33.png
   trunk/netpanzer/sprites/34.png
   trunk/netpanzer/sprites/35.png
   trunk/netpanzer/sprites/36.png
   trunk/netpanzer/sprites/37.png
   trunk/netpanzer/sprites/38.png
   trunk/netpanzer/sprites/39.png
   trunk/netpanzer/sprites/4.png
   trunk/netpanzer/sprites/40.png
   trunk/netpanzer/sprites/41.png
   trunk/netpanzer/sprites/42.png
   trunk/netpanzer/sprites/43.png
   trunk/netpanzer/sprites/44.png
   trunk/netpanzer/sprites/45.png
   trunk/netpanzer/sprites/46.png
   trunk/netpanzer/sprites/47.png
   trunk/netpanzer/sprites/48.png
   trunk/netpanzer/sprites/49.png
   trunk/netpanzer/sprites/5.png
   trunk/netpanzer/sprites/50.png
   trunk/netpanzer/sprites/51.png
   trunk/netpanzer/sprites/52.png
   trunk/netpanzer/sprites/53.png
   trunk/netpanzer/sprites/54.png
   trunk/netpanzer/sprites/55.png
   trunk/netpanzer/sprites/56.png
   trunk/netpanzer/sprites/57.png
   trunk/netpanzer/sprites/58.png
   trunk/netpanzer/sprites/59.png
   trunk/netpanzer/sprites/6.png
   trunk/netpanzer/sprites/60.png
   trunk/netpanzer/sprites/61.png
   trunk/netpanzer/sprites/62.png
   trunk/netpanzer/sprites/63.png
   trunk/netpanzer/sprites/64.png
   trunk/netpanzer/sprites/65.png
   trunk/netpanzer/sprites/66.png
   trunk/netpanzer/sprites/67.png
   trunk/netpanzer/sprites/68.png
   trunk/netpanzer/sprites/69.png
   trunk/netpanzer/sprites/7.png
   trunk/netpanzer/sprites/70.png
   trunk/netpanzer/sprites/71.png
   trunk/netpanzer/sprites/72.png
   trunk/netpanzer/sprites/73.png
   trunk/netpanzer/sprites/74.png
   trunk/netpanzer/sprites/75.png
   trunk/netpanzer/sprites/76.png
   trunk/netpanzer/sprites/77.png
   trunk/netpanzer/sprites/78.png
   trunk/netpanzer/sprites/79.png
   trunk/netpanzer/sprites/8.png
   trunk/netpanzer/sprites/80.png
   trunk/netpanzer/sprites/81.png
   trunk/netpanzer/sprites/82.png
   trunk/netpanzer/sprites/83.png
   trunk/netpanzer/sprites/84.png
   trunk/netpanzer/sprites/85.png
   trunk/netpanzer/sprites/86.png
   trunk/netpanzer/sprites/87.png
   trunk/netpanzer/sprites/88.png
   trunk/netpanzer/sprites/89.png
   trunk/netpanzer/sprites/9.png
   trunk/netpanzer/sprites/90.png
   trunk/netpanzer/sprites/91.png
   trunk/netpanzer/sprites/92.png
   trunk/netpanzer/sprites/93.png
   trunk/netpanzer/sprites/94.png
   trunk/netpanzer/sprites/95.png
   trunk/netpanzer/sprites/96.png
   trunk/netpanzer/sprites/97.png
   trunk/netpanzer/sprites/98.png
   trunk/netpanzer/sprites/99.png
Log:
- added netpanzer sprites, only temporary, should read netpanzer datafile in the end

Modified: trunk/netpanzer/sprites/0.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/1.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/10.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/100.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/101.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/102.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/103.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/104.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/105.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/106.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/107.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/108.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/109.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/11.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/110.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/111.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/112.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/113.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/114.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/115.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/12.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/13.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/14.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/15.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/16.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/17.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/18.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/19.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/2.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/20.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/21.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/22.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/23.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/24.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/25.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/26.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/27.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/28.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/29.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/3.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/30.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/31.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/32.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/33.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/34.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/35.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/36.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/37.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/38.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/39.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/4.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/40.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/41.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/42.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/43.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/44.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/45.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/46.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/47.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/48.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/49.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/5.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/50.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/51.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/52.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/53.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/54.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/55.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/56.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/57.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/58.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/59.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/6.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/60.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/61.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/62.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/63.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/64.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/65.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/66.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/67.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/68.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/69.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/7.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/70.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/71.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/72.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/73.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/74.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/75.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/76.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/77.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/78.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/79.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/8.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/80.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/81.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/82.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/83.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/84.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/85.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/86.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/87.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/88.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/89.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/9.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/90.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/91.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/92.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/93.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/94.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/95.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/96.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/97.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/98.png
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/sprites/99.png
===================================================================
(Binary files differ)



From grumbel at sheep.berlios.de  Wed Mar 30 14:49:59 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 14:49:59 +0200
Subject: [Flexlay-commit] r517 - in trunk: lib netpanzer ruby
Message-ID: <200503301249.j2UCnxj8028197@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 14:49:58 +0200 (Wed, 30 Mar 2005)
New Revision: 517

Modified:
   trunk/lib/SConstruct
   trunk/lib/clanlib.i
   trunk/lib/object_layer.cxx
   trunk/lib/objmap_sprite_object.cxx
   trunk/lib/tile.cxx
   trunk/lib/tile.hxx
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/level.rb
   trunk/netpanzer/netpanzer.cxx
   trunk/netpanzer/netpanzer.rb
   trunk/ruby/flexlay.rb
Log:
- added flatten/unflatten to netpanzer
- added TileProvider

Modified: trunk/lib/SConstruct
===================================================================
--- trunk/lib/SConstruct	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/lib/SConstruct	2005-03-30 12:49:58 UTC (rev 517)
@@ -111,6 +111,7 @@
     'tile.cxx',
     'titlebar.cxx',
     'tile_brush.cxx',
+    'tile_provider.cxx',
     'tile_editor.cxx',
     'tile_selection.cxx',
     'tile_selector.cxx',

Modified: trunk/lib/clanlib.i
===================================================================
--- trunk/lib/clanlib.i	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/lib/clanlib.i	2005-03-30 12:49:58 UTC (rev 517)
@@ -8,6 +8,7 @@
 	CL_Component(CL_Component* parent, CL_StyleManager* style = NULL);
         void show(bool show = true);
        	bool is_visible(bool check_parents = true);
+        void set_focus();
 	void set_size(int new_width, int new_height);
 	void set_position(int new_x, int new_y);
 	const CL_Rect& get_position();
@@ -160,6 +161,8 @@
 		CL_Component *parent,
 		CL_StyleManager *style = NULL);
 
+	CL_Signal_v0& sig_return_pressed();
+
 	void set_text(const std::string &text);
 	const std::string &get_text() const;        
 };

Modified: trunk/lib/object_layer.cxx
===================================================================
--- trunk/lib/object_layer.cxx	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/lib/object_layer.cxx	2005-03-30 12:49:58 UTC (rev 517)
@@ -25,6 +25,7 @@
 #include "objmap_sprite_object.hxx"
 #include "objmap_control_point.hxx"
 #include "object_layer.hxx"
+#include "editor_map_component.hxx"
 #include "layer_impl.hxx"
 
 ObjectLayer ObjectLayer::current_;
@@ -57,7 +58,9 @@
 {
   for(ObjectLayer::Objects::iterator i = objects.begin(); i != objects.end(); ++i)
     {
-      (*i).draw(gc);
+      // FIXME: Add clipping here
+      if (parent->get_clip_rect().is_overlapped((*i).get_bound_rect()))
+        (*i).draw(gc);
     }
 
   for(ObjectLayer::ControlPoints::iterator i = control_points.begin(); i != control_points.end(); ++i)

Modified: trunk/lib/objmap_sprite_object.cxx
===================================================================
--- trunk/lib/objmap_sprite_object.cxx	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/lib/objmap_sprite_object.cxx	2005-03-30 12:49:58 UTC (rev 517)
@@ -74,12 +74,12 @@
   if (scale_y < 0)
     align.y += sprite.get_height();
       
-  if (scale_x > 1.0f && scale_y > 1.0f)
-    return CL_Rectf(pos - origin - align,
-                    CL_Sizef(sprite.get_width() * scale_x, sprite.get_height() * scale_y));
-  else
-    return CL_Rectf(pos - origin - align,
-                    CL_Sizef(sprite.get_width(), sprite.get_height()));  
+  //  if (scale_x > 1.0f && scale_y > 1.0f)
+  //    return CL_Rectf(pos - origin - align,
+  //                   CL_Sizef(sprite.get_width() * scale_x, sprite.get_height() * scale_y));
+//  else
+  return CL_Rectf(pos - origin - align,
+                  CL_Sizef(sprite.get_width(), sprite.get_height()));  
 }
 
 void

Modified: trunk/lib/tile.cxx
===================================================================
--- trunk/lib/tile.cxx	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/lib/tile.cxx	2005-03-30 12:49:58 UTC (rev 517)
@@ -48,6 +48,12 @@
   std::string filename;
 };
 
+Tile::Tile(const TileProvider& provider)
+  : impl(new TileImpl())
+{
+  
+}
+
 Tile::Tile(const CL_PixelBuffer& pixelbuffer,
            const CL_Sprite& sprite)
   : impl(new TileImpl())

Modified: trunk/lib/tile.hxx
===================================================================
--- trunk/lib/tile.hxx	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/lib/tile.hxx	2005-03-30 12:49:58 UTC (rev 517)
@@ -24,6 +24,7 @@
 #include <ClanLib/Display/sprite.h>
 #include <ClanLib/Display/pixel_buffer.h>
 #include "shared_ptr.hxx"
+#include "tile_provider.hxx"
 
 class TileImpl;
 
@@ -32,6 +33,8 @@
 class Tile
 {
 public:
+  Tile(const TileProvider& provider);
+  
   Tile(const CL_PixelBuffer& pixelbuffer);
 
   Tile(const CL_PixelBuffer& pixelbuffer,
@@ -49,6 +52,7 @@
       delete the pixelbuffer, the Tile will take care of that */
   CL_PixelBuffer get_pixelbuffer();
 
+  // FIXME: Document all those functions
   CL_Color   get_color();
   CL_Color   get_attribute_color();
 

Modified: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/netpanzer/gameobjects.rb	2005-03-30 12:49:58 UTC (rev 517)
@@ -83,7 +83,7 @@
 
       brush = TileBrush.new(width, height)
       brush.set_data(Range.new(start, start + (width*height)-1).to_a)
-      tilemap.draw_tile(brush, CL_Point.new(x(), y()))
+      tilemap.draw_tile(brush, CL_Point.new(x()-18, y()-6))
     end
   end
   
@@ -115,11 +115,6 @@
   class TileObject < GameObject
     def initialize(brushindex)
       @brushindex = brushindex
-      (start, width, height, @name) = $brushes[brushindex]
-      
-      # FIXME: Could be shared among all TileObjects
-      @brush = TileBrush.new(width, height)
-      @brush.set_data(Range.new(start, start + (width*height)-1).to_a)
     end
 
     def x()
@@ -131,18 +126,23 @@
     end
 
     def draw_to_tilemap(tilemap)
-      tilemap.draw_tile(@brush, CL_Point.new(x(), y()))
+      (start, width, height, @name) = $brushes[@brushindex]
+      
+      brush = TileBrush.new(width, height)
+      brush.set_data(Range.new(start, start + (width*height)-1).to_a)
+
+      tilemap.draw_tile(brush, CL_Point.new(x(), y()))
     end
 
     def get_sprite()
       sprite = make_sprite("sprites/#{@brushindex}.png")
-      sprite.set_scale(4.0, 4.0)
       return sprite
     end
 
     def TileObject.create(objmap, brushindex, x, y)
       obj = TileObject.new(brushindex)
-      sprite_obj = ObjMapSpriteObject.new(get_sprite(), CL_Pointf.new(x*32, y*32),
+      sprite_obj = ObjMapSpriteObject.new(make_sprite("sprites/#{brushindex}.png"),
+                                          CL_Pointf.new(x*32, y*32),
                                           make_metadata(obj))
       obj.data = sprite_obj
       objmap.add_object(sprite_obj.to_object)

Modified: trunk/netpanzer/level.rb
===================================================================
--- trunk/netpanzer/level.rb	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/netpanzer/level.rb	2005-03-30 12:49:58 UTC (rev 517)
@@ -47,14 +47,21 @@
     @editormap.set_data(self)
   end
 
+  def name()
+    return @data.get_name()
+  end
+
+  def name=(name)
+    @data.set_name(name)
+  end
+
   def load_optfile(filename)
     f = File.new(filename)
     count = /ObjectiveCount: ([0-9]+)/.match(f.readline().chop)[1].to_i
-    f.readline() # Skip empty line
     count.times{|i|
+      f.readline() # Skip empty line
       name = /Name: (.+)/.match(f.readline().chop)
       loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline().chop)
-      f.readline() # Skip empty line
       GameObjects::Outpost.create(@objects,
                                   name,
                                   loc[1].to_i, loc[2].to_i)
@@ -65,7 +72,6 @@
   def load_spnfile(filename)
     f = File.new(filename)
     count = /SpawnCount: ([0-9]+)/.match(f.readline().chop)[1].to_i
-    f.readline() # Skip empty line
     count.times{|i|
       loc  = /Location: ([0-9]+) ([0-9]+)/.match(f.readline().chop)
       GameObjects::SpawnPoint.create(@objects,
@@ -95,7 +101,7 @@
 
     f = open(filename, "w")
 
-    f.write("SpawnCount: %d\n\n" % spawnpoints.length)
+    f.write("SpawnCount: %d\n" % spawnpoints.length)
     spawnpoints.each {|obj|
       f.print("Location: %d %d\n" % [obj.x, obj.y])
     }
@@ -114,16 +120,37 @@
     end
   end
 
+  def activate(workspace)
+    $workspace.set_map(@editormap)
+    TilemapLayer.set_current(@data.get_tilemap())
+    ObjectLayer.set_current(@objects)
+  end
+
+
   def flatten()
+    # Converts all objects to the Tilemap
     @objects.get_objects().each { |obj|
       obj.get_data().draw_to_tilemap(@tilemap)
     }
   end
+  
+  def unflatten()
+    # Reconstructs objects from the Tilemap
+    data   = @tilemap.get_data()
+    width  = @tilemap.get_width()
+    height = @tilemap.get_height()
+    first_tiles = {}
+    $brushes.each_with_index{|i,index| first_tiles[i[0]] = index }
 
-  def activate(workspace)
-    $workspace.set_map(@editormap)
-    TilemapLayer.set_current(@data.get_tilemap())
-    ObjectLayer.set_current(@objects)
+    (0..height-1).each{|y|
+      (0..width-1).each{|x|
+        tile = data[width*y + x]
+        if tile != 0 && first_tiles.has_key?(tile) then
+          # Insert checking for dups here
+          GameObjects::TileObject.create(@objects, first_tiles[data[width*y + x]], x, y)
+        end
+      }
+    }
   end
 end
 

Modified: trunk/netpanzer/netpanzer.cxx
===================================================================
--- trunk/netpanzer/netpanzer.cxx	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/netpanzer/netpanzer.cxx	2005-03-30 12:49:58 UTC (rev 517)
@@ -21,7 +21,11 @@
 #include <sstream>
 #include <fstream>
 #include <ClanLib/Display/palette.h>
+#include <ClanLib/Display/sprite.h>
+#include <ClanLib/Display/sprite_description.h>
+#include <ClanLib/Display/Providers/provider_factory.h>
 #include "globals.hxx"
+#include "tile_provider.hxx"
 #include "tile.hxx"
 #include "tileset.hxx"
 #include "tilemap_layer.hxx"
@@ -260,6 +264,37 @@
   impl->description = description;
 }
 
+class NetPanzerTileProviderImpl
+{
+private:
+  int id;
+  CL_Sprite sprite;
+
+public:
+  NetPanzerTileProviderImpl(int id_)
+    : id(id_)
+  {    
+  }
+
+  CL_Sprite get_sprite()
+  {
+    if (sprite)
+      {
+        return sprite;
+      }
+    else
+      {
+        char str[1024];
+        sprintf(str, "netpanzertiles/tile%04d.png", id); 
+        
+        CL_SpriteDescription desc;
+        desc.add_frame(CL_ProviderFactory::load(str));
+        sprite = CL_Sprite(desc);
+        return sprite;
+      }
+  }
+};
+
 void load_netpanzer_tiles(Tileset tileset)
 {
   char str[1024];

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/netpanzer/netpanzer.rb	2005-03-30 12:49:58 UTC (rev 517)
@@ -28,8 +28,10 @@
 require "level.rb"
 require "gameobjects.rb"
 
+$screen = CL_Size.new(1024, 768)
+
 flexlay = Flexlay.new()
-flexlay.init()
+flexlay.init($screen.width, $screen.height)
 
 $config = Config.new()
 
@@ -39,18 +41,18 @@
 $editor = Editor.new()
 $gui = $editor.get_gui_manager()
 
-myrect = CL_Rect.new(CL_Point.new(0, 56), CL_Size.new(665, 488+56))
+myrect = CL_Rect.new(CL_Point.new(0, 56), CL_Size.new($screen.width-134-1, ($screen.height-112)+56))
 $editor_map = EditorMapComponent.new(myrect, $gui.get_component())
 $workspace  = Workspace.new(myrect.get_width(), myrect.get_height())
 $editor_map.set_workspace($workspace)
 
-$option_panel = Panel.new(CL_Rect.new(CL_Point.new(666, 56), CL_Size.new(134, 488+56)), $gui.get_component())
+$option_panel = Panel.new(CL_Rect.new(CL_Point.new($screen.width-134, 56), CL_Size.new(134, $screen.height-112+56)), $gui.get_component())
 
-$brushbox = CL_ListBox.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 488+56-128-9)), $option_panel)
+$brushbox = CL_ListBox.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, $screen.height-112+56-128-9)), $option_panel)
 $brushbox.show(false)
 
-$objectselector = ObjectSelector.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 488+56-128-9)),
-                                     42, 42, $option_panel)
+$objectselector = ObjectSelector.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, $screen.height-112+56-128-9)),
+                                     64, 64, $option_panel)
 
 $resources = CL_ResourceManager.new("netpanzersprites.xml")
 
@@ -60,7 +62,7 @@
                                           make_metadata(proc{GameObjects::SpawnPoint.new()})))
 
 $brushes.size.times {|i|
-  $objectselector.add_brush(ObjectBrush.new(make_sprite("sprites/#{i}.png"),
+  $objectselector.add_brush(ObjectBrush.new(make_sprite("thumbnails/#{i}.png"),
                                             make_metadata(proc{GameObjects::TileObject.new(i)})))
 }
 
@@ -116,15 +118,28 @@
 #   end
 end
 
-$startlevel = Level.new(256, 256)
-$startlevel.activate($workspace)
-connect($startlevel.editormap.sig_change(), proc{on_map_change})
+# $startlevel = Level.new(256, 256)
+# $startlevel.activate($workspace)
+# connect($startlevel.editormap.sig_change(), proc{on_map_change})
 
 def gui_level_save_as()
   $save_dialog.set_filename(File::dirname($save_dialog.get_filename()) + "/")
   $save_dialog.run(method(:netpanzer_save_level))
 end
 
+def gui_level_new()
+  dialog = GenericDialog.new("SecretArea Property Dialog", $gui.get_component())
+  dialog.add_string("Name: ", "New Level")
+  dialog.add_int("Width: ", 128)
+  dialog.add_int("Height: ", 128)
+  dialog.set_callback(proc{|name, width, height|
+                        level = Level.new(width, height)
+                        level.activate($workspace)
+                        level.name = name
+                        connect(level.editormap.sig_change(), proc{on_map_change})
+                      })
+end
+
 def gui_level_save()
   if $workspace.get_map().get_metadata().filename:
       $save_dialog.set_filename($workspace.get_map().get_metadata().filename)
@@ -139,7 +154,7 @@
   $load_dialog.run(method(:netpanzer_load_level))
 end
 
-$button_panel = ButtonPanel.new(0, 23, 800, 33, true, $gui.get_component)
+$button_panel = ButtonPanel.new(0, 23, $screen.width, 33, true, $gui.get_component)
 
 $button_panel.add_icon("../data/images/icons24/stock_new.png",
                        proc{ gui_level_new() })
@@ -270,6 +285,7 @@
 end
 
 menu = CL_Menu.new($gui.get_component())
+menu.add_item("File/New...", proc{gui_level_new})
 menu.add_item("File/Open...", proc{gui_level_load})
 menu.add_item("File/Save...", proc{gui_level_save})
 menu.add_item("File/Save As...", proc{gui_level_save_as})
@@ -304,8 +320,11 @@
 menu.add_item("Zoom/2:1 (200%) ", proc{ gui_set_zoom(2.0) })
 menu.add_item("Zoom/4:1 (400%) ", proc{ gui_set_zoom(4.0) })
 
+menu.add_item("Scripts/Flatten",  proc{ $workspace.get_map().get_data().flatten() })
+menu.add_item("Scripts/Unflatten",  proc{ $workspace.get_map().get_data().unflatten() })
+
 # minimap_panel = Panel(CL_Rect(CL_Point(0, 600-56), CL_Size(800-134, 56)), $gui.get_component())
-$minimap = Minimap.new($editor_map, CL_Rect.new(CL_Point.new(3, 488+56 - 128-3), CL_Size.new(128, 128)), $option_panel)
+$minimap = Minimap.new($editor_map, CL_Rect.new(CL_Point.new(3, ($screen.height-112)+56 - 128-3), CL_Size.new(128, 128)), $option_panel)
 
 $load_dialog = SimpleFileDialog.new("Load netPanzer Level", "Load", "Cancel", $gui.get_component())
 $load_dialog.set_filename($config.datadir + "maps/")
@@ -314,6 +333,8 @@
 
 set_tilemap_paint_tool()
 
+gui_level_new()
+
 # generate_sprites()
 $gui.run()
 

Modified: trunk/ruby/flexlay.rb
===================================================================
--- trunk/ruby/flexlay.rb	2005-03-30 12:43:32 UTC (rev 516)
+++ trunk/ruby/flexlay.rb	2005-03-30 12:49:58 UTC (rev 517)
@@ -140,8 +140,10 @@
   
   def run(func)
     connect(@ok_button.sig_clicked(), method(:on_ok))
+    connect(@inputbox.sig_return_pressed(), method(:on_ok))
     connect(@cancel_button.sig_clicked(), method(:on_cancel))
     @callback = func
+    @inputbox.set_focus()
     @window.show()
   end
   



From grumbel at sheep.berlios.de  Wed Mar 30 14:50:20 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 14:50:20 +0200
Subject: [Flexlay-commit] r518 - trunk/lib
Message-ID: <200503301250.j2UCoKrK028254@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 14:50:20 +0200 (Wed, 30 Mar 2005)
New Revision: 518

Added:
   trunk/lib/tile_provider.cxx
   trunk/lib/tile_provider.hxx
   trunk/lib/tile_provider_impl.hxx
Log:
- added flatten/unflatten to netpanzer
- added TileProvider

Added: trunk/lib/tile_provider.cxx
===================================================================
--- trunk/lib/tile_provider.cxx	2005-03-30 12:49:58 UTC (rev 517)
+++ trunk/lib/tile_provider.cxx	2005-03-30 12:50:20 UTC (rev 518)
@@ -0,0 +1,33 @@
+//  $Id$
+//
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+//
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "tile_provider.hxx"
+
+TileProvider::TileProvider(TileProviderImpl* impl_)
+  : impl(impl_)
+{
+}
+
+CL_Sprite
+TileProvider::get_sprite()
+{
+  return impl->get_sprite();
+}
+
+/* EOF */

Added: trunk/lib/tile_provider.hxx
===================================================================
--- trunk/lib/tile_provider.hxx	2005-03-30 12:49:58 UTC (rev 517)
+++ trunk/lib/tile_provider.hxx	2005-03-30 12:50:20 UTC (rev 518)
@@ -0,0 +1,49 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_TILE_PROVIDER_IMPL_HXX
+#define HEADER_TILE_PROVIDER_IMPL_HXX
+
+#include <ClanLib/Display/sprite.h>
+#include "shared_ptr.hxx"
+
+class TileProviderImpl;
+
+/** TileProvider provides a flexible way to perform load-on-demand for Tiles */
+class TileProvider
+{
+public:
+  TileProvider(TileProviderImpl* impl);
+
+  CL_Sprite get_sprite();
+private:
+  SharedPtr<TileProviderImpl> impl;
+};
+
+class TileProviderImpl
+{
+public:
+  TileProviderImpl() {}
+
+  virtual CL_Sprite get_sprite() =0;
+};
+
+#endif
+
+/* EOF */

Added: trunk/lib/tile_provider_impl.hxx
===================================================================
--- trunk/lib/tile_provider_impl.hxx	2005-03-30 12:49:58 UTC (rev 517)
+++ trunk/lib/tile_provider_impl.hxx	2005-03-30 12:50:20 UTC (rev 518)
@@ -0,0 +1,34 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_TILE_PROVIDER_IMPL_HXX
+#define HEADER_TILE_PROVIDER_IMPL_HXX
+
+/**
+ */
+class TileProviderImpl
+{
+private:
+public:
+  TileProviderImpl();
+};
+
+#endif
+
+/* EOF */



From grumbel at sheep.berlios.de  Wed Mar 30 16:10:51 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 16:10:51 +0200
Subject: [Flexlay-commit] r519 - trunk/supertux
Message-ID: <200503301410.j2UEApm3032117@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 16:10:48 +0200 (Wed, 30 Mar 2005)
New Revision: 519

Modified:
   trunk/supertux/data.rb
Log:
- fixed type

Modified: trunk/supertux/data.rb
===================================================================
--- trunk/supertux/data.rb	2005-03-30 12:50:20 UTC (rev 518)
+++ trunk/supertux/data.rb	2005-03-30 14:10:48 UTC (rev 519)
@@ -43,7 +43,7 @@
     x = get_value_from_tree(["x", "_"], sexpr, 0)
     y = get_value_from_tree(["y", "_"], sexpr, 0)
     
-    obj = create_gameobject(objmap, object, CL_Point.new(x, y), sexpr)
+    obj = create_gameobject(objmap, object, CL_Pointf.new(x, y), sexpr)
   else
     print "Error: Couldn't resolve object type: ", name, "\n"
     print "Sector: Unhandled tag: ", name, "\n"



From grumbel at sheep.berlios.de  Wed Mar 30 19:45:19 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 19:45:19 +0200
Subject: [Flexlay-commit] r520 - in trunk: lib netpanzer
Message-ID: <200503301745.j2UHjJO8014469@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 19:45:18 +0200 (Wed, 30 Mar 2005)
New Revision: 520

Removed:
   trunk/netpanzer/netp.act
Modified:
   trunk/lib/tile.cxx
   trunk/lib/tile.hxx
   trunk/lib/tile_provider.cxx
   trunk/lib/tile_provider.hxx
   trunk/lib/tile_provider_impl.hxx
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/netpanzer.cxx
   trunk/netpanzer/netpanzer.hxx
   trunk/netpanzer/netpanzer.i
   trunk/netpanzer/netpanzer.rb
Log:
- tiles are now loaded from netpanzer directory

Modified: trunk/lib/tile.cxx
===================================================================
--- trunk/lib/tile.cxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/lib/tile.cxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -25,11 +25,14 @@
 #include <ClanLib/Display/Providers/provider_factory.h>
 #include <iostream>
 #include "string_converter.hxx"
+#include "tile_provider.hxx"
 #include "tile.hxx"
 
 class TileImpl
 {
 public:
+  TileProvider   provider;
+
   CL_Sprite      sprite;
   CL_PixelBuffer pixelbuffer;
 
@@ -43,6 +46,7 @@
       and such */
   CL_Color  attribute_color;
 
+  // FIXME: old windstille stuff
   unsigned char colmap[8];
 
   std::string filename;
@@ -51,7 +55,8 @@
 Tile::Tile(const TileProvider& provider)
   : impl(new TileImpl())
 {
-  
+  impl->provider  = provider;
+  impl->has_color = false; 
 }
 
 Tile::Tile(const CL_PixelBuffer& pixelbuffer,
@@ -113,41 +118,59 @@
     }
   else
     {
-      CL_SpriteDescription desc;
-      desc.add_frame(CL_PixelBuffer(get_pixelbuffer()));
-      impl->sprite = CL_Sprite(desc);
-      
+      if (impl->provider)
+        {
+          impl->sprite = impl->provider.get_sprite();
+        }
+      else
+        {
+          CL_SpriteDescription desc;
+          desc.add_frame(CL_PixelBuffer(get_pixelbuffer()));
+          impl->sprite = CL_Sprite(desc);
+        }
+
       return impl->sprite;
     }
 }
 
 CL_PixelBuffer
 Tile::get_pixelbuffer()
-{	
-  try {
-    if (impl->pixelbuffer)
-      {
-        return impl->pixelbuffer;
-      }
-    else 
-      {
-        if (has_suffix(impl->filename, ".png") || has_suffix(impl->filename, ".jpg"))
-          {
-            impl->pixelbuffer = CL_PixelBuffer(CL_ProviderFactory::load(impl->filename));
+{
+  if (impl->pixelbuffer)
+    {
+      return impl->pixelbuffer;
+    }
+  else 
+    {
+      if (impl->provider)
+        {
+          impl->pixelbuffer = impl->provider.get_pixelbuffer();
+          return impl->pixelbuffer;
+        }
+      else
+        {
+          // FIXME: Move all this into a special provider
+
+          try {
+            if (has_suffix(impl->filename, ".png") || has_suffix(impl->filename, ".jpg"))
+              {
+                impl->pixelbuffer = CL_PixelBuffer(CL_ProviderFactory::load(impl->filename));
+              }
+            else
+              {
+                //CL_SpriteDescription descr(impl->filename, resources);
+                //impl->pixelbuffer = CL_PixelBuffer(*(descr.get_frames().begin()->first));
+                assert(0);
+              }
+            return impl->pixelbuffer;
+          
+          } catch(CL_Error& err) {
+            std::cout << "CL_Error: " << err.message << std::endl;
+            std::cout << "          filename = " << impl->filename << std::endl;
+            return CL_PixelBuffer();
           }
-        else
-          {
-            //CL_SpriteDescription descr(impl->filename, resources);
-            //impl->pixelbuffer = CL_PixelBuffer(*(descr.get_frames().begin()->first));
-            assert(0);
-          }
-        return impl->pixelbuffer;
-      }
-  } catch(CL_Error& err) {
-    std::cout << "CL_Error: " << err.message << std::endl;
-    std::cout << "          filename = " << impl->filename << std::endl;
-    return CL_PixelBuffer();
-  }
+        }
+    }
 }
 
 CL_Color

Modified: trunk/lib/tile.hxx
===================================================================
--- trunk/lib/tile.hxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/lib/tile.hxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -24,9 +24,9 @@
 #include <ClanLib/Display/sprite.h>
 #include <ClanLib/Display/pixel_buffer.h>
 #include "shared_ptr.hxx"
-#include "tile_provider.hxx"
 
 class TileImpl;
+class TileProvider;
 
 /** A Tile is a surface or sprite together with meta information for
     collision (aka colmap), walkability or such. */

Modified: trunk/lib/tile_provider.cxx
===================================================================
--- trunk/lib/tile_provider.cxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/lib/tile_provider.cxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -17,6 +17,7 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
+#include "tile_provider_impl.hxx"
 #include "tile_provider.hxx"
 
 TileProvider::TileProvider(TileProviderImpl* impl_)
@@ -25,9 +26,15 @@
 }
 
 CL_Sprite
-TileProvider::get_sprite()
+TileProvider::get_sprite() const
 {
   return impl->get_sprite();
 }
 
+CL_PixelBuffer
+TileProvider::get_pixelbuffer() const
+{
+  return impl->get_pixelbuffer();
+}
+
 /* EOF */

Modified: trunk/lib/tile_provider.hxx
===================================================================
--- trunk/lib/tile_provider.hxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/lib/tile_provider.hxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -17,10 +17,11 @@
 //  along with this program; if not, write to the Free Software
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
-#ifndef HEADER_TILE_PROVIDER_IMPL_HXX
-#define HEADER_TILE_PROVIDER_IMPL_HXX
+#ifndef HEADER_TILE_PROVIDER_HXX
+#define HEADER_TILE_PROVIDER_HXX
 
 #include <ClanLib/Display/sprite.h>
+#include <ClanLib/Display/pixel_buffer.h>
 #include "shared_ptr.hxx"
 
 class TileProviderImpl;
@@ -29,21 +30,17 @@
 class TileProvider
 {
 public:
+  TileProvider() {}
   TileProvider(TileProviderImpl* impl);
 
-  CL_Sprite get_sprite();
+  CL_Sprite      get_sprite() const;
+  CL_PixelBuffer get_pixelbuffer() const;
+
+  operator bool() const { return impl.get(); }
 private:
   SharedPtr<TileProviderImpl> impl;
 };
 
-class TileProviderImpl
-{
-public:
-  TileProviderImpl() {}
-
-  virtual CL_Sprite get_sprite() =0;
-};
-
 #endif
 
 /* EOF */

Modified: trunk/lib/tile_provider_impl.hxx
===================================================================
--- trunk/lib/tile_provider_impl.hxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/lib/tile_provider_impl.hxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -20,13 +20,16 @@
 #ifndef HEADER_TILE_PROVIDER_IMPL_HXX
 #define HEADER_TILE_PROVIDER_IMPL_HXX
 
-/**
- */
+#include <ClanLib/Display/sprite.h>
+#include <ClanLib/Display/pixel_buffer.h>
+
 class TileProviderImpl
 {
-private:
 public:
-  TileProviderImpl();
+  TileProviderImpl() {}
+
+  virtual CL_Sprite      get_sprite()      const =0;
+  virtual CL_PixelBuffer get_pixelbuffer() const =0;
 };
 
 #endif

Modified: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/netpanzer/gameobjects.rb	2005-03-30 17:45:18 UTC (rev 520)
@@ -152,13 +152,4 @@
   end
 end
 
-class Config
-  attr_accessor :datadir, :recent_files
-
-  def initialize()
-    @datadir      = "./"
-    @recent_files = []
-  end
-end
-
 # EOF #

Deleted: trunk/netpanzer/netp.act
===================================================================
(Binary files differ)

Modified: trunk/netpanzer/netpanzer.cxx
===================================================================
--- trunk/netpanzer/netpanzer.cxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/netpanzer/netpanzer.cxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -20,25 +20,125 @@
 #include <iostream>
 #include <sstream>
 #include <fstream>
+#include <ClanLib/core.h>
 #include <ClanLib/Display/palette.h>
 #include <ClanLib/Display/sprite.h>
+#include <ClanLib/Display/pixel_format.h>
+#include <ClanLib/Display/pixel_format_type.h>
 #include <ClanLib/Display/sprite_description.h>
 #include <ClanLib/Display/Providers/provider_factory.h>
 #include "globals.hxx"
 #include "tile_provider.hxx"
+#include "tile_provider_impl.hxx"
 #include "tile.hxx"
 #include "tileset.hxx"
 #include "tilemap_layer.hxx"
 #include "editor_map.hxx"
 #include "netpanzer.hxx"
 
-CL_Palette netpanzer_load_palette(const char* filename)
+NetPanzerData* NetPanzerData::instance_ = 0;
+
+
+class NetPanzerTileProviderImpl : public TileProviderImpl
 {
+private:
+  int id;
+  mutable CL_Sprite sprite;
+  mutable CL_PixelBuffer buffer;
+
+public:
+  NetPanzerTileProviderImpl(int id_)
+    : id(id_)
+  {    
+  }
+
+  virtual ~NetPanzerTileProviderImpl()
+  {
+  }
+
+  CL_Sprite get_sprite() const
+  {
+    if (sprite)
+      {
+        return sprite;
+      }
+    else
+      {
+        CL_SpriteDescription desc;
+        desc.add_frame(get_pixelbuffer());
+        sprite = CL_Sprite(desc);
+        
+        return sprite;
+      }
+  }
+
+  CL_PixelBuffer get_pixelbuffer() const
+  {
+    if (buffer)
+      {
+        return buffer;
+      }
+    else
+      {	
+        // FIXME: ClanLibs indexed handling seems broken, so we do
+        // the conversion ourself
+        const CL_Palette& palette = NetPanzerData::instance()->get_palette();
+        unsigned char* data = NetPanzerData::instance()->get_tiledata() + (32*32) * id;
+        buffer = CL_PixelBuffer(32, 32, 32*3, CL_PixelFormat::rgb888);
+        buffer.lock();
+        unsigned char* target = static_cast<unsigned char*>(buffer.get_data());
+
+        for(int i = 0; i < 32*32; ++i)
+          {
+            target[3*i+0] = palette[data[i]].get_blue();
+            target[3*i+1] = palette[data[i]].get_green();
+            target[3*i+2] = palette[data[i]].get_red();
+          }
+        buffer.unlock();
+                
+        return buffer;
+      }
+  }
+};
+
+NetPanzerData::NetPanzerData() 
+{
+}
+
+void
+NetPanzerData::init(const std::string& datadir_)
+{
+  datadir = datadir_;
+  palette = load_palette(datadir + "/" + "wads/netp.act");
+  tileset = load_tileset(datadir + "/" + "wads/summer12mb.tls");
+}
+
+const Tileset&
+NetPanzerData::get_tileset() const
+{
+  return tileset;
+}
+
+const CL_Palette&
+NetPanzerData::get_palette() const
+{
+  return palette;
+}
+
+unsigned char*
+NetPanzerData::get_tiledata() const
+{
+  return tiledata;
+}
+
+CL_Palette
+NetPanzerData::load_palette(const std::string& filename)
+{
   CL_Palette palette;
   unsigned char color_array[256 * 3];
-
-  std::ifstream in(filename);
-
+  
+  std::ifstream in(filename.c_str());
+  
   if (!in)
     {
       std::cout << "Couldn't load palette" << std::endl;
@@ -57,6 +157,92 @@
   return palette;
 }
 
+Tileset
+NetPanzerData::load_tileset(const std::string& filename)
+{
+  unsigned char	netp_id_header[64];
+  unsigned short	version;
+  unsigned short	width;
+  unsigned short	height;
+  unsigned short	tile_count;
+  unsigned char	raw_palette[768];
+
+  std::ifstream file(filename.c_str());  
+
+  if (!file)
+    {
+      std::cout << "Couldn't load " << filename << std::endl;
+      return Tileset();
+    }
+  else
+    {
+      file.read(reinterpret_cast<char*>(netp_id_header), sizeof(netp_id_header));
+      file.read(reinterpret_cast<char*>(&version), sizeof(version));
+      file.read(reinterpret_cast<char*>(&width), sizeof(width));
+      file.read(reinterpret_cast<char*>(&height), sizeof(height));
+      file.read(reinterpret_cast<char*>(&tile_count), sizeof(tile_count));
+      file.read(reinterpret_cast<char*>(raw_palette), sizeof(raw_palette));
+
+      std::cout << "ID:      " << netp_id_header << std::endl;
+      std::cout << "Version: " << version << std::endl;
+      std::cout << "Width:   " << width << std::endl;
+      std::cout << "Height:  " << height << std::endl;
+      std::cout << "Count:   " << tile_count << std::endl;
+
+      NetPanzerTileHeader* tile_headers = new NetPanzerTileHeader[tile_count];
+
+      file.read(reinterpret_cast<char*>(tile_headers), 
+                sizeof(NetPanzerTileHeader)*tile_count);
+
+      cl_uint32 tilesize = width * height;
+      // FIXME: Delete this somewhere!
+      unsigned char* tiledata = new unsigned char[tilesize*tile_count];
+      file.read(reinterpret_cast<char*>(tiledata), tilesize*tile_count);
+      file.close();
+
+      if (0)
+        {
+          // FIXME: The palette in the netpanzer 'summer12mb.tls' file
+          // is either broken or otherwise corrupt, so we ignore it
+          // and use the seperate palette file 'netp.act' which works
+          // fine.
+
+          // Convert palette in native format
+          CL_Palette palette;
+          for(int i = 0; i < 256; ++i)
+            {
+              palette.colors[i].set_red  (raw_palette[3*i + 0]);
+              palette.colors[i].set_green(raw_palette[3*i + 1]);
+              palette.colors[i].set_blue (raw_palette[3*i + 2]);
+              palette.colors[i].set_alpha(255);
+
+              if (0)
+                {
+                  std::cout << "Palette: "
+                            << (int)raw_palette[3*i + 0] << " "
+                            << (int)raw_palette[3*i + 1] << " "
+                            << (int)raw_palette[3*i + 2]
+                            << std::endl;
+                }
+            }
+          
+          NetPanzerData::instance()->palette  = palette;
+        }
+
+      NetPanzerData::instance()->tiledata = tiledata;
+      
+      Tileset tileset(width);
+
+      for(int i = 0; i < tile_count; ++i)
+        {
+          Tile* tile = new Tile(TileProvider(new NetPanzerTileProviderImpl(i)));
+          tileset.add_tile(i, tile);
+          delete tile;
+        }
+      return tileset;
+    }
+}
+
 unsigned char find_nearest_color(const CL_Palette& palette, const CL_Color& rgb)
 { // Copyright (C) 1998 Pyrosoft Inc. (www.pyrosoftgames.com), Matthew Bogue
   float bestDist = 10000000.0f;
@@ -167,6 +353,7 @@
     
   std::ofstream out(filename.c_str());
 
+  // FIXME: Not endian clean
   out.write(reinterpret_cast<char*>(&netp_id_header), sizeof(netp_id_header));
   out.write(reinterpret_cast<char*>(&id), sizeof(short));
   out.write(reinterpret_cast<char*>(&name), sizeof(name));
@@ -188,14 +375,12 @@
             sizeof(unsigned short)*vec.size());
 
   // Generate thumbnail
-  CL_Palette palette = netpanzer_load_palette("netp.act");
-  
   std::vector<unsigned char> thumbnail(x_size * y_size);
   for(int i = 0; i < int(thumbnail.size()); ++i)
     {
       Tile* tile = impl->tileset.create((*field)[i]);
       if (tile)
-        thumbnail[i] = find_nearest_color(palette, tile->get_color());
+        thumbnail[i] = find_nearest_color(NetPanzerData::instance()->get_palette(), tile->get_color());
     }
 
   out.write(reinterpret_cast<char*>(&(*thumbnail.begin())), 
@@ -264,47 +449,4 @@
   impl->description = description;
 }
 
-class NetPanzerTileProviderImpl
-{
-private:
-  int id;
-  CL_Sprite sprite;
-
-public:
-  NetPanzerTileProviderImpl(int id_)
-    : id(id_)
-  {    
-  }
-
-  CL_Sprite get_sprite()
-  {
-    if (sprite)
-      {
-        return sprite;
-      }
-    else
-      {
-        char str[1024];
-        sprintf(str, "netpanzertiles/tile%04d.png", id); 
-        
-        CL_SpriteDescription desc;
-        desc.add_frame(CL_ProviderFactory::load(str));
-        sprite = CL_Sprite(desc);
-        return sprite;
-      }
-  }
-};
-
-void load_netpanzer_tiles(Tileset tileset)
-{
-  char str[1024];
-  for(int i = 0; i <= 11960; ++i)
-    {
-      sprintf(str, "netpanzertiles/tile%04d.png", i);
-      Tile* tile = new Tile(str, CL_Color(255,   0,   0, 128));
-      tileset.add_tile(i, tile);
-      delete tile;
-    }
-}
-
 /* EOF */

Modified: trunk/netpanzer/netpanzer.hxx
===================================================================
--- trunk/netpanzer/netpanzer.hxx	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/netpanzer/netpanzer.hxx	2005-03-30 17:45:18 UTC (rev 520)
@@ -21,14 +21,53 @@
 #define HEADER_SCRIPTING_NETPANZER_HXX
 
 #include <string>
+#include <ClanLib/Display/palette.h>
 #include "../lib/tileset.hxx"
 #include "../lib/tilemap_layer.hxx"
 #include "../lib/shared_ptr.hxx"
 
-void load_netpanzer_tiles(Tileset tileset);
+void load_netpanzer_tileset(Tileset tileset, const char* filename);
 
 class NetPanzerFileStructImpl;
 
+struct NetPanzerTileHeader
+{
+public:
+  char	attrib;
+  char	move_value;
+  char	avg_color;
+};
+
+class NetPanzerData
+{
+private:
+  static NetPanzerData* instance_;
+public:
+  static NetPanzerData* instance() 
+  {
+    if (instance_)
+      return (instance_);
+    else
+      return (instance_ = new NetPanzerData());
+  }
+
+private:
+  std::string    datadir;
+  CL_Palette     palette;
+  Tileset        tileset;
+  unsigned char* tiledata;
+  
+public:
+  NetPanzerData();
+  void init(const std::string& datadir_);
+  const CL_Palette& get_palette() const;
+  const Tileset&    get_tileset() const;
+  unsigned char*    get_tiledata() const;
+
+  CL_Palette load_palette(const std::string& filename);
+  Tileset    load_tileset(const std::string& filename);
+};
+
 class NetPanzerFileStruct
 {
 public:

Modified: trunk/netpanzer/netpanzer.i
===================================================================
--- trunk/netpanzer/netpanzer.i	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/netpanzer/netpanzer.i	2005-03-30 17:45:18 UTC (rev 520)
@@ -10,4 +10,5 @@
 %import  "../lib/flexlay_wrap.i"
 %include "netpanzer.hxx"
 
+
 // EOF //

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-30 14:10:48 UTC (rev 519)
+++ trunk/netpanzer/netpanzer.rb	2005-03-30 17:45:18 UTC (rev 520)
@@ -28,16 +28,27 @@
 require "level.rb"
 require "gameobjects.rb"
 
-$screen = CL_Size.new(1024, 768)
+$screen  = CL_Size.new(1024, 768)
 
 flexlay = Flexlay.new()
 flexlay.init($screen.width, $screen.height)
 
+class Config
+  attr_accessor :datadir, :recent_files
+
+  def initialize()
+    @datadir      = "./"
+    @recent_files = []
+  end
+end
+
 $config = Config.new()
 
-$tileset = Tileset.new(32)
-load_netpanzer_tiles($tileset)
+$datadir = "/home/ingo/games/netpanzer-0.1.5"
+NetPanzerData::instance().init($datadir)
 
+$tileset = NetPanzerData::instance().get_tileset()
+
 $editor = Editor.new()
 $gui = $editor.get_gui_manager()
 



From grumbel at sheep.berlios.de  Wed Mar 30 20:18:54 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 20:18:54 +0200
Subject: [Flexlay-commit] r521 - trunk/supertux
Message-ID: <200503301818.j2UIIser016286@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 20:18:52 +0200 (Wed, 30 Mar 2005)
New Revision: 521

Modified:
   trunk/supertux/gui.rb
Log:
- increased size of object selector

Modified: trunk/supertux/gui.rb
===================================================================
--- trunk/supertux/gui.rb	2005-03-30 17:45:18 UTC (rev 520)
+++ trunk/supertux/gui.rb	2005-03-30 18:18:52 UTC (rev 521)
@@ -35,7 +35,7 @@
     @tileselector.set_tiles($tileset.get_tiles())
     @tileselector.show(false)
     
-    @objectselector = ObjectSelector.new(CL_Rect.new(0, 0, 128, 256), 42, 42, @selector_window)
+    @objectselector = ObjectSelector.new(CL_Rect.new(0, 0, 128, 552), 42, 42, @selector_window)
     @objectselector.show(true)
 
     # connect_v1_ObjMapObject



From grumbel at sheep.berlios.de  Wed Mar 30 20:29:47 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 20:29:47 +0200
Subject: [Flexlay-commit] r522 - trunk/lib
Message-ID: <200503301829.j2UITlcK017135@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 20:29:46 +0200 (Wed, 30 Mar 2005)
New Revision: 522

Modified:
   trunk/lib/editor_map.cxx
Log:
- init the bounding rect

Modified: trunk/lib/editor_map.cxx
===================================================================
--- trunk/lib/editor_map.cxx	2005-03-30 18:18:52 UTC (rev 521)
+++ trunk/lib/editor_map.cxx	2005-03-30 18:29:46 UTC (rev 522)
@@ -64,7 +64,8 @@
   impl->foreground_color = CL_Color(255, 80, 255);
   impl->modified = false;
   impl->serial = 0;
-  impl->has_bounding_rect = 0;
+  impl->has_bounding_rect = false;
+  impl->bounding_rect = CL_Rect(0,0,0,0);
 }
 
 void



From matzebraun at sheep.berlios.de  Wed Mar 30 20:37:55 2005
From: matzebraun at sheep.berlios.de (Matthias Braun at BerliOS)
Date: Wed, 30 Mar 2005 20:37:55 +0200
Subject: [Flexlay-commit] r523 - trunk/supertux
Message-ID: <200503301837.j2UIbtdg017523@sheep.berlios.de>

Author: matzebraun
Date: 2005-03-30 20:37:53 +0200 (Wed, 30 Mar 2005)
New Revision: 523

Modified:
   trunk/supertux/TODO
   trunk/supertux/data.rb
   trunk/supertux/gameobj.rb
   trunk/supertux/sector.rb
   trunk/supertux/supertux.rb
Log:
- Added more supertux objects: background, particle systems, bell, unstable_tile
- Improved the parsing functions a bit



Modified: trunk/supertux/TODO
===================================================================
--- trunk/supertux/TODO	2005-03-30 18:29:46 UTC (rev 522)
+++ trunk/supertux/TODO	2005-03-30 18:37:53 UTC (rev 523)
@@ -13,7 +13,6 @@
  - moving platforms + path
  - camera path 
  - automatic backup of files
- - reset points
  - get rid of make_metadat, get_ruby_object in SuperTux code
  - faster tile-loading (load on demand, pixelbuffer cache)
  - make controlpoints unzoomable
@@ -23,6 +22,9 @@
  - objects need to have visible text-lables attached to them (name of
    spawnpoints, etc.)
  - sexpr based config file, no evil eval games
+ - all pseudo object without position (background, particle-system) should be
+   placed beside each other beginning at 0, -32. (Currently they're all placed
+   at 0,0)
 
 New Object Types:
 =================
@@ -51,5 +53,6 @@
 ====
 
  - switching to the current sector resets visible properties
+ - sometime the tilemap is alot huger than the level
 
 # EOF #

Modified: trunk/supertux/data.rb
===================================================================
--- trunk/supertux/data.rb	2005-03-30 18:29:46 UTC (rev 522)
+++ trunk/supertux/data.rb	2005-03-30 18:37:53 UTC (rev 523)
@@ -1,36 +1,48 @@
 $game_objects = [
-  ["money", "images/shared/jumpy-left-middle-0.png", "sprite",
-    proc{|data| BadGuy.new("money")}],
+  ["jumpy", "images/shared/jumpy-left-middle-0.png", "sprite",
+    proc{|data, sexpr| BadGuy.new("jumpy")}],
   ["snowball", "images/shared/snowball-left-0.png", "sprite",
-    proc{|data| BadGuy.new("snowball")}],
+    proc{|data, sexpr| BadGuy.new("snowball")}],
   ["mriceblock", "images/shared/mriceblock-left-0.png", "sprite",
-    proc{|data| BadGuy.new("mriceblock")}],
+    proc{|data, sexpr| BadGuy.new("mriceblock")}],
   ["mrbomb", "images/shared/mrbomb-left-0.png", "sprite",
-    proc{|data| BadGuy.new("mrbomb")}],
+    proc{|data, sexpr| BadGuy.new("mrbomb")}],
   ["flame", "images/shared/flame-0.png", "sprite",
-    proc{|data| BadGuy.new("flame")}], 
+    proc{|data, sexpr| BadGuy.new("flame")}], 
   ["stalactite", "images/shared/stalactite.png", "sprite",
-    proc{|data| BadGuy.new("stalactite")}],
+    proc{|data, sexpr| BadGuy.new("stalactite")}],
   ["fish", "images/shared/fish-left-0.png", "sprite",
-    proc{|data| BadGuy.new("fish")}],
+    proc{|data, sexpr| BadGuy.new("fish")}],
   ["flyingsnowball", "images/shared/flyingsnowball-left-0.png", "sprite",
-    proc{|data| BadGuy.new("flyingsnowball")}],
+    proc{|data, sexpr| BadGuy.new("flyingsnowball")}],
   ["bouncingsnowball", "images/shared/bouncingsnowball-left-0.png", "sprite",
-    proc{|data| BadGuy.new("bouncingsnowball")}],
+    proc{|data, sexpr| BadGuy.new("bouncingsnowball")}],
   ["spiky", "images/shared/spiky-left-0.png", "sprite",
-    proc{|data| BadGuy.new("spiky")}],
-  ["playerspawn", "images/shared/spawnpoint.png", "sprite",
-    proc{|data| SpawnPoint.new(data)}],
+    proc{|data, sexpr| BadGuy.new("spiky")}],
   ["spawnpoint", "images/shared/spawnpoint.png", "sprite",
-    proc{|data| SpawnPoint.new(data)}],
+    proc{|data, sexpr| SpawnPoint.new(data)}],
   ["door", "images/shared/door-1.png", "sprite",
-    proc{|data| Door.new(data)}],
+    proc{|data, sexpr| Door.new(data)}],
   ["trampoline", "images/shared/trampoline-1.png", "sprite",
-    proc{|data| BadGuy.new("trampoline")}],
+    proc{|data, sexpr| BadGuy.new("trampoline")}],
+  ["bell", "images/shared/bell/bell-m.png", "sprite",
+    proc{|data, sexpr| SimpleObject.new("bell")}],
+  ["rock", "images/tilesets/block11.png", "sprite",
+	proc{|data, sexpr| SimpleObject.new("rock")}],
+  ["unstable_tile", "images/shared/unstable_tile.png", "sprite",
+    proc{|data, sexpr| SimpleTileObject.new(data, "unstable_tile")}],
   ["secretarea", "images/shared/secretarea.png", "rect",
     proc{|data, sexpr| SecretArea.new(data, sexpr)}],
   ["sequencetrigger", "images/shared/sequencetrigger.png", "rect",
-    proc{|data, sexpr| SequenceTrigger.new(data, sexpr)}]
+    proc{|data, sexpr| SequenceTrigger.new(sexpr)}],
+  ["background", "images/editor/background.png", "sprite",
+	proc{|data, sexpr| Background.new(sexpr)}],
+  ["particles-snow", "images/editor/snow.png", "sprite",
+    proc{|data, sexpr| ParticleSystem.new("snow", sexpr)}],
+  ["particles-clouds", "images/editor/clouds.png", "sprite",
+    proc{|data, sexpr| ParticleSystem.new("clouds", sexpr)}],
+  ["particles-rain", "images/editor/rain.png", "sprite",
+    proc{|data, sexpr| ParticleSystem.new("rain", sexpr)}],
 ]
 
 def create_gameobject_from_data(objmap, name, sexpr)
@@ -43,10 +55,10 @@
     x = get_value_from_tree(["x", "_"], sexpr, 0)
     y = get_value_from_tree(["y", "_"], sexpr, 0)
     
-    obj = create_gameobject(objmap, object, CL_Pointf.new(x, y), sexpr)
+    create_gameobject(objmap, object, CL_Pointf.new(x, y), sexpr)
   else
     print "Error: Couldn't resolve object type: ", name, "\n"
-    print "Sector: Unhandled tag: ", name, "\n"
+	print "Sector: Unhandled tag: ", name, "\n"
   end
 end
 
@@ -56,7 +68,7 @@
     
   when "sprite" 
     obj = ObjMapSpriteObject.new(make_sprite($datadir + data[1]), pos, make_metadata(nil))
-    obj.to_object.set_metadata(make_metadata(data[3].call(obj)))
+    obj.to_object.set_metadata(make_metadata(data[3].call(obj, sexpr)))
     
   when "rect"
     obj = ObjMapRectObject.new(CL_Rect.new(CL_Point.new(pos.x.to_i, pos.y.to_i), CL_Size.new(64, 64)),

Modified: trunk/supertux/gameobj.rb
===================================================================
--- trunk/supertux/gameobj.rb	2005-03-30 18:29:46 UTC (rev 522)
+++ trunk/supertux/gameobj.rb	2005-03-30 18:37:53 UTC (rev 523)
@@ -1,6 +1,6 @@
 class GameObj
   def property_dialog()
-    print "No PropertyDialog Implemented for type: ", self.class(), "\n"
+    print "Object ", self.class, " has no properties\n"
   end
 end
 
@@ -45,7 +45,6 @@
     @data     = data
     @sequence = get_value_from_tree(["sequence", "_"], sexpr, "")
     @data.set_color(CL_Color.new(255, 0, 0, 128))
-    
 
     x  = get_value_from_tree(["x", "_"],  sexpr, 0)
     y  = get_value_from_tree(["y", "_"],  sexpr, 0)
@@ -88,7 +87,7 @@
   attr_accessor :name
   attr_reader   :data
 
-  def initialize(data)
+  def initialize(data, sexpr = [])
     @data = data
     @name = "start"
     connect_v1_ObjMapObject(data.to_object.sig_move(), method(:on_move))
@@ -116,6 +115,107 @@
   end
 end
 
+class SimpleObject<GameObj
+  def initialize(type)
+    @type = type
+  end
+
+  def save(f, obj)
+    pos = obj.get_pos()
+    f.write("       (%s (x %d) (y %d))\n" % [@type, pos.x, pos.y])
+  end  
+end
+
+class SimpleTileObject<GameObj
+  def initialize(data, type, sexpr = [])
+    @type = type
+    @data = data
+    connect_v1_ObjMapObject(@data.to_object.sig_move(), method(:on_move))
+    on_move(data)
+  end
+
+  def on_move(data)
+    pos = @data.to_object.get_pos()    
+    pos.x = (((pos.x+16)/32).to_i)*32
+    pos.y = (((pos.y+16)/32).to_i)*32
+    @data.to_object.set_pos(pos)       
+  end
+
+  def save(f, obj)
+    pos = obj.get_pos()
+    f.write("       (%s (x %d) (y %d))\n" % [@type, pos.x, pos.y])
+  end  
+end
+
+class ParticleSystem<GameObj
+  def initialize(type, sexpr = [])
+	@type = type
+	@layer = get_value_from_tree(["layer", "_"], sexpr, -1)
+  end
+
+  def save(f, obj)
+	f.write("       (particles-%s\n" % [@type])
+	if(@layer != -1)
+      f.write("         (layer %d)\n" % [@layer])
+	f.write("       )\n")
+	end
+  end
+
+  def property_dialog()
+    dialog = GenericDialog.new("%s-ParticleSystem Property Dialog" % [@type],
+			$gui.get_component())
+    dialog.add_int("Layer: ", @layer)
+    dialog.set_callback(proc{|layer| 
+                          @layer = layer
+                        })
+  end
+end
+
+class Background<GameObj
+  attr_accessor :message
+  attr_accessor :speed
+  attr_accessor :layer
+
+  def initialize(sexpr = [])
+	@image = get_value_from_tree(["image", "_"], sexpr, "")
+	@speed = get_value_from_tree(["speed", "_"], sexpr, 1.0)
+	@layer = get_value_from_tree(["layer", "_"], sexpr, -1)
+  end
+
+  def save(f, obj)
+    f.write("       (background\n")
+	f.write("         (image \"%s\")\n" % [@image])
+	f.write("         (speed %f)\n" % [@speed])
+	if(@layer != -1)
+	  f.write("         (layer %d)\n" % [@layer])
+	end
+	f.write("       )\n")
+  end
+
+  def property_dialog()
+    dialog = GenericDialog.new("Background Property Dialog", $gui.get_component())
+    dialog.add_string("Image: ", @image)
+	dialog.add_float("Speed: ", @speed)
+	dialog.add_int("Layer: ", @layer)
+	dialog.set_callback(proc{|image, speed|
+						  @image = image
+						  @speed = speed
+						  @layer = layer
+						})
+  end
+end
+
+class UnimplementedObject<GameObj
+  def initialize(sexpr = [])
+	@sexpr = sexpr
+  end
+
+  def save(f)
+	f.write("           (sexpr %s)\n" % [@sexpr])
+	# TODO
+  end
+end
+
 class Door<GameObj
   attr_accessor :sector, :spawnpoint
   attr_reader   :data

Modified: trunk/supertux/sector.rb
===================================================================
--- trunk/supertux/sector.rb	2005-03-30 18:29:46 UTC (rev 522)
+++ trunk/supertux/sector.rb	2005-03-30 18:37:53 UTC (rev 523)
@@ -1,7 +1,7 @@
 class Sector
   parent    = nil
   name      = nil
-  song      = nil
+  music     = nil
   gravity   = 10.0
   
   width  = nil
@@ -11,12 +11,14 @@
   interactive = nil
   foreground  = nil
   
-  objects   = nil
+  objects	  = nil
 #  sketch    = nil
   editormap = nil
 
+  cameramode = "normal"
+
   attr_reader   :objects, :background, :interactive, :foreground, :parent, :width, :height
-  attr_accessor :name, :song, :gravity
+  attr_accessor :name, :music, :gravity
   
   def initialize(parent)
     @parent = parent
@@ -36,7 +38,7 @@
 
   def new_from_size(name, width, height)
     @name = name
-    @song = "<No Song>"
+    @music = ""
     @gravity = 10.0
     
     @width  = width
@@ -45,7 +47,7 @@
     @foreground  = TilemapLayer.new($tileset, @width, @height)
     @interactive = TilemapLayer.new($tileset, @width, @height)
     @background  = TilemapLayer.new($tileset, @width, @height)       
-    @objects = ObjectLayer.new()
+    @objects	 = ObjectLayer.new()
     # @sketch  = SketchLayer.new()
 
     @editormap = EditorMap.new()
@@ -61,8 +63,8 @@
   end
 
   def load_v1(data)
-    @name = "<No Name>"
-    @song = "supertux-1.ogg"
+    @name = "main"
+    @music = ""
     @gravity = 10.0
     
     @width  = get_value_from_tree(["width", "_"], data, 20)
@@ -117,11 +119,11 @@
   
   def load_v2(data)
     @name = "<No Name>"
-    @song = "supertux-1.ogg"
+    @music = ""
     @gravity = 10.0
     
-    @width  = 20
-    @height = 15
+    @width  = 0
+    @height = 0
 
     @background  = nil
     @interactive = nil
@@ -136,9 +138,10 @@
         @name = data[0]
       elsif name == "gravity"
         @gravity = data[0]
-      elsif name == "playerspawn"
-        print "playerspawn unhandled"
+	  elsif name == "music"
+		@music = data[0]
       elsif name == "tilemap"
+		layer   = get_value_from_tree(["layer", "_"], data, "interactive")
         width   = get_value_from_tree(["width", "_"],  data, 20)
         height  = get_value_from_tree(["height", "_"], data, 15)
         solid   = get_value_from_tree(["solid", "_"],  data, false)
@@ -150,31 +153,32 @@
           @interactive = tilemap
           @width       = width
           @height      = height
-        elsif not(@background)
+        elsif layer == "background"
           @background = tilemap
-        elsif not(@foreground)
-          @foreground = tilemap
+        elsif layer == "foreground"
+		  @foreground = tilemap
         else
-          print "Error: Duplicate tilemap in levelfile\n"
+          print "Flexlay doesn't handle tilemap layer '", layer, "'.\n"
         end
-      elsif name == "background"
-        print "background unhandled\n"
+	  elsif name == "camera"
+		@cameramode = "normal"
+		# TODO...
       else
         puts "Creating #{name}..."
-        create_gameobject_from_data(@objects, name, data)
+		create_gameobject_from_data(@objects, name, data)
       end
     end
     
     print "Tileset: ", $tileset, " ", width, " ", height, "\n"
 
+	if(@interactive == nil || @width == 0 || @height == 0)
+	  throw "No interactive tilemap in sector '", @name , "'.\n"
+	end
+
     if (@background == nil)
       @background = TilemapLayer.new($tileset, @width, @height)
     end
 
-    if (@interactive == nil)
-      @interactive = TilemapLayer.new($tileset, @width, @height)
-    end
-    
     if (@foreground == nil)
       @foreground = TilemapLayer.new($tileset, @width, @height)
     end
@@ -218,9 +222,9 @@
 
   def save(f)   
     f.write("    (name  \"%s\")\n"  % @name)
-    f.write("    (width  %d)\n"  % @width)
-    f.write("    (height  %d)\n" % @height)   
-    f.write("    (music  \"%s\")\n" % @song)
+    if(@music != "")
+        f.write("    (music  \"%s\")\n" % @music)
+    end
     f.write("    (gravity %f)\n" % @gravity)
     
     # FIXME: Make me configurable
@@ -228,27 +232,26 @@
             "                (speed 0.5))\n")
    
     save_tilemap(f, @background,  "background")
-    save_tilemap(f, @interactive, "main", :solid)
+    save_tilemap(f, @interactive, "interactive", :solid)
     save_tilemap(f, @foreground,  "foreground")
 #    save_strokelayer(f, @sketch)
 
     f.write("    (camera\n")
-    f.write("      (mode \"normal\")\n")
-    f.write("      (path\n")
+    f.write("      (mode \"%s\")\n" % [@cameramode])
+#    f.write("      (path\n")
+#    @objects.get_objects().each {|obj|
+#      pathnode = obj.get_metadata()
+#      if (pathnode.is_a?(PathNode))
+#        f.write("       (point (x %d) (y %d) (speed 1))\n" % obj.get_pos().x, obj.get_pos().y)
+#      end
+#    }
+#    f.write("      )")
+	f.write("    )\n\n")
 
-    @objects.get_objects().each {|obj|
-      pathnode = obj.get_metadata()
-      if (pathnode.is_a?(PathNode))
-        f.write("       (point (x %d) (y %d) (speed 1))\n" % obj.get_pos().x, obj.get_pos().y)
-      end
-    }
-
-    f.write("    ))\n\n")
-
     for obj in @objects.get_objects()
       # FIXME: not sure why I need get_ruby_object() here
-      badguy = get_ruby_object(obj.get_metadata())
-      badguy.save(f, obj)
+      object = get_ruby_object(obj.get_metadata())
+      object.save(f, obj)
     end
   end
 end

Modified: trunk/supertux/supertux.rb
===================================================================
--- trunk/supertux/supertux.rb	2005-03-30 18:29:46 UTC (rev 522)
+++ trunk/supertux/supertux.rb	2005-03-30 18:37:53 UTC (rev 523)
@@ -90,7 +90,7 @@
 
 $config  = Config.new()
 if !$datadir then
-  $datadir = File.expand_path("~/cvs/supertux/supertux/data/")+"/"
+  $datadir = File.expand_path("~/projects/supertux/data/")+"/"
 end
 
 require "data.rb"



From matzebraun at sheep.berlios.de  Wed Mar 30 20:40:38 2005
From: matzebraun at sheep.berlios.de (Matthias Braun at BerliOS)
Date: Wed, 30 Mar 2005 20:40:38 +0200
Subject: [Flexlay-commit] r524 - trunk/supertux
Message-ID: <200503301840.j2UIecTs018035@sheep.berlios.de>

Author: matzebraun
Date: 2005-03-30 20:40:36 +0200 (Wed, 30 Mar 2005)
New Revision: 524

Modified:
   trunk/supertux/data.rb
Log:
moved some editor images around

Modified: trunk/supertux/data.rb
===================================================================
--- trunk/supertux/data.rb	2005-03-30 18:37:53 UTC (rev 523)
+++ trunk/supertux/data.rb	2005-03-30 18:40:36 UTC (rev 524)
@@ -19,7 +19,7 @@
     proc{|data, sexpr| BadGuy.new("bouncingsnowball")}],
   ["spiky", "images/shared/spiky-left-0.png", "sprite",
     proc{|data, sexpr| BadGuy.new("spiky")}],
-  ["spawnpoint", "images/shared/spawnpoint.png", "sprite",
+  ["spawnpoint", "images/editor/spawnpoint.png", "sprite",
     proc{|data, sexpr| SpawnPoint.new(data)}],
   ["door", "images/shared/door-1.png", "sprite",
     proc{|data, sexpr| Door.new(data)}],
@@ -31,9 +31,9 @@
 	proc{|data, sexpr| SimpleObject.new("rock")}],
   ["unstable_tile", "images/shared/unstable_tile.png", "sprite",
     proc{|data, sexpr| SimpleTileObject.new(data, "unstable_tile")}],
-  ["secretarea", "images/shared/secretarea.png", "rect",
+  ["secretarea", "images/editor/secretarea.png", "rect",
     proc{|data, sexpr| SecretArea.new(data, sexpr)}],
-  ["sequencetrigger", "images/shared/sequencetrigger.png", "rect",
+  ["sequencetrigger", "images/editor/sequencetrigger.png", "rect",
     proc{|data, sexpr| SequenceTrigger.new(sexpr)}],
   ["background", "images/editor/background.png", "sprite",
 	proc{|data, sexpr| Background.new(sexpr)}],



From matzebraun at sheep.berlios.de  Wed Mar 30 21:20:09 2005
From: matzebraun at sheep.berlios.de (Matthias Braun at BerliOS)
Date: Wed, 30 Mar 2005 21:20:09 +0200
Subject: [Flexlay-commit] r525 - in trunk: ruby supertux
Message-ID: <200503301920.j2UJK905020535@sheep.berlios.de>

Author: matzebraun
Date: 2005-03-30 21:20:02 +0200 (Wed, 30 Mar 2005)
New Revision: 525

Modified:
   trunk/ruby/sexpr.rb
   trunk/supertux/gameobj.rb
   trunk/supertux/gui.rb
   trunk/supertux/level.rb
   trunk/supertux/sector.rb
Log:
- Improved parsing of version 1 supertux maps
- Changed sexpr to return translatable strings as normal strings
- Fixed Spawnpoint not parsing name parameter



Modified: trunk/ruby/sexpr.rb
===================================================================
--- trunk/ruby/sexpr.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/ruby/sexpr.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -42,7 +42,12 @@
     if spec == []
       return tree
     elsif spec == ['_']
-      return tree[0]
+	  # is it a translatable string?
+	  if(tree[0].instance_of?(Array) and tree[0][0] == "_")
+		return tree[0][1]
+	  else
+        return tree[0]
+	  end
     elsif tree == []
       return default
     else

Modified: trunk/supertux/gameobj.rb
===================================================================
--- trunk/supertux/gameobj.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/gameobj.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -89,7 +89,7 @@
 
   def initialize(data, sexpr = [])
     @data = data
-    @name = "start"
+    @name = get_value_from_tree(["name", "_"],  sexpr, "main")
     connect_v1_ObjMapObject(data.to_object.sig_move(), method(:on_move))
     on_move(data)
   end
@@ -157,8 +157,8 @@
 	f.write("       (particles-%s\n" % [@type])
 	if(@layer != -1)
       f.write("         (layer %d)\n" % [@layer])
+	end
 	f.write("       )\n")
-	end
   end
 
   def property_dialog()

Modified: trunk/supertux/gui.rb
===================================================================
--- trunk/supertux/gui.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/gui.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -487,12 +487,12 @@
     dialog = GenericDialog.new("Edit Sector", @gui.get_component())
     
     dialog.add_string("Name: ",   level.current_sector.name)
-    dialog.add_string("Music: ",   level.current_sector.song)
+    dialog.add_string("Music: ",   level.current_sector.music)
     dialog.add_float("Gravity: ", level.current_sector.gravity)
     
-    dialog.set_block() { |name, song, gravity|
+    dialog.set_block() { |name, music, gravity|
       level.current_sector.name = name
-      level.current_sector.song = song
+      level.current_sector.music = music
       level.current_sector.gravity = gravity
     }
   end

Modified: trunk/supertux/level.rb
===================================================================
--- trunk/supertux/level.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/level.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -92,9 +92,11 @@
     f.write(";; Generated by Flexlay Editor\n" +
                                                 "(supertux-level\n")
     f.write("  (version 2)\n")
-    f.write("  (name   \"%s\")\n" % @name)
+    f.write("  (name   (_ \"%s\"))\n" % @name)
     f.write("  (author \"%s\")\n" % @author)
-    f.write("  (time   %d)\n" % @time)   
+	if(@time != 999)
+      f.write("  (time   %d)\n" % @time)
+	end
     
     for sector in @sectors
       f.write("  (sector\n")

Modified: trunk/supertux/sector.rb
===================================================================
--- trunk/supertux/sector.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/sector.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -64,8 +64,8 @@
 
   def load_v1(data)
     @name = "main"
-    @music = ""
-    @gravity = 10.0
+    @music = get_value_from_tree(["music", "_"], data, "")
+    @gravity = get_value_from_tree(["gravity", "_"], data, 10.0)
     
     @width  = get_value_from_tree(["width", "_"], data, 20)
     @height = get_value_from_tree(["height", "_"], data, 15)
@@ -78,36 +78,42 @@
     
     @background  = TilemapLayer.new($tileset, @width, @height)
     @background.set_data(get_value_from_tree(["background-tm"], data, []))
-    
+
+	@cameramode = "normal"
+
     @objects = ObjectLayer.new()
     for i in get_value_from_tree(["objects"], data, [])
-      type = i[0]
-      x = get_value_from_tree(["x", "_"], i[1..-1], 0)
-      y = get_value_from_tree(["y", "_"], i[1..-1], 0)
-      print("Object position: ", type, " ", x, " ", y, "\n")
-      object = $game_objects.find{|x| x[0] == type}
-      print "Resolved object: ", object, "\n"
-      if object
-        # fixme
-        #        @objects.add_object(ObjMapSpriteObject.new(make_sprite($datadir + object[1]),
-        #                                                   CL_Point.new(x, y),
-        #                                                   make_metadata(BadGuy.new(object[0]))).to_object())
-      else
-        print "Error: Couldn't resolve object type: ", type, "\n"
-      end
+      (name, odata) = i[0], i[1..-1]
+	  print "Create object: ", name, "\n"
+      create_gameobject_from_data(@objects, name, odata)
     end
-    
-# FIXME: doesn't work
-#     for i in get_value_from_tree(["reset-points"], data, [])
-#       type = i[0]
-#       x = get_value_from_tree(["x", "_"], i[1..-1], [])
-#       y = get_value_from_tree(["y", "_"], i[1..-1], [])
-#       object = $game_objects.find("resetpoint")
-#       @objects.add_object(ObjMapSpriteObject.new(make_sprite($datadir + object[1]),
-#                                                  CL_Point.new(x, y),
-#                                                  make_metadata(BadGuy.new(object[0]))).to_object())
-#     end
 
+	start_pos_x = get_value_from_tree(["start_pos_x", "_"], data, 0)
+	start_pos_y = get_value_from_tree(["start_pos_y", "_"], data, 0)
+	sexpr = [["name", "main"], ["x", start_pos_x], ["y", start_pos_y]]
+	create_gameobject_from_data(@objects, "spawnpoint", sexpr)
+
+	background = get_value_from_tree(["background", "_"], data, "")
+	if(background != "")
+	  sexpr = [["image", background], ["speed", 0.5]]
+	  create_gameobject_from_data(@objects, "background", sexpr)
+	end
+
+	partsys = get_value_from_tree(["particle_system", "_"], data, "")
+	if(partsys == "snow")
+	  sexpr = []
+	  create_gameobject_from_data(@objects, "particles-snow", sexpr)
+	elsif(partsys == "rain")
+	  sexpr = []
+	  create_gameobject_from_data(@objects, "particles-rain", sexpr)
+	elsif(partsys == "clouds")
+	  sexpr = []
+	  create_gameobject_from_data(@objects, "particles-clouds", sexpr)
+	elsif(partsys == "")
+	elsif
+	  print "Unknown particle system type '", partsys, "'\n"
+	end
+	    
     @editormap = EditorMap.new()
     @editormap.add_layer(@background.to_layer())
     @editormap.add_layer(@interactive.to_layer())



From matzebraun at sheep.berlios.de  Wed Mar 30 22:41:30 2005
From: matzebraun at sheep.berlios.de (Matthias Braun at BerliOS)
Date: Wed, 30 Mar 2005 22:41:30 +0200
Subject: [Flexlay-commit] r526 - trunk/supertux
Message-ID: <200503302041.j2UKfUiK026517@sheep.berlios.de>

Author: matzebraun
Date: 2005-03-30 22:41:29 +0200 (Wed, 30 Mar 2005)
New Revision: 526

Modified:
   trunk/supertux/data.rb
   trunk/supertux/gameobj.rb
Log:
added implementation of InfoBlock object

Modified: trunk/supertux/data.rb
===================================================================
--- trunk/supertux/data.rb	2005-03-30 19:20:02 UTC (rev 525)
+++ trunk/supertux/data.rb	2005-03-30 20:41:29 UTC (rev 526)
@@ -31,6 +31,8 @@
 	proc{|data, sexpr| SimpleObject.new("rock")}],
   ["unstable_tile", "images/shared/unstable_tile.png", "sprite",
     proc{|data, sexpr| SimpleTileObject.new(data, "unstable_tile")}],
+  ["infoblock", "images/editor/infoblock.png", "sprite",
+	proc{|data, sexpr| InfoBlock.new(data, sexpr)}],
   ["secretarea", "images/editor/secretarea.png", "rect",
     proc{|data, sexpr| SecretArea.new(data, sexpr)}],
   ["sequencetrigger", "images/editor/sequencetrigger.png", "rect",
@@ -71,6 +73,7 @@
     obj.to_object.set_metadata(make_metadata(data[3].call(obj, sexpr)))
     
   when "rect"
+	print "NewRect", pos.x, " -", pos.y, "\n"
     obj = ObjMapRectObject.new(CL_Rect.new(CL_Point.new(pos.x.to_i, pos.y.to_i), CL_Size.new(64, 64)),
                                CL_Color.new(0, 0, 255, 128), make_metadata(nil))
     obj.to_object.set_metadata(make_metadata(data[3].call(obj, sexpr)))

Modified: trunk/supertux/gameobj.rb
===================================================================
--- trunk/supertux/gameobj.rb	2005-03-30 19:20:02 UTC (rev 525)
+++ trunk/supertux/gameobj.rb	2005-03-30 20:41:29 UTC (rev 526)
@@ -147,6 +147,40 @@
   end  
 end
 
+class InfoBlock<GameObj
+  attr_accessor :message
+
+  def initialize(data, sexpr = [])
+	@data = data
+	@message = get_value_from_tree(["message", "_"], sexpr, "")
+	connect_v1_ObjMapObject(@data.to_object.sig_move(), method(:on_move))
+	on_move(data)
+  end
+
+  def on_move(data)
+    pos = @data.to_object.get_pos()    
+    pos.x = (((pos.x+16)/32).to_i)*32
+    pos.y = (((pos.y+16)/32).to_i)*32
+    @data.to_object.set_pos(pos)       
+  end
+
+  def save(f, obj)
+	pos = obj.get_pos()
+	f.write("      (infoblock (x %d) (y %d)\n" % [pos.x, pos.y]);
+	f.write("        (message (_ \"%s\"))\n" % [@message]);
+	f.write("      )\n");
+  end
+
+  def property_dialog()
+    dialog = GenericDialog.new("InfoBox Property Dialog" % [@type],
+			$gui.get_component())
+    dialog.add_string("Message: ", @message)
+    dialog.set_callback(proc{|message| 
+                          @message = message
+                        })
+  end
+end 
+
 class ParticleSystem<GameObj
   def initialize(type, sexpr = [])
 	@type = type



From matzebraun at sheep.berlios.de  Wed Mar 30 22:53:44 2005
From: matzebraun at sheep.berlios.de (Matthias Braun at BerliOS)
Date: Wed, 30 Mar 2005 22:53:44 +0200
Subject: [Flexlay-commit] r527 - trunk/supertux
Message-ID: <200503302053.j2UKri6W027238@sheep.berlios.de>

Author: matzebraun
Date: 2005-03-30 22:53:43 +0200 (Wed, 30 Mar 2005)
New Revision: 527

Modified:
   trunk/supertux/data.rb
   trunk/supertux/gameobj.rb
   trunk/supertux/sector.rb
Log:
fixed a bug in the door object

Modified: trunk/supertux/data.rb
===================================================================
--- trunk/supertux/data.rb	2005-03-30 20:41:29 UTC (rev 526)
+++ trunk/supertux/data.rb	2005-03-30 20:53:43 UTC (rev 527)
@@ -22,7 +22,7 @@
   ["spawnpoint", "images/editor/spawnpoint.png", "sprite",
     proc{|data, sexpr| SpawnPoint.new(data)}],
   ["door", "images/shared/door-1.png", "sprite",
-    proc{|data, sexpr| Door.new(data)}],
+    proc{|data, sexpr| Door.new(data, sexpr)}],
   ["trampoline", "images/shared/trampoline-1.png", "sprite",
     proc{|data, sexpr| BadGuy.new("trampoline")}],
   ["bell", "images/shared/bell/bell-m.png", "sprite",

Modified: trunk/supertux/gameobj.rb
===================================================================
--- trunk/supertux/gameobj.rb	2005-03-30 20:41:29 UTC (rev 526)
+++ trunk/supertux/gameobj.rb	2005-03-30 20:53:43 UTC (rev 527)
@@ -257,7 +257,7 @@
   def initialize(data, sexpr = [])
     @data = data
     @sector     = get_value_from_tree(["sector", "_"], sexpr, "main")
-    @spawnpoint = get_value_from_tree(["spawnpoint", "_"], sexpr, "start")
+    @spawnpoint = get_value_from_tree(["spawnpoint", "_"], sexpr, "main")
 
     connect_v1_ObjMapObject(@data.to_object.sig_move(), method(:on_move))
     on_move(data)
@@ -274,9 +274,6 @@
     pos = obj.get_pos()
     f.write("       (door\n")
     f.write("         (x %d) (y %d)" % [pos.x, pos.y])
-    # FIXME: not so sure if width/height make sense
-    f.write("         (width  32)\n")
-    f.write("         (height 64)\n")
     f.write("         (sector \"%s\")\n" % @sector)
     f.write("         (spawnpoint \"%s\")\n" % @spawnpoint)
     f.write("         )\n")

Modified: trunk/supertux/sector.rb
===================================================================
--- trunk/supertux/sector.rb	2005-03-30 20:41:29 UTC (rev 526)
+++ trunk/supertux/sector.rb	2005-03-30 20:53:43 UTC (rev 527)
@@ -1,21 +1,21 @@
 class Sector
-  parent    = nil
-  name      = nil
-  music     = nil
-  gravity   = 10.0
+  @parent    = nil
+  @name      = nil
+  @music     = nil
+  @gravity   = 10.0
   
-  width  = nil
-  height = nil
+  @width  = nil
+  @height = nil
   
-  background  = nil
-  interactive = nil
-  foreground  = nil
+  @background  = nil
+  @interactive = nil
+  @foreground  = nil
   
-  objects	  = nil
+  @objects	  = nil
 #  sketch    = nil
-  editormap = nil
+  @editormap = nil
 
-  cameramode = "normal"
+  @cameramode = "normal"
 
   attr_reader   :objects, :background, :interactive, :foreground, :parent, :width, :height
   attr_accessor :name, :music, :gravity
@@ -127,6 +127,7 @@
     @name = "<No Name>"
     @music = ""
     @gravity = 10.0
+	@cameramode = "normal"
     
     @width  = 0
     @height = 0



From grumbel at sheep.berlios.de  Thu Mar 31 00:16:02 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Thu, 31 Mar 2005 00:16:02 +0200
Subject: [Flexlay-commit] r528 - trunk/supertux
Message-ID: <200503302216.j2UMG2Am008685@sheep.berlios.de>

Author: grumbel
Date: 2005-03-31 00:16:02 +0200 (Thu, 31 Mar 2005)
New Revision: 528

Modified:
   trunk/supertux/gameobj.rb
   trunk/supertux/gui.rb
Log:
- fixed placement bug of rect object

Modified: trunk/supertux/gameobj.rb
===================================================================
--- trunk/supertux/gameobj.rb	2005-03-30 20:53:43 UTC (rev 527)
+++ trunk/supertux/gameobj.rb	2005-03-30 22:16:02 UTC (rev 528)
@@ -12,11 +12,13 @@
 
     @message = get_value_from_tree(["message", "_"], sexpr, "")
 
-    x  = get_value_from_tree(["x", "_"],  sexpr, 0)
-    y  = get_value_from_tree(["y", "_"],  sexpr, 0)
+    x  = get_value_from_tree(["x", "_"],  sexpr, nil)
+    y  = get_value_from_tree(["y", "_"],  sexpr, nil)
     width  = get_value_from_tree(["width", "_"],  sexpr, 64)
     height = get_value_from_tree(["height", "_"], sexpr, 64)
-    @data.set_rect(CL_Rect.new(CL_Point.new(x, y), CL_Size.new(width, height)))
+    if x != nil and y != nil then
+      @data.set_rect(CL_Rect.new(CL_Point.new(x, y), CL_Size.new(width, height)))
+    end
   end
 
   def save(f, obj)
@@ -46,11 +48,13 @@
     @sequence = get_value_from_tree(["sequence", "_"], sexpr, "")
     @data.set_color(CL_Color.new(255, 0, 0, 128))
 
-    x  = get_value_from_tree(["x", "_"],  sexpr, 0)
-    y  = get_value_from_tree(["y", "_"],  sexpr, 0)
+    x  = get_value_from_tree(["x", "_"],  sexpr, nil)
+    y  = get_value_from_tree(["y", "_"],  sexpr, nil)
     width  = get_value_from_tree(["width", "_"],  sexpr, 64)
     height = get_value_from_tree(["height", "_"], sexpr, 64)
-    @data.set_rect(CL_Rect.new(CL_Point.new(x, y), CL_Size.new(width, height)))
+    if x != nil and y != nil then
+      @data.set_rect(CL_Rect.new(CL_Point.new(x, y), CL_Size.new(width, height)))
+    end
   end
 
   def save(f, obj)

Modified: trunk/supertux/gui.rb
===================================================================
--- trunk/supertux/gui.rb	2005-03-30 20:53:43 UTC (rev 527)
+++ trunk/supertux/gui.rb	2005-03-30 22:16:02 UTC (rev 528)
@@ -46,29 +46,6 @@
                                                 make_metadata(object)))
     }
 
-    # @colorpicker = ColorPicker.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 128)),
-    #                                    @selector_window)
-    #
-    #     connect_v1_Color(@colorpicker.sig_color_change(), proc{|color|
-    #                        $sketch_stroke_tool.set_color(color)
-    #                      })
-
-#     @size_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 150), CL_Size.new(128, 16)), @selector_window)
-#     @size_slider.set_range(0.01, 2.0) # FIXME: using 0 size brush makes clanlib crashi
-#     @size_slider.set_value(1.0)
-#     connect_v1_float(@size_slider.sig_on_change, proc{|value|
-#                        # puts "Value: #{value}"
-#                        $sketch_stroke_tool.set_size(value)
-#                      })
-
-#     @zoom_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 182), CL_Size.new(128, 16)), @selector_window)
-#     @zoom_slider.set_range(0.25, 10.0) # FIXME: using 0 size brush makes clanlib crashi
-#     @zoom_slider.set_value(1.0)
-#     connect_v1_float(@zoom_slider.sig_on_change, proc{|value|
-#                        # puts "Value: #{value}"
-#                        self.gui_set_zoom(value)
-#                      })
-
     create_button_panel()
 
     # FIXME: Having position in the Menus here is EXTREMLY ugly



From grumbel at sheep.berlios.de  Sun Mar 20 01:43:44 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Sun, 20 Mar 2005 01:43:44 +0100
Subject: [Flexlay-commit] r497 - in trunk: lib paint
Message-ID: <200503200043.j2K0hiPP012352@sheep.berlios.de>

Author: grumbel
Date: 2005-03-20 01:43:21 +0100 (Sun, 20 Mar 2005)
New Revision: 497

Added:
   trunk/lib/onion_skin_layer.cxx
   trunk/lib/onion_skin_layer.hxx
   trunk/lib/sprite_brush.cxx
   trunk/lib/sprite_brush.hxx
   trunk/paint/TODO
   trunk/paint/animation.rb
   trunk/paint/gui.rb
   trunk/paint/image.rb
Modified:
   trunk/lib/SConstruct
   trunk/lib/bitmap_layer.cxx
   trunk/lib/editor_map.cxx
   trunk/lib/editor_map.hxx
   trunk/lib/flexlay_wrap.i
   trunk/lib/layer.cxx
   trunk/lib/layer.hxx
   trunk/lib/layer_impl.hxx
   trunk/lib/object_layer.cxx
   trunk/lib/objmap_control_point.cxx
   trunk/lib/objmap_control_point.hxx
   trunk/lib/objmap_object.cxx
   trunk/lib/objmap_object.hxx
   trunk/lib/objmap_object_impl.hxx
   trunk/lib/objmap_path_node.cxx
   trunk/lib/objmap_rect_object.cxx
   trunk/lib/objmap_rect_object.hxx
   trunk/lib/objmap_sprite_object.cxx
   trunk/lib/sketch_layer.cxx
   trunk/lib/tilemap_layer.cxx
   trunk/lib/tilemap_layer.hxx
   trunk/lib/workspace.cxx
   trunk/paint/paint.rb
Log:
- added primitive animation support
- added sprite brush support again

Modified: trunk/lib/SConstruct
===================================================================
--- trunk/lib/SConstruct	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/SConstruct	2005-03-20 00:43:21 UTC (rev 497)
@@ -75,7 +75,8 @@
     'directory_view.cxx',
     'fonts.cxx',
     'minimap.cxx',
-    'meta_data.cxx', 
+    'meta_data.cxx',
+    'onion_skin_layer.cxx',
     'object_layer.cxx',
     'object_add_command.cxx',
     'object_brush.cxx',
@@ -102,6 +103,7 @@
     'stroke.cxx',
     'stroke_drawer.cxx',
     'sprite_stroke_drawer.cxx',
+    'sprite_brush.cxx',
 #    'marker_stroke_drawer.cxx',
     'slider.cxx', 
     'scrollbar.cxx',

Modified: trunk/lib/bitmap_layer.cxx
===================================================================
--- trunk/lib/bitmap_layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/bitmap_layer.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -85,7 +85,7 @@
     delete canvas;
   }
 
-  void draw(EditorMapComponent* parent) 
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
   {
     assert(canvas);
 
@@ -94,10 +94,10 @@
       return;
 
     surface.set_blend_func(blend_one, blend_one_minus_src_alpha);
-    surface.draw(0, 0);
+    surface.draw(0, 0, gc);
 
     if (BitmapLayer::current()->impl.get() == this)
-      CL_Display::draw_rect(get_bounding_rect(), CL_Color(155, 155, 155, 100));
+      gc->draw_rect(get_bounding_rect(), CL_Color(155, 155, 155, 100));
   }
 
   CL_Rect get_bounding_rect() { 

Modified: trunk/lib/editor_map.cxx
===================================================================
--- trunk/lib/editor_map.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/editor_map.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -18,6 +18,7 @@
 //  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 
 #include <iostream>
+#include <assert.h>
 #include <ClanLib/Core/core_iostream.h>
 #include <ClanLib/Display/display.h>
 #include <ClanLib/Display/keys.h>
@@ -67,31 +68,37 @@
 }
 
 void
-EditorMap::add_layer(const Layer& layer)
+EditorMap::add_layer(const Layer& layer, int pos)
 {
-  impl->layers.push_back(layer);
+  assert(pos == -1 || (pos >= 0 && pos < int(impl->layers.size())));
+
+  if (pos == -1) // insert at last pos
+    impl->layers.push_back(layer);
+  else
+    impl->layers.insert(impl->layers.begin() + pos, layer);
+
   impl->serial += 1;
 }
 
 void
-EditorMap::draw (EditorMapComponent* parent)
+EditorMap::draw (EditorMapComponent* parent, CL_GraphicContext* gc)
 {
   CL_Rect rect = get_bounding_rect();
 
   if (rect != CL_Rect(0,0,0,0))
     {
-      CL_Display::fill_rect(rect, impl->background_color);
-      CL_Display::draw_rect(rect, impl->foreground_color);
+      gc->fill_rect(rect, impl->background_color);
+      gc->draw_rect(rect, impl->foreground_color);
     }
   else
     {
-      CL_Display::clear(impl->background_color);
+      gc->clear(impl->background_color);
     }
 
   for(EditorMapImpl::Layers::iterator i = impl->layers.begin(); i != impl->layers.end(); ++i)
-    (*i).draw(parent);
+    (*i).draw(parent, gc);
   
-  CL_Display::flush();
+  gc->flush();
 }
 
 bool

Modified: trunk/lib/editor_map.hxx
===================================================================
--- trunk/lib/editor_map.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/editor_map.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -41,9 +41,10 @@
 public:
   EditorMap();
 
-  void draw(EditorMapComponent* parent);
+  /** FIXME: EditorMapComponent parameter shouldn't really be here */
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc);
 
-  void add_layer(const Layer& layer);
+  void add_layer(const Layer& layer, int pos = -1);
 
   bool is_modified() const;
   void set_unmodified();
@@ -59,6 +60,10 @@
 
   bool has_bounding_rect() const;
   CL_Rect get_bounding_rect();
+
+  /** Set the bounding rect for this map, if the given rect is
+      CL_Rect() the bounding rect will be calculated automatically
+      from the content of the map */
   void    set_bounding_rect(const CL_Rect& rect);
 
   void set_background_color(const CL_Color& color);

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/flexlay_wrap.i	2005-03-20 00:43:21 UTC (rev 497)
@@ -35,6 +35,7 @@
 #include "layer.hxx"
 #include "tilemap_layer.hxx"
 #include "object_layer.hxx"
+#include "onion_skin_layer.hxx"
 
 #include "minimap.hxx"
 #include "editor_map.hxx"
@@ -66,6 +67,7 @@
 #include "brushmask.hxx"
 #include "brush.hxx"
 #include "generated_brush.hxx"
+#include "sprite_brush.hxx"
 
 #include "colorpicker.hxx"
 #include "slider.hxx"
@@ -151,6 +153,7 @@
 %include "layer.hxx"
 %include "tilemap_layer.hxx"
 %include "object_layer.hxx"
+%include "onion_skin_layer.hxx"
 
 %include "editor_map.hxx"
 %include "workspace.hxx"
@@ -181,6 +184,7 @@
 %include "brushmask.hxx"
 %include "brush.hxx"
 %include "generated_brush.hxx"
+%include "sprite_brush.hxx"
 
 %include "colorpicker.hxx"
 %include "slider.hxx"

Modified: trunk/lib/layer.cxx
===================================================================
--- trunk/lib/layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/layer.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -37,20 +37,20 @@
 }
 
 void
-Layer::draw(EditorMapComponent* parent) 
+Layer::draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
 { 
   if (impl.get())
     {
       if (impl->pos.x != 0 || impl->pos.y != 0)
         {
-          CL_Display::push_modelview();
-          CL_Display::add_translate(impl->pos.x, impl->pos.y);
-          impl->draw(parent);    
-          CL_Display::pop_modelview();
+          gc->push_modelview();
+          gc->add_translate(impl->pos.x, impl->pos.y);
+          impl->draw(parent, gc);
+          gc->pop_modelview();
         }
       else
         {
-          impl->draw(parent);
+          impl->draw(parent, gc);
         }
     }
 }

Modified: trunk/lib/layer.hxx
===================================================================
--- trunk/lib/layer.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/layer.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -21,6 +21,7 @@
 #define HEADER_LAYER_HXX
 
 #include <ClanLib/Core/Math/rect.h>
+#include <ClanLib/Display/graphic_context.h>
 #include "meta_data.hxx"
 #include "shared_ptr.hxx"
 
@@ -48,7 +49,7 @@
       the layer itself) */
   void     set_metadata(MetaData data_);
 
-  void draw(EditorMapComponent* parent);
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc);
   bool has_bounding_rect() const;
   CL_Rect get_bounding_rect();
 

Modified: trunk/lib/layer_impl.hxx
===================================================================
--- trunk/lib/layer_impl.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/layer_impl.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -21,6 +21,7 @@
 #define HEADER_LAYER_IMPL_HXX
 
 #include <ClanLib/Core/Math/rect.h>
+#include <ClanLib/Display/graphic_context.h>
 #include "meta_data.hxx"
 
 class EditorMapComponent;
@@ -41,7 +42,7 @@
   LayerImpl() {}
   virtual ~LayerImpl() {}
 
-  virtual void draw(EditorMapComponent* parent) =0;
+  virtual void draw(EditorMapComponent* parent, CL_GraphicContext* gc) =0;
   virtual bool has_bounding_rect() const =0;
 
   // FIXME: Should use CL_Rectf

Modified: trunk/lib/object_layer.cxx
===================================================================
--- trunk/lib/object_layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/object_layer.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -39,7 +39,7 @@
   ObjectLayerImpl() {}
   virtual ~ObjectLayerImpl() {}
   
-  void draw(EditorMapComponent* parent);
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc);
   bool has_bounding_rect() const { return false; }
 };
 
@@ -53,16 +53,16 @@
 }
 
 void
-ObjectLayerImpl::draw(EditorMapComponent* parent)
+ObjectLayerImpl::draw(EditorMapComponent* parent, CL_GraphicContext* gc)
 {
   for(ObjectLayer::Objects::iterator i = objects.begin(); i != objects.end(); ++i)
     {
-      (*i).draw();
+      (*i).draw(gc);
     }
 
   for(ObjectLayer::ControlPoints::iterator i = control_points.begin(); i != control_points.end(); ++i)
     {
-      (*i).draw();
+      (*i).draw(gc);
     }
 }
 

Modified: trunk/lib/objmap_control_point.cxx
===================================================================
--- trunk/lib/objmap_control_point.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_control_point.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -26,7 +26,7 @@
   CL_Pointf  pos;
   MetaData  data;
 
-  void draw();
+  void draw(CL_GraphicContext* gc);
   CL_Rect get_bound_rect() const;
   CL_Signal_v1<CL_Pointf> on_set_pos;
 };
@@ -46,15 +46,15 @@
 }
 
 void
-ObjMapControlPoint::draw()
+ObjMapControlPoint::draw(CL_GraphicContext* gc)
 {
-  impl->draw();
+  impl->draw(gc);
 }
 
 void
-ObjMapControlPointImpl::draw()
+ObjMapControlPointImpl::draw(CL_GraphicContext* gc)
 {
-  sprite.draw(static_cast<int>(pos.x), static_cast<int>(pos.y));
+  sprite.draw(static_cast<int>(pos.x), static_cast<int>(pos.y), gc);
 }
 
 void

Modified: trunk/lib/objmap_control_point.hxx
===================================================================
--- trunk/lib/objmap_control_point.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_control_point.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -41,7 +41,7 @@
   CL_Pointf get_pos() const;
   void     set_pos(const CL_Pointf& p);
   void     set_pos_raw(const CL_Pointf& p);
-  void     draw();
+  void     draw(CL_GraphicContext* gc);
 
   CL_Rect get_bound_rect() const;
 

Modified: trunk/lib/objmap_object.cxx
===================================================================
--- trunk/lib/objmap_object.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_object.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -71,10 +71,10 @@
 }
 
 void
-ObjMapObject::draw()
+ObjMapObject::draw(CL_GraphicContext* gc)
 {
   if (impl.get())
-    impl->draw();
+    impl->draw(gc);
 }
 
 CL_Rectf

Modified: trunk/lib/objmap_object.hxx
===================================================================
--- trunk/lib/objmap_object.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_object.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -21,6 +21,7 @@
 #define HEADER_OBJMAP_OBJECT_HXX
 
 #include <ClanLib/signals.h>
+#include <ClanLib/Display/graphic_context.h>
 #include <ClanLib/Core/Math/point.h>
 #include <ClanLib/Core/Math/rect.h>
 #include "meta_data.hxx"
@@ -46,7 +47,7 @@
   CL_Signal_v1<ObjMapObject>& sig_select();
   CL_Signal_v1<ObjMapObject>& sig_deselect();
 
-  void draw();
+  void draw(CL_GraphicContext* gc);
   CL_Rectf get_bound_rect() const;
 
   void add_control_points();

Modified: trunk/lib/objmap_object_impl.hxx
===================================================================
--- trunk/lib/objmap_object_impl.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_object_impl.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -38,7 +38,7 @@
   ObjMapObjectImpl();
   virtual ~ObjMapObjectImpl();
 
-  virtual void draw() =0;
+  virtual void draw(CL_GraphicContext* gc) =0;
   virtual CL_Rectf get_bound_rect() const  =0;
 
   virtual void add_control_points();

Modified: trunk/lib/objmap_path_node.cxx
===================================================================
--- trunk/lib/objmap_path_node.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_path_node.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -29,7 +29,7 @@
   
   ObjMapPathNodeImpl();
 
-  void draw();
+  void draw(CL_GraphicContext* gc);
   CL_Rectf get_bound_rect() const;
 };
 
@@ -40,22 +40,22 @@
 }
 
 void
-ObjMapPathNodeImpl::draw()
+ObjMapPathNodeImpl::draw(CL_GraphicContext* gc)
 {
-  CL_Display::fill_rect(CL_Rect(CL_Point(pos) - CL_Point(16,16), CL_Size(32, 32)), 
-                        CL_Color(200, 255, 200));
+  gc->fill_rect(CL_Rect(CL_Point(pos) - CL_Point(16,16), CL_Size(32, 32)), 
+                CL_Color(200, 255, 200));
   if (next)
     {
-      CL_Display::draw_line(static_cast<int>(pos.x), static_cast<int>(pos.y),
-                            static_cast<int>((pos.x + next->pos.x)/2),
-                            static_cast<int>((pos.y+next->pos.y)/2),
-                            CL_Color(255, 255, 0));
+      gc->draw_line(static_cast<int>(pos.x), static_cast<int>(pos.y),
+                    static_cast<int>((pos.x + next->pos.x)/2),
+                    static_cast<int>((pos.y+next->pos.y)/2),
+                    CL_Color(255, 255, 0));
 
-      CL_Display::draw_line(static_cast<int>((pos.x + next->pos.x)/2), 
-                            static_cast<int>((pos.y+next->pos.y)/2),
-                            static_cast<int>(next->pos.x),
-                            static_cast<int>(next->pos.y), 
-                            CL_Color(255, 0, 0));
+      gc->draw_line(static_cast<int>((pos.x + next->pos.x)/2), 
+                    static_cast<int>((pos.y+next->pos.y)/2),
+                    static_cast<int>(next->pos.x),
+                    static_cast<int>(next->pos.y), 
+                    CL_Color(255, 0, 0));
     }
 }
 

Modified: trunk/lib/objmap_rect_object.cxx
===================================================================
--- trunk/lib/objmap_rect_object.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_rect_object.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -121,7 +121,7 @@
     }
   }
 
-  void draw();
+  void draw(CL_GraphicContext* gc);
   CL_Rectf get_bound_rect() const;
   void add_control_points();
   void update_control_points();
@@ -214,9 +214,9 @@
 }
 
 void
-ObjMapRectObjectImpl::draw()
+ObjMapRectObjectImpl::draw(CL_GraphicContext* gc)
 {
-  CL_Display::fill_rect(get_bound_rect(), color);
+  gc->fill_rect(get_bound_rect(), color);
 }
 
 CL_Rectf
@@ -242,7 +242,7 @@
   objmap.add_control_point(cp_top_right);
   objmap.add_control_point(cp_bottom_left);
   objmap.add_control_point(cp_bottom_right);
-  objmap.add_control_point(  cp_top_middle);
+  objmap.add_control_point(cp_top_middle);
   objmap.add_control_point(cp_bottom_middle);
   objmap.add_control_point(cp_middle_left);
   objmap.add_control_point(cp_middle_right);

Modified: trunk/lib/objmap_rect_object.hxx
===================================================================
--- trunk/lib/objmap_rect_object.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_rect_object.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -34,7 +34,7 @@
                    const CL_Color& color_,
                    const MetaData& data_);
     
-  void draw();
+  void draw(CL_GraphicContext* gc);
 
   void set_color(const CL_Color& color);
 

Modified: trunk/lib/objmap_sprite_object.cxx
===================================================================
--- trunk/lib/objmap_sprite_object.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/objmap_sprite_object.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -26,7 +26,7 @@
 public:
   CL_Sprite sprite;
 
-  void draw();
+  void draw(CL_GraphicContext* gc);
   CL_Rectf get_bound_rect() const;
 
   ObjMapObject*  duplicate(int handle_);
@@ -47,9 +47,9 @@
 }
 
 void
-ObjMapSpriteObjectImpl::draw()
+ObjMapSpriteObjectImpl::draw(CL_GraphicContext* gc)
 {
-  sprite.draw(pos.x, pos.y);
+  sprite.draw(pos.x, pos.y, gc);
 }
 
 CL_Rectf

Added: trunk/lib/onion_skin_layer.cxx
===================================================================
--- trunk/lib/onion_skin_layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/onion_skin_layer.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,102 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include <iostream>
+#include <ClanLib/Core/System/error.h>
+#include <ClanLib/Display/pixel_buffer.h>
+#include <ClanLib/Display/pixel_format.h>
+#include <ClanLib/Display/surface.h>
+#include <ClanLib/Display/canvas.h>
+#include "editor_map_component.hxx"
+#include "layer_impl.hxx"
+#include "onion_skin_layer.hxx"
+
+class OnionSkinLayerImpl : public LayerImpl
+{
+public:
+  CL_Surface  surface;
+  CL_Canvas*  canvas;
+
+  CL_Surface  surface2;
+  CL_Canvas*  canvas2;
+
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
+  {
+    // FIXME: We need to stop onion layer to draw onto itself
+    surface.draw(0, 0);
+  }
+
+  bool has_bounding_rect() const
+  {
+    return false;
+  }
+};
+
+OnionSkinLayer::OnionSkinLayer(int width, int height)
+  : impl(new OnionSkinLayerImpl())
+{
+  impl->surface  = CL_Surface(CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888));
+  impl->surface2 = CL_Surface(CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888));
+
+  try
+    {
+      impl->canvas = new CL_Canvas(impl->surface);
+      impl->canvas->get_gc()->clear(CL_Color(0, 0, 0, 0));
+      impl->canvas->get_gc()->flush();
+      impl->canvas->sync_surface();
+
+      impl->canvas2 = new CL_Canvas(impl->surface2);
+      impl->canvas2->get_gc()->clear(CL_Color(0, 0, 0, 0));
+      impl->canvas2->get_gc()->flush();
+      impl->canvas2->sync_surface();
+    }
+  catch(CL_Error& err) 
+    {
+      std::cout << "CL_Error: " << err.message << std::endl;
+      throw err;
+    }
+}
+
+void
+OnionSkinLayer::clear()
+{
+  impl->canvas->get_gc()->clear();
+  impl->canvas->sync_surface();
+}
+
+void
+OnionSkinLayer::add_map(EditorMap editor_map, float transparency)
+{
+  // FIXME: Parameter are a bit unclear here
+  impl->canvas2->get_gc()->clear();
+  editor_map.draw(EditorMapComponent::current(), impl->canvas2->get_gc());
+  impl->canvas2->sync_surface();
+  impl->surface2.set_alpha(transparency);
+  impl->surface2.draw(0, 0, impl->canvas->get_gc());
+  impl->canvas->sync_surface();
+}
+
+Layer
+OnionSkinLayer::to_layer()
+{
+  return Layer(impl);
+}
+
+/* EOF */
+

Added: trunk/lib/onion_skin_layer.hxx
===================================================================
--- trunk/lib/onion_skin_layer.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/onion_skin_layer.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,53 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_ONION_SKIN_LAYER_HXX
+#define HEADER_ONION_SKIN_LAYER_HXX
+
+#include "editor_map.hxx"
+
+class OnionSkinLayerImpl;
+
+/** The OnionSkinLayer is used to render one or multiple EditorMap
+    renderings in a transparent fashion onto another EditorMap. This
+    is usefull for animation programms and the like where one might
+    need to see the previous or next frames together with the current
+    frame. Might also be usefull for games which have shadow worlds,
+    which reassamble the normal world in a darker fashion. */
+class OnionSkinLayer
+{
+public:
+  /** FIXME: Should probally be CL_Rect instead of just
+      width/height */
+  OnionSkinLayer(int width, int height);
+  
+  /** Adds an EditorMap to the OnionSkin */
+  void add_map(EditorMap editor_map, float transparency);
+
+  void clear();
+
+  bool is_null() const { return !impl.get(); }
+  Layer to_layer();
+private:
+  SharedPtr<OnionSkinLayerImpl> impl;  
+};
+
+#endif
+
+/* EOF */

Modified: trunk/lib/sketch_layer.cxx
===================================================================
--- trunk/lib/sketch_layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/sketch_layer.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -82,7 +82,7 @@
       }
   }
   
-  void draw(EditorMapComponent* parent) 
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc) 
   {
     // Nothing to draw, so we go byebye
     if (strokes.empty()) 

Added: trunk/lib/sprite_brush.cxx
===================================================================
--- trunk/lib/sprite_brush.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/sprite_brush.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,60 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#include "brush_impl.hxx"
+#include "sprite_brush.hxx"
+
+class SpriteBrushImpl : public BrushImpl
+{
+public:
+  CL_Sprite sprite;
+  
+  SpriteBrushImpl(const CL_Sprite& sprite_)
+    : sprite(sprite_)
+  {
+    sprite.set_alignment (origin_center, 0, 0);
+  }
+
+  virtual ~SpriteBrushImpl()
+  {
+  }
+
+  CL_Sprite get_sprite() 
+  {
+    return sprite;
+  }
+
+  BrushImpl* clone() const 
+  {
+    return new SpriteBrushImpl(sprite);
+  }
+};
+
+SpriteBrush::SpriteBrush(const CL_Sprite& sprite_)
+  : impl(new SpriteBrushImpl(sprite_))
+{
+}
+
+Brush
+SpriteBrush::to_brush()
+{
+  return Brush(impl);
+}
+
+/* EOF */

Added: trunk/lib/sprite_brush.hxx
===================================================================
--- trunk/lib/sprite_brush.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/sprite_brush.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,42 @@
+//  $Id$
+// 
+//  Pingus - A free Lemmings clone
+//  Copyright (C) 2002 Ingo Ruhnke <grumbel at gmx.de>
+//
+//  This program is free software; you can redistribute it and/or
+//  modify it under the terms of the GNU General Public License
+//  as published by the Free Software Foundation; either version 2
+//  of the License, or (at your option) any later version.
+//
+//  This program is distributed in the hope that it will be useful,
+//  but WITHOUT ANY WARRANTY; without even the implied warranty of
+//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+//  GNU General Public License for more details.
+// 
+//  You should have received a copy of the GNU General Public License
+//  along with this program; if not, write to the Free Software
+//  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+#ifndef HEADER_SPRITE_BRUSH_HXX
+#define HEADER_SPRITE_BRUSH_HXX
+
+#include <ClanLib/Display/sprite.h>
+#include "brush.hxx"
+#include "shared_ptr.hxx"
+
+class SpriteBrushImpl;
+
+class SpriteBrush
+{
+public:
+  SpriteBrush(const CL_Sprite& sprite_);
+
+  Brush to_brush();
+private:
+  SharedPtr<SpriteBrushImpl> impl;
+};
+
+
+#endif
+
+/* EOF */

Modified: trunk/lib/tilemap_layer.cxx
===================================================================
--- trunk/lib/tilemap_layer.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/tilemap_layer.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -55,8 +55,8 @@
 
   bool has_bounding_rect() const;
   CL_Rect get_bounding_rect();
-  void draw(EditorMapComponent* parent);
-  void draw_tile(int id, int x, int y, bool attribute);
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc);
+  void draw_tile(int id, int x, int y, bool attribute, CL_GraphicContext* gc);
 };
 
 TilemapLayer::TilemapLayer()
@@ -94,7 +94,7 @@
 }
 
 void
-TilemapLayer::draw_tile(int id, int x, int y, bool attribute)
+TilemapLayer::draw_tile(int id, int x, int y, bool attribute, CL_GraphicContext* gc)
 {
   Tile* tile = impl->tileset.create(id);
 
@@ -105,23 +105,23 @@
 
       sprite.set_color(impl->foreground_color);
 
-      sprite.draw (x, y);
+      sprite.draw(x, y, gc);
       
       if (attribute)
-        CL_Display::fill_rect(CL_Rect(CL_Point(x, y), CL_Size(impl->tileset.get_tile_size(),
-                                                              impl->tileset.get_tile_size())),
-                              tile->get_attribute_color());
+        gc->fill_rect(CL_Rect(CL_Point(x, y), CL_Size(impl->tileset.get_tile_size(),
+                                                      impl->tileset.get_tile_size())),
+                      tile->get_attribute_color());
     }
 }
 
 void
-TilemapLayer::draw(EditorMapComponent* parent)
+TilemapLayer::draw(EditorMapComponent* parent, CL_GraphicContext* gc)
 {
-  impl->draw(parent);
+  impl->draw(parent, gc);
 }
 
 void
-TilemapLayerImpl::draw_tile(int id, int x, int y, bool attribute)
+TilemapLayerImpl::draw_tile(int id, int x, int y, bool attribute, CL_GraphicContext* gc)
 {
   Tile* tile = tileset.create(id);
 
@@ -132,7 +132,7 @@
 
       sprite.set_color(foreground_color);
 
-      sprite.draw (x, y);
+      sprite.draw(x, y, gc);
       
       if (attribute)
         CL_Display::fill_rect(CL_Rect(CL_Point(x, y), CL_Size(tileset.get_tile_size(),
@@ -142,7 +142,7 @@
 }
 
 void
-TilemapLayerImpl::draw(EditorMapComponent* parent)
+TilemapLayerImpl::draw(EditorMapComponent* parent, CL_GraphicContext* gc)
 {
   int tile_size = this->tileset.get_tile_size();
 
@@ -165,7 +165,8 @@
       {
         draw_tile(this->field.at(x, y), 
                   x * tile_size, y * tile_size,
-                  this->draw_attribute);
+                  this->draw_attribute,
+                  gc);
       }
 
   if (this->draw_grid)

Modified: trunk/lib/tilemap_layer.hxx
===================================================================
--- trunk/lib/tilemap_layer.hxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/tilemap_layer.hxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -43,7 +43,7 @@
   TilemapLayer(Tileset tileset, int w,  int h);
   ~TilemapLayer();
 
-  void draw(EditorMapComponent* parent);
+  void draw(EditorMapComponent* parent, CL_GraphicContext* gc);
 
   Tileset get_tileset();
 
@@ -64,7 +64,7 @@
   /** Draw the given single tile to the map */
   void draw_tile(int id, const CL_Point& pos);
 
-  void draw_tile(int id, int x, int y, bool attribute);
+  void draw_tile(int id, int x, int y, bool attribute, CL_GraphicContext* gc);
 
   int get_width()  const;
   int get_height() const;

Modified: trunk/lib/workspace.cxx
===================================================================
--- trunk/lib/workspace.cxx	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/lib/workspace.cxx	2005-03-20 00:43:21 UTC (rev 497)
@@ -19,6 +19,7 @@
 
 #include <iostream>
 #include <ClanLib/Display/display.h>
+#include <ClanLib/Display/display_window.h>
 #include <ClanLib/Display/keys.h>
 #include "editor.hxx"
 #include "editor_map.hxx"
@@ -61,7 +62,7 @@
 
   CL_Display::clear(CL_Color(100, 0, 100));
 
-  impl->editor_map.draw(EditorMapComponent::current());
+  impl->editor_map.draw(EditorMapComponent::current(), CL_Display::get_current_window()->get_gc());
   
   if (1) // has_mouse_over()) FIXME: Seperate cursor and state here
     impl->tool.draw();

Added: trunk/paint/TODO
===================================================================
--- trunk/paint/TODO	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/paint/TODO	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,3 @@
+ - start as border-less fullscreen app without grabbing the mouse
+ - allow resize
+ - take bound-rect into account when drawing
\ No newline at end of file

Added: trunk/paint/animation.rb
===================================================================
--- trunk/paint/animation.rb	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/paint/animation.rb	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,45 @@
+class Animation
+  def initialize()
+    @frames = [Image.new()]
+    @current_frame = 0
+  end
+
+  def next_frame()
+    @current_frame = (@current_frame + 1) % @frames.length
+    get_current_image().activate($gui.workspace)
+  end
+
+  def previous_frame()
+    @current_frame = (@current_frame - 1) % @frames.length
+    get_current_image().activate($gui.workspace)
+  end
+
+  def get_current_image()
+    return @frames[@current_frame]
+  end
+
+  def goto_frame(index)
+    @current_frame = index % @frames.length
+  end
+
+  def add_frame(index = nil)
+    if index then
+      
+    else
+      img = Image.new()
+      @frames.push(img)
+      next_frame()
+
+      # Hack for Onion_Skin
+      onion_skin = OnionSkinLayer.new(1024, 768)
+      # onion_skin.to_layer().set_pos(CL_Pointf.new(-100, -100))
+      img.editormap.add_layer(onion_skin.to_layer(), 0)
+      
+      if (@current_frame > 0) then
+        onion_skin.add_map(@frames[@current_frame - 1].editormap, 0.5)
+      end
+    end
+  end
+end
+
+# EOF #

Added: trunk/paint/gui.rb
===================================================================
--- trunk/paint/gui.rb	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/paint/gui.rb	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,184 @@
+class PaintGUI
+  attr_reader :workspace, :selector_window
+
+  def initialize()
+    @editor = Editor.new()
+    @gui    = @editor.get_gui_manager()
+    
+    @editor_map = EditorMapComponent.new($screen_rect, @gui.get_component())
+    @workspace  = Workspace.new($screen_rect.get_width(), $screen_rect.get_height())
+    @editor_map.set_workspace(@workspace)
+    @workspace.set_tool($sketch_stroke_tool.to_tool());
+    # @workspace.set_tool($layer_move_tool.to_tool());
+
+    @selector_window_main = Window.new(CL_Rect.new(CL_Point.new($screen_rect.get_width()-160, 5), 
+                                                   CL_Size.new(128 + 6 + 10, 558)),
+                                       "ColorPicker",
+                                       @gui.get_component())
+    @selector_window = @selector_window_main.get_client_area()
+
+    @colorpicker = ColorPicker.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 128)),
+                                   @selector_window)
+
+    connect_v1_Color(@colorpicker.sig_color_change(), proc{|color|
+                       $sketch_stroke_tool.set_color(color)
+                     })
+
+    @bgcolorpicker = ColorPicker.new(CL_Rect.new(CL_Point.new(3, 300), CL_Size.new(128, 128)),
+                                     @selector_window)
+
+    connect_v1_Color(@bgcolorpicker.sig_color_change(), proc{|color|
+                       @workspace.get_map().set_background_color(color)
+                     })
+
+    @size_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 150), CL_Size.new(128, 16)), @selector_window)
+    @size_slider.set_range(0.01, 2.0) # FIXME: using 0 size brush makes clanlib crashi
+    @size_slider.set_value(1.0)
+    connect_v1_float(@size_slider.sig_on_change, proc{|value|
+                       # puts "Value: #{value}"
+                       $sketch_stroke_tool.set_size(value)
+                     })
+
+    @brush_hardness = Slider.new(CL_Rect.new(CL_Point.new(3, 170), CL_Size.new(128, 16)),
+                                 @selector_window)
+    @brush_hardness.set_range(0.0, 1.0)
+    @brush_hardness.set_value(0.75)
+    connect_v1_float(@brush_hardness.sig_on_change, proc{|value|
+                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+                       GeneratedBrush.new(drawer.get_brush()).set_hardness(value)
+                     })
+
+    @brush_spikes = Slider.new(CL_Rect.new(CL_Point.new(3, 190), CL_Size.new(128, 16)),
+                                 @selector_window)
+    @brush_spikes.set_range(2, 20)
+    @brush_spikes.set_value(2)
+    connect_v1_float(@brush_spikes.sig_on_change, proc{|value|
+                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+                       GeneratedBrush.new(drawer.get_brush()).set_spikes(value.to_i)
+                     })
+
+    @brush_aspects = Slider.new(CL_Rect.new(CL_Point.new(3, 210), CL_Size.new(128, 16)),
+                                 @selector_window)
+    @brush_aspects.set_range(0.1, 10)
+    @brush_aspects.set_value(1)
+    connect_v1_float(@brush_aspects.sig_on_change, proc{|value|
+                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+                       GeneratedBrush.new(drawer.get_brush()).set_aspect_ratio(value)
+                     })
+
+    @brush_angles = Slider.new(CL_Rect.new(CL_Point.new(3, 230), CL_Size.new(128, 16)),
+                                 @selector_window)
+    @brush_angles.set_range(0, 360)
+    @brush_angles.set_value(0)
+    connect_v1_float(@brush_angles.sig_on_change, proc{|value|
+                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+                       GeneratedBrush.new(drawer.get_brush()).set_angle(value)
+                     })
+
+    @brush_shape_circle  = CL_Button.new(CL_Rect.new(CL_Point.new(5, 250), CL_Size.new(40, 25)), "Circ", @selector_window)
+    @brush_shape_rect    = CL_Button.new(CL_Rect.new(CL_Point.new(45, 250), CL_Size.new(40, 25)), "Squa", @selector_window)
+    @brush_shape_diamond = CL_Button.new(CL_Rect.new(CL_Point.new(85, 250), CL_Size.new(40, 25)), "Diam", @selector_window)
+
+    connect(@brush_shape_circle.sig_clicked(), proc{ 
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_CIRCLE)
+            })
+    connect(@brush_shape_rect.sig_clicked(), proc{ 
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_SQUARE)
+            })
+    connect(@brush_shape_diamond.sig_clicked(), proc{ 
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_DIAMOND)
+            })
+
+#    @zoom_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 182), CL_Size.new(128, 16)), @selector_window)
+#    @zoom_slider.set_range(0.25, 10.0) # FIXME: using 0 size brush makes clanlib crashi
+#    @zoom_slider.set_value(1.0)
+#    connect_v1_float(@zoom_slider.sig_on_change, proc{|value|
+#                       # puts "Value: #{value}"
+#                       self.gui_set_zoom(value)
+#                     })
+
+    connect_v2(@editor_map.sig_on_key("escape"),  proc{ |x, y| puts "bye, bye"})
+    connect_v2(@editor_map.sig_on_key("esc"),  proc{ |x, y| puts "bye, bye2"})
+    connect_v2(@editor_map.sig_on_key("q"),  proc{ |x, y| $gui.quit()})
+    connect_v2(@editor_map.sig_on_key("s"),  proc{ |x, y| $image.save("/tmp/test.scm")})
+    connect_v2(@editor_map.sig_on_key("l"),  proc{ |x, y| 
+                 $image = Image.new("/tmp/test.scm")
+                 $image.activate($gui.workspace())
+               })
+
+    connect_v2(@editor_map.sig_on_key("1"),  proc{ |x, y| $animation.previous_frame()})
+    connect_v2(@editor_map.sig_on_key("2"),  proc{ |x, y| $animation.next_frame()})
+
+
+    connect_v2(@editor_map.sig_on_key("g"),  proc{ |x, y|
+                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() - 10)
+               })
+    connect_v2(@editor_map.sig_on_key("c"),  proc{ |x, y| 
+                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() + 10)
+               })
+
+    @normal_mode = CL_Button.new(CL_Rect.new(CL_Point.new(5, 500), CL_Size.new(40, 25)), "Norm", @selector_window)
+    @erase_mode  = CL_Button.new(CL_Rect.new(CL_Point.new(45, 500), CL_Size.new(40, 25)), "Erase", @selector_window)
+    @add_mode    = CL_Button.new(CL_Rect.new(CL_Point.new(85, 500), CL_Size.new(40, 25)), "Add", @selector_window)
+    @shader_mode = CL_Button.new(CL_Rect.new(CL_Point.new(125, 500), CL_Size.new(40, 25)), "Shad", @selector_window)
+
+    connect(@normal_mode.sig_clicked(), proc{ 
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              drawer.set_mode(SpriteStrokeDrawer::DM_NORMAL)
+            })
+    connect(@erase_mode.sig_clicked(),  proc{ 
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              drawer.set_mode(SpriteStrokeDrawer::DM_ERASE)
+            })
+    connect(@add_mode.sig_clicked(),    proc{
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              drawer.set_mode(SpriteStrokeDrawer::DM_ADDITION)
+            })
+    connect(@shader_mode.sig_clicked(),    proc{
+              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
+              drawer.set_mode(SpriteStrokeDrawer::DM_SHADER)
+            })
+
+    button_panel = ButtonPanel.new(0, 0, 33, 33*3, false, @gui.get_component)
+    button_panel.add_icon("../data/images/tools/stock-tool-pencil-22.png", proc{ 
+                            @workspace.set_tool($sketch_stroke_tool.to_tool())
+                          })
+    button_panel.add_icon("../data/images/tools/stock-tool-zoom-22.png", proc{ 
+                            @workspace.set_tool($zoom_tool.to_tool())
+                          })
+    button_panel.add_icon("../data/images/tools/stock-tool-move-22.png", proc{ 
+                            @workspace.set_tool($layer_move_tool.to_tool())
+                          })
+
+    anim_panel = ButtonPanel.new($screen_rect.get_width()/2 - (32*10)/2-16-32, 0, 32*11+1+16, 33,
+                                 true, @gui.get_component)
+    anim_panel.add_icon("../data/images/icons24/stock_new.png",
+                        proc{ $animation.add_frame() })
+    anim_panel.add_seperator()
+    anim_panel.add_icon("../data/images/icons24/anim_skipbackward.png")
+    anim_panel.add_icon("../data/images/icons24/anim_fastbackward.png")
+    anim_panel.add_icon("../data/images/icons24/anim_playbackward.png")
+    anim_panel.add_icon("../data/images/icons24/anim_slowmotionbackward.png")
+    anim_panel.add_icon("../data/images/icons24/anim_previous.png",
+                        proc{ $animation.previous_frame()})
+    anim_panel.add_icon("../data/images/icons24/anim_next.png",
+                        proc{ $animation.next_frame()})
+    anim_panel.add_icon("../data/images/icons24/anim_slowmotion.png")
+    anim_panel.add_icon("../data/images/icons24/anim_play.png")
+    anim_panel.add_icon("../data/images/icons24/anim_fastforward.png")
+    anim_panel.add_icon("../data/images/icons24/anim_skipforward.png")
+  end
+
+  def quit()
+    @gui.quit()
+  end
+
+  def run()
+    @gui.run()
+  end
+end
+
+# EOF #

Added: trunk/paint/image.rb
===================================================================
--- trunk/paint/image.rb	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/paint/image.rb	2005-03-20 00:43:21 UTC (rev 497)
@@ -0,0 +1,196 @@
+class Image
+  attr_reader :layers
+  attr_accessor :editormap
+
+  def initialize(filename = nil)
+    @editormap = EditorMap.new()
+    @editormap.set_bounding_rect(CL_Rect.new(0, 0, 1024, 768))
+    @editormap.set_background_color(CL_Color.new(255, 255, 255))
+    @layers  = []
+    
+    if filename then
+      load(filename)
+      set_active_layer(0)
+    else
+      add_layer()
+      set_active_layer(0)
+    end
+  end
+  
+  def set_active_layer(i)
+    if (i >= 0 && i < layers.size) then
+      BitmapLayer.set_current(layers[i])
+    end
+  end
+
+  def add_layer()
+    layer = BitmapLayer.new(1024, 768)
+    layer.to_layer().set_pos(CL_Pointf.new(0, 0))
+    @layers.push(layer)
+    @editormap.add_layer(layer.to_layer()) 
+    puts "Add layer: #{layer}" 
+    return layer
+  end
+
+  def layers_count()
+    return layers.size
+  end
+
+  def activate(workspace)
+    workspace.set_map(@editormap)
+    BitmapLayer.set_current(layers[0])
+    connect(@editormap.sig_change(), proc{$gui.on_map_change()})
+  end
+
+  def load(filename)
+    tree = sexpr_read_from_file(filename)
+    if tree == nil
+        raise("Couldn't load level: %s" % filename)
+    end
+    
+    # Skip flexlay-paint tag
+    tree = tree[1..-1]
+    puts "REst: #{tree.length}"
+    while not tree.empty? do
+      (tag, *data) = tree[0]
+
+      puts "Tag: #{tag}"
+
+      if tag == "layer" then
+        puts "MUMU LAYER" 
+        parse_layer(data)
+      end
+
+      tree = tree[1..-1]
+      puts "REst2: #{tree.length}"
+    end
+
+    set_active_layer(0)
+  end
+
+  def parse_layer(tree)
+    layer = add_layer()
+
+    while not tree.empty? do
+      (tag, *data) = tree[0]
+      
+      if tag == "stroke" then
+        parse_stroke(layer, data)
+      end
+
+      tree = tree[1..-1]
+    end
+    puts ""
+  end
+
+  def parse_stroke(layer, tree)
+    stroke = Stroke.new()
+
+    sprite_drawer = SpriteStrokeDrawer.new()
+    # FIXME: insert loader for brush here
+    sprite_drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
+                                               32,  # radius
+                                               2,   # spikes
+                                               0.75, # hardness
+                                               1.0, # aspect
+                                               0).to_brush()) # angle
+    
+    sprite_drawer.set_color(CL_Color.new(0, 0, 0, 155))
+    sprite_drawer.set_size(1.0)
+    stroke.set_drawer(sprite_drawer.to_drawer())
+
+    while not tree.empty? do
+      (tag, *data) = tree[0]     
+
+      if tag == "dab" then
+        time     = get_value_from_tree(["time", "_"], data, 0)
+        position = get_value_from_tree(["position"],  data, [0, 0])
+        pressure = get_value_from_tree(["pressure", "_"],  data, 1.0)
+        tilt     = get_value_from_tree(["tilt", "_"],  data, [0, 0])
+
+        # FIXME: No tilt support
+        stroke.add_dab(Dab.new(position[0].to_f, position[1].to_f, pressure.to_f))
+      elsif tag == "drawer" then
+        if data[0][0] == "sprite-stroke-drawer" then
+          data = data[0][1..-1]
+          mode    = get_value_from_tree(["mode", "_"], data, SpriteStrokeDrawer::DM_NORMAL)
+          spacing = get_value_from_tree(["spacing", "_"], data, 15.0)
+          size    = get_value_from_tree(["size", "_"],    data,  1.0)
+          color   = get_value_from_tree(["color"],    data, [0, 255, 0, 255])
+          brush   = get_value_from_tree(["brush", "generated-brush"],    data, [])
+
+          drawer = SpriteStrokeDrawer.new()
+          drawer.set_spacing(spacing)
+          drawer.set_mode(mode)
+          drawer.set_size(size)
+          drawer.set_color(CL_Color.new(color[0], color[1], color[2], color[3]))
+          drawer.set_brush(GeneratedBrush.new(get_value_from_tree(["shape", "_"], brush, 0),
+                                              get_value_from_tree(["radius", "_"], brush, 32),
+                                              get_value_from_tree(["spikes", "_"], brush, 2),
+                                              get_value_from_tree(["hardness", "_"], brush, 0.75),
+                                              get_value_from_tree(["aspect-ratio", "_"], brush, 1.0),
+                                              get_value_from_tree(["angle", "_"], brush, 0)).to_brush)
+          stroke.set_drawer(drawer.to_drawer)
+        else
+          puts "Error: Unknown drawer: #{data[0][0]}" 
+        end
+      end
+
+      tree = tree[1..-1]
+    end
+    
+    print "."
+    $stdout.flush
+    layer.add_stroke(stroke)
+  end
+
+  def save(filename)
+    f = File.new(filename, "w")
+    f.puts "(flexlay-paint"
+    @layers.each { |layer|
+      f.puts "(layer"
+      layer.get_strokes().each{|stroke|
+        f.puts "  (stroke"
+        
+        # FIXME: This won't work with a real smartptr!
+        sprite_stroke_drawer = SpriteStrokeDrawer.new(stroke.get_drawer())
+
+        f.puts "      (drawer (sprite-stroke-drawer"
+        f.puts "                 (mode    #{sprite_stroke_drawer.get_mode})"
+        f.puts "                 (spacing #{sprite_stroke_drawer.get_spacing})"
+        f.puts "                 (size    #{sprite_stroke_drawer.get_size})"
+        f.puts "                 (color   "\
+        "#{sprite_stroke_drawer.get_color.get_red} " \
+        "#{sprite_stroke_drawer.get_color.get_green} " \
+        "#{sprite_stroke_drawer.get_color.get_blue} " \
+        "#{sprite_stroke_drawer.get_color.get_alpha})"
+        # FIXME: This won't work with multilpe brush types
+        brush = GeneratedBrush.new(sprite_stroke_drawer.get_brush())
+        f.puts "                 (brush   (generated-brush"
+        f.puts "                            (shape  #{brush.get_shape})"
+        f.puts "                            (radius #{brush.get_radius})"
+        f.puts "                            (spikes #{brush.get_spikes})"
+        f.puts "                            (hardness #{brush.get_hardness})"
+        f.puts "                            (aspect-ratio #{brush.get_aspect_ratio})"
+        f.puts "                            (angle #{brush.get_angle})"
+        f.puts "                  ))"
+        f.puts "       ))"
+
+        stroke.get_dabs().each{|dab|
+          f.puts "    (dab"
+          f.puts "      (time     #{dab.time})"
+          f.puts "      (position #{dab.pos.x} #{dab.pos.y})"
+          f.puts "      (pressure #{dab.pressure})"
+          f.puts "      (tilt     #{dab.tilt.x} #{dab.tilt.y})"
+          f.puts ")"
+        }
+        f.puts ")"
+      }
+      f.puts ")"
+    }
+    f.puts ")"
+    f.close()
+  end
+end
+
+# EOF #

Modified: trunk/paint/paint.rb
===================================================================
--- trunk/paint/paint.rb	2005-03-18 22:59:13 UTC (rev 496)
+++ trunk/paint/paint.rb	2005-03-20 00:43:21 UTC (rev 497)
@@ -23,11 +23,14 @@
 
 require "flexlay.rb"
 require "sexpr.rb"
+require "animation.rb"
+require "image.rb"
+require "gui.rb"
 
 flexlay = Flexlay.new()
 
-$screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(800, 600))
-# $screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(1152, 864))
+# $screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(800, 600))
+$screen_rect = CL_Rect.new(CL_Point.new(0, 0), CL_Size.new(1024, 768))
 
 flexlay.init($screen_rect.get_width(), $screen_rect.get_height(), false)
 
@@ -35,378 +38,26 @@
 $layer_move_tool     = LayerMoveTool.new()
 $zoom_tool           = ZoomTool.new()
 
-class PaintGUI
-  attr_reader :workspace, :selector_window
+$sketch_stroke_tool.set_color(CL_Color.new(0, 0, 0, 50))
 
-  def initialize()
-    @editor = Editor.new()
-    @gui    = @editor.get_gui_manager()
-    
-    @editor_map = EditorMapComponent.new($screen_rect, @gui.get_component())
-    @workspace  = Workspace.new($screen_rect.get_width(), $screen_rect.get_height())
-    @editor_map.set_workspace(@workspace)
-    # @workspace.set_tool($sketch_stroke_tool.to_tool());
-    @workspace.set_tool($layer_move_tool.to_tool());
-
-    @selector_window_main = Window.new(CL_Rect.new(CL_Point.new($screen_rect.get_width()-160, 5), 
-                                                   CL_Size.new(128 + 6 + 10, 558)),
-                                       "ColorPicker",
-                                       @gui.get_component())
-    @selector_window = @selector_window_main.get_client_area()
-
-    @colorpicker = ColorPicker.new(CL_Rect.new(CL_Point.new(3, 3), CL_Size.new(128, 128)),
-                                   @selector_window)
-
-    connect_v1_Color(@colorpicker.sig_color_change(), proc{|color|
-                       $sketch_stroke_tool.set_color(color)
-                     })
-
-    @bgcolorpicker = ColorPicker.new(CL_Rect.new(CL_Point.new(3, 300), CL_Size.new(128, 128)),
-                                     @selector_window)
-
-    connect_v1_Color(@bgcolorpicker.sig_color_change(), proc{|color|
-                       @workspace.get_map().set_background_color(color)
-                     })
-
-    @size_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 150), CL_Size.new(128, 16)), @selector_window)
-    @size_slider.set_range(0.01, 2.0) # FIXME: using 0 size brush makes clanlib crashi
-    @size_slider.set_value(1.0)
-    connect_v1_float(@size_slider.sig_on_change, proc{|value|
-                       # puts "Value: #{value}"
-                       $sketch_stroke_tool.set_size(value)
-                     })
-
-    @brush_hardness = Slider.new(CL_Rect.new(CL_Point.new(3, 170), CL_Size.new(128, 16)),
-                                 @selector_window)
-    @brush_hardness.set_range(0.0, 1.0)
-    @brush_hardness.set_value(0.75)
-    connect_v1_float(@brush_hardness.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_hardness(value)
-                     })
-
-    @brush_spikes = Slider.new(CL_Rect.new(CL_Point.new(3, 190), CL_Size.new(128, 16)),
-                                 @selector_window)
-    @brush_spikes.set_range(2, 20)
-    @brush_spikes.set_value(2)
-    connect_v1_float(@brush_spikes.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_spikes(value.to_i)
-                     })
-
-    @brush_aspects = Slider.new(CL_Rect.new(CL_Point.new(3, 210), CL_Size.new(128, 16)),
-                                 @selector_window)
-    @brush_aspects.set_range(0.1, 10)
-    @brush_aspects.set_value(1)
-    connect_v1_float(@brush_aspects.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_aspect_ratio(value)
-                     })
-
-    @brush_angles = Slider.new(CL_Rect.new(CL_Point.new(3, 230), CL_Size.new(128, 16)),
-                                 @selector_window)
-    @brush_angles.set_range(0, 360)
-    @brush_angles.set_value(0)
-    connect_v1_float(@brush_angles.sig_on_change, proc{|value|
-                       drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-                       GeneratedBrush.new(drawer.get_brush()).set_angle(value)
-                     })
-
-    @brush_shape_circle  = CL_Button.new(CL_Rect.new(CL_Point.new(5, 250), CL_Size.new(40, 25)), "Circ", @selector_window)
-    @brush_shape_rect    = CL_Button.new(CL_Rect.new(CL_Point.new(45, 250), CL_Size.new(40, 25)), "Squa", @selector_window)
-    @brush_shape_diamond = CL_Button.new(CL_Rect.new(CL_Point.new(85, 250), CL_Size.new(40, 25)), "Diam", @selector_window)
-
-    connect(@brush_shape_circle.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_CIRCLE)
-            })
-    connect(@brush_shape_rect.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_SQUARE)
-            })
-    connect(@brush_shape_diamond.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              GeneratedBrush.new(drawer.get_brush()).set_shape(BRUSH_SHAPE_DIAMOND)
-            })
-
-#    @zoom_slider = Slider.new(CL_Rect.new(CL_Point.new(3, 182), CL_Size.new(128, 16)), @selector_window)
-#    @zoom_slider.set_range(0.25, 10.0) # FIXME: using 0 size brush makes clanlib crashi
-#    @zoom_slider.set_value(1.0)
-#    connect_v1_float(@zoom_slider.sig_on_change, proc{|value|
-#                       # puts "Value: #{value}"
-#                       self.gui_set_zoom(value)
-#                     })
-
-    connect_v2(@editor_map.sig_on_key("escape"),  proc{ |x, y| puts "bye, bye"})
-    connect_v2(@editor_map.sig_on_key("esc"),  proc{ |x, y| puts "bye, bye2"})
-    connect_v2(@editor_map.sig_on_key("q"),  proc{ |x, y| $gui.quit()})
-    connect_v2(@editor_map.sig_on_key("s"),  proc{ |x, y| $image.save("/tmp/test.scm")})
-    connect_v2(@editor_map.sig_on_key("l"),  proc{ |x, y| 
-                 $image = Image.new("/tmp/test.scm")
-                 $image.activate($gui.workspace())
-               })
-
-    connect_v2(@editor_map.sig_on_key("g"),  proc{ |x, y|
-                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() - 10)
-               })
-    connect_v2(@editor_map.sig_on_key("c"),  proc{ |x, y| 
-                 $gui.workspace.get_gc_state.set_rotation($gui.workspace.get_gc_state.get_rotation() + 10)
-               })
-
-    @normal_mode = CL_Button.new(CL_Rect.new(CL_Point.new(5, 500), CL_Size.new(40, 25)), "Norm", @selector_window)
-    @erase_mode  = CL_Button.new(CL_Rect.new(CL_Point.new(45, 500), CL_Size.new(40, 25)), "Erase", @selector_window)
-    @add_mode    = CL_Button.new(CL_Rect.new(CL_Point.new(85, 500), CL_Size.new(40, 25)), "Add", @selector_window)
-    @shader_mode = CL_Button.new(CL_Rect.new(CL_Point.new(125, 500), CL_Size.new(40, 25)), "Shad", @selector_window)
-
-    connect(@normal_mode.sig_clicked(), proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              drawer.set_mode(SpriteStrokeDrawer::DM_NORMAL)
-            })
-    connect(@erase_mode.sig_clicked(),  proc{ 
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              drawer.set_mode(SpriteStrokeDrawer::DM_ERASE)
-            })
-    connect(@add_mode.sig_clicked(),    proc{
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              drawer.set_mode(SpriteStrokeDrawer::DM_ADDITION)
-            })
-    connect(@shader_mode.sig_clicked(),    proc{
-              drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-              drawer.set_mode(SpriteStrokeDrawer::DM_SHADER)
-            })
-
-    button_panel = ButtonPanel.new(0, 0, 33, 33*3, false, @gui.get_component)
-    button_panel.add_icon("../data/images/tools/stock-tool-pencil-22.png", proc{ 
-                            @workspace.set_tool($sketch_stroke_tool.to_tool())
-                          })
-    button_panel.add_icon("../data/images/tools/stock-tool-move-22.png", proc{ 
-                            @workspace.set_tool($layer_move_tool.to_tool())
-                          })
-    button_panel.add_icon("../data/images/tools/stock-tool-zoom-22.png", proc{ 
-                            @workspace.set_tool($zoom_tool.to_tool())
-                          })
-  end
-
-  def quit()
-    @gui.quit()
-  end
-
-  def run()
-    @gui.run()
-  end
-end
-
-class Image
-  attr_reader :layers
-  
-  def initialize(filename = nil)
-    @editormap = EditorMap.new()
-    @editormap.set_background_color(CL_Color.new(255, 255, 255))
-    @layers  = []
-    
-    if filename then
-      load(filename)
-      set_active_layer(0)
-    else
-      add_layer()
-      add_layer()
-      add_layer()
-      set_active_layer(0)
-    end
-  end
-  
-  def set_active_layer(i)
-    if (i >= 0 && i < layers.size) then
-      BitmapLayer.set_current(layers[i])
-    end
-  end
-
-  def add_layer()
-    layer = BitmapLayer.new(640, 480)
-    layer.to_layer().set_pos(CL_Pointf.new(rand(100)-50, rand(100)-50))
-    @layers.push(layer)
-    @editormap.add_layer(layer.to_layer()) 
-    puts "Add layer: #{layer}" 
-    return layer
-  end
-
-  def layers_count()
-    return layers.size
-  end
-
-  def activate(workspace)
-    workspace.set_map(@editormap)
-    connect(@editormap.sig_change(), proc{$gui.on_map_change()})
-  end
-
-  def load(filename)
-    tree = sexpr_read_from_file(filename)
-    if tree == nil
-        raise("Couldn't load level: %s" % filename)
-    end
-    
-    # Skip flexlay-paint tag
-    tree = tree[1..-1]
-    puts "REst: #{tree.length}"
-    while not tree.empty? do
-      (tag, *data) = tree[0]
-
-      puts "Tag: #{tag}"
-
-      if tag == "layer" then
-        puts "MUMU LAYER" 
-        parse_layer(data)
-      end
-
-      tree = tree[1..-1]
-      puts "REst2: #{tree.length}"
-    end
-
-    set_active_layer(0)
-  end
-
-  def parse_layer(tree)
-    layer = add_layer()
-
-    while not tree.empty? do
-      (tag, *data) = tree[0]
-      
-      if tag == "stroke" then
-        parse_stroke(layer, data)
-      end
-
-      tree = tree[1..-1]
-    end
-    puts ""
-  end
-
-  def parse_stroke(layer, tree)
-    stroke = Stroke.new()
-
-    sprite_drawer = SpriteStrokeDrawer.new()
-    # FIXME: insert loader for brush here
-    sprite_drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
-                                               32,  # radius
-                                               2,   # spikes
-                                               0.75, # hardness
-                                               1.0, # aspect
-                                               0).to_brush()) # angle
-    
-    sprite_drawer.set_color(CL_Color.new(0, 0, 0, 155))
-    sprite_drawer.set_size(1.0)
-    stroke.set_drawer(sprite_drawer.to_drawer())
-
-    while not tree.empty? do
-      (tag, *data) = tree[0]     
-
-      if tag == "dab" then
-        time     = get_value_from_tree(["time", "_"], data, 0)
-        position = get_value_from_tree(["position"],  data, [0, 0])
-        pressure = get_value_from_tree(["pressure", "_"],  data, 1.0)
-        tilt     = get_value_from_tree(["tilt", "_"],  data, [0, 0])
-
-        # FIXME: No tilt support
-        stroke.add_dab(Dab.new(position[0].to_f, position[1].to_f, pressure.to_f))
-      elsif tag == "drawer" then
-        if data[0][0] == "sprite-stroke-drawer" then
-          data = data[0][1..-1]
-          mode    = get_value_from_tree(["mode", "_"], data, SpriteStrokeDrawer::DM_NORMAL)
-          spacing = get_value_from_tree(["spacing", "_"], data, 15.0)
-          size    = get_value_from_tree(["size", "_"],    data,  1.0)
-          color   = get_value_from_tree(["color"],    data, [0, 255, 0, 255])
-          brush   = get_value_from_tree(["brush", "generated-brush"],    data, [])
-
-          drawer = SpriteStrokeDrawer.new()
-          drawer.set_spacing(spacing)
-          drawer.set_mode(mode)
-          drawer.set_size(size)
-          drawer.set_color(CL_Color.new(color[0], color[1], color[2], color[3]))
-          drawer.set_brush(GeneratedBrush.new(get_value_from_tree(["shape", "_"], brush, 0),
-                                              get_value_from_tree(["radius", "_"], brush, 32),
-                                              get_value_from_tree(["spikes", "_"], brush, 2),
-                                              get_value_from_tree(["hardness", "_"], brush, 0.75),
-                                              get_value_from_tree(["aspect-ratio", "_"], brush, 1.0),
-                                              get_value_from_tree(["angle", "_"], brush, 0)).to_brush)
-          stroke.set_drawer(drawer.to_drawer)
-        else
-          puts "Error: Unknown drawer: #{data[0][0]}" 
-        end
-      end
-
-      tree = tree[1..-1]
-    end
-    
-    print "."
-    $stdout.flush
-    layer.add_stroke(stroke)
-  end
-
-  def save(filename)
-    f = File.new(filename, "w")
-    f.puts "(flexlay-paint"
-    @layers.each { |layer|
-      f.puts "(layer"
-      layer.get_strokes().each{|stroke|
-        f.puts "  (stroke"
-        
-        # FIXME: This won't work with a real smartptr!
-        sprite_stroke_drawer = SpriteStrokeDrawer.new(stroke.get_drawer())
-
-        f.puts "      (drawer (sprite-stroke-drawer"
-        f.puts "                 (mode    #{sprite_stroke_drawer.get_mode})"
-        f.puts "                 (spacing #{sprite_stroke_drawer.get_spacing})"
-        f.puts "                 (size    #{sprite_stroke_drawer.get_size})"
-        f.puts "                 (color   "\
-        "#{sprite_stroke_drawer.get_color.get_red} " \
-        "#{sprite_stroke_drawer.get_color.get_green} " \
-        "#{sprite_stroke_drawer.get_color.get_blue} " \
-        "#{sprite_stroke_drawer.get_color.get_alpha})"
-        # FIXME: This won't work with multilpe brush types
-        brush = GeneratedBrush.new(sprite_stroke_drawer.get_brush())
-        f.puts "                 (brush   (generated-brush"
-        f.puts "                            (shape  #{brush.get_shape})"
-        f.puts "                            (radius #{brush.get_radius})"
-        f.puts "                            (spikes #{brush.get_spikes})"
-        f.puts "                            (hardness #{brush.get_hardness})"
-        f.puts "                            (aspect-ratio #{brush.get_aspect_ratio})"
-        f.puts "                            (angle #{brush.get_angle})"
-        f.puts "                  ))"
-        f.puts "       ))"
-
-        stroke.get_dabs().each{|dab|
-          f.puts "    (dab"
-          f.puts "      (time     #{dab.time})"
-          f.puts "      (position #{dab.pos.x} #{dab.pos.y})"
-          f.puts "      (pressure #{dab.pressure})"
-          f.puts "      (tilt     #{dab.tilt.x} #{dab.tilt.y})"
-          f.puts ")"
-        }
-        f.puts ")"
-      }
-      f.puts ")"
-    }
-    f.puts ")"
-    f.close()
-  end
-end
-
 $gui   = PaintGUI.new()
 
-$image = Image.new()
-# $image = Image.new("example2.scm")
-# $image = Image.new()
-# $image.add_layer()
-# $image.add_layer()
+$animation = Animation.new()
+$image = $animation.get_current_image()
 
 $image.activate($gui.workspace)
 
 drawer = SpriteStrokeDrawer.new($sketch_stroke_tool.get_drawer())
-drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
-                                    32,  # radius
-                                    2,   # spikes
-                                    0.75, # hardness
-                                    1.0, # aspect
-                                    0).to_brush()) # angle
+if true then
+  drawer.set_brush(GeneratedBrush.new(BRUSH_SHAPE_CIRCLE, 
+                                      32,  # radius
+                                      2,   # spikes
+                                      0.75, # hardness
+                                      1.0, # aspect
+                                      0).to_brush()) # angle
+else
+  drawer.set_brush(SpriteBrush.new(make_sprite("../data/images/brush/brush8.png")).to_brush)
+end
 
 $image.layers_count.times {|i|
   button = CL_Button.new(CL_Rect.new(CL_Point.new(25*i+6, 450), CL_Size.new(25, 25)), "#{i}",



From grumbel at sheep.berlios.de  Wed Mar 30 02:01:48 2005
From: grumbel at sheep.berlios.de (Ingo Ruhnke at BerliOS)
Date: Wed, 30 Mar 2005 02:01:48 +0200
Subject: [Flexlay-commit] r514 - in trunk: lib netpanzer netpanzer/sprites
Message-ID: <200503300001.j2U01mJF028966@sheep.berlios.de>

Author: grumbel
Date: 2005-03-30 02:01:21 +0200 (Wed, 30 Mar 2005)
New Revision: 514

Added:
   trunk/netpanzer/sprites/
   trunk/netpanzer/sprites/0.png
   trunk/netpanzer/sprites/1.png
   trunk/netpanzer/sprites/10.png
   trunk/netpanzer/sprites/100.png
   trunk/netpanzer/sprites/101.png
   trunk/netpanzer/sprites/102.png
   trunk/netpanzer/sprites/103.png
   trunk/netpanzer/sprites/104.png
   trunk/netpanzer/sprites/105.png
   trunk/netpanzer/sprites/106.png
   trunk/netpanzer/sprites/107.png
   trunk/netpanzer/sprites/108.png
   trunk/netpanzer/sprites/109.png
   trunk/netpanzer/sprites/11.png
   trunk/netpanzer/sprites/110.png
   trunk/netpanzer/sprites/111.png
   trunk/netpanzer/sprites/112.png
   trunk/netpanzer/sprites/113.png
   trunk/netpanzer/sprites/114.png
   trunk/netpanzer/sprites/115.png
   trunk/netpanzer/sprites/12.png
   trunk/netpanzer/sprites/13.png
   trunk/netpanzer/sprites/14.png
   trunk/netpanzer/sprites/15.png
   trunk/netpanzer/sprites/16.png
   trunk/netpanzer/sprites/17.png
   trunk/netpanzer/sprites/18.png
   trunk/netpanzer/sprites/19.png
   trunk/netpanzer/sprites/2.png
   trunk/netpanzer/sprites/20.png
   trunk/netpanzer/sprites/21.png
   trunk/netpanzer/sprites/22.png
   trunk/netpanzer/sprites/23.png
   trunk/netpanzer/sprites/24.png
   trunk/netpanzer/sprites/25.png
   trunk/netpanzer/sprites/26.png
   trunk/netpanzer/sprites/27.png
   trunk/netpanzer/sprites/28.png
   trunk/netpanzer/sprites/29.png
   trunk/netpanzer/sprites/3.png
   trunk/netpanzer/sprites/30.png
   trunk/netpanzer/sprites/31.png
   trunk/netpanzer/sprites/32.png
   trunk/netpanzer/sprites/33.png
   trunk/netpanzer/sprites/34.png
   trunk/netpanzer/sprites/35.png
   trunk/netpanzer/sprites/36.png
   trunk/netpanzer/sprites/37.png
   trunk/netpanzer/sprites/38.png
   trunk/netpanzer/sprites/39.png
   trunk/netpanzer/sprites/4.png
   trunk/netpanzer/sprites/40.png
   trunk/netpanzer/sprites/41.png
   trunk/netpanzer/sprites/42.png
   trunk/netpanzer/sprites/43.png
   trunk/netpanzer/sprites/44.png
   trunk/netpanzer/sprites/45.png
   trunk/netpanzer/sprites/46.png
   trunk/netpanzer/sprites/47.png
   trunk/netpanzer/sprites/48.png
   trunk/netpanzer/sprites/49.png
   trunk/netpanzer/sprites/5.png
   trunk/netpanzer/sprites/50.png
   trunk/netpanzer/sprites/51.png
   trunk/netpanzer/sprites/52.png
   trunk/netpanzer/sprites/53.png
   trunk/netpanzer/sprites/54.png
   trunk/netpanzer/sprites/55.png
   trunk/netpanzer/sprites/56.png
   trunk/netpanzer/sprites/57.png
   trunk/netpanzer/sprites/58.png
   trunk/netpanzer/sprites/59.png
   trunk/netpanzer/sprites/6.png
   trunk/netpanzer/sprites/60.png
   trunk/netpanzer/sprites/61.png
   trunk/netpanzer/sprites/62.png
   trunk/netpanzer/sprites/63.png
   trunk/netpanzer/sprites/64.png
   trunk/netpanzer/sprites/65.png
   trunk/netpanzer/sprites/66.png
   trunk/netpanzer/sprites/67.png
   trunk/netpanzer/sprites/68.png
   trunk/netpanzer/sprites/69.png
   trunk/netpanzer/sprites/7.png
   trunk/netpanzer/sprites/70.png
   trunk/netpanzer/sprites/71.png
   trunk/netpanzer/sprites/72.png
   trunk/netpanzer/sprites/73.png
   trunk/netpanzer/sprites/74.png
   trunk/netpanzer/sprites/75.png
   trunk/netpanzer/sprites/76.png
   trunk/netpanzer/sprites/77.png
   trunk/netpanzer/sprites/78.png
   trunk/netpanzer/sprites/79.png
   trunk/netpanzer/sprites/8.png
   trunk/netpanzer/sprites/80.png
   trunk/netpanzer/sprites/81.png
   trunk/netpanzer/sprites/82.png
   trunk/netpanzer/sprites/83.png
   trunk/netpanzer/sprites/84.png
   trunk/netpanzer/sprites/85.png
   trunk/netpanzer/sprites/86.png
   trunk/netpanzer/sprites/87.png
   trunk/netpanzer/sprites/88.png
   trunk/netpanzer/sprites/89.png
   trunk/netpanzer/sprites/9.png
   trunk/netpanzer/sprites/90.png
   trunk/netpanzer/sprites/91.png
   trunk/netpanzer/sprites/92.png
   trunk/netpanzer/sprites/93.png
   trunk/netpanzer/sprites/94.png
   trunk/netpanzer/sprites/95.png
   trunk/netpanzer/sprites/96.png
   trunk/netpanzer/sprites/97.png
   trunk/netpanzer/sprites/98.png
   trunk/netpanzer/sprites/99.png
Modified:
   trunk/lib/clanlib.i
   trunk/lib/flexlay_wrap.i
   trunk/lib/helper.cxx
   trunk/lib/helper.hxx
   trunk/lib/objmap_sprite_object.cxx
   trunk/netpanzer/gameobjects.rb
   trunk/netpanzer/netpanzer.rb
Log:
- added support for 'object oriented' editing to netpanzer

Modified: trunk/lib/clanlib.i
===================================================================
--- trunk/lib/clanlib.i	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/lib/clanlib.i	2005-03-30 00:01:21 UTC (rev 514)
@@ -36,6 +36,8 @@
 CL_Sprite(      
 	        	const std::string &resource_id,
 		        CL_ResourceManager *manager);
+	void set_scale(float x, float y);
+
 };
 
 

Modified: trunk/lib/flexlay_wrap.i
===================================================================
--- trunk/lib/flexlay_wrap.i	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/lib/flexlay_wrap.i	2005-03-30 00:01:21 UTC (rev 514)
@@ -32,6 +32,7 @@
 #include "editor.hxx"
 #include "meta_data.hxx"
 #include "console.hxx"
+#include "blitter.hxx"
 
 #include "layer.hxx"
 #include "tilemap_layer.hxx"
@@ -145,6 +146,7 @@
 %include "editor.hxx"
 %include "meta_data.hxx"
 %include "console.hxx"
+%include "blitter.hxx"
  
 %include "layer.hxx"
 %include "tilemap_layer.hxx"

Modified: trunk/lib/helper.cxx
===================================================================
--- trunk/lib/helper.cxx	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/lib/helper.cxx	2005-03-30 00:01:21 UTC (rev 514)
@@ -98,4 +98,10 @@
   }
 }
 
+CL_PixelBuffer
+make_pixelbuffer(int width, int height)
+{
+  return CL_PixelBuffer(width, height, width*4, CL_PixelFormat::rgba8888);
+}
+
 /* EOF */

Modified: trunk/lib/helper.hxx
===================================================================
--- trunk/lib/helper.hxx	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/lib/helper.hxx	2005-03-30 00:01:21 UTC (rev 514)
@@ -27,6 +27,7 @@
 CL_Sprite      make_sprite(const std::string& filename);
 CL_PixelBuffer make_pixelbuffer(const std::string& filename);
 CL_PixelBuffer make_region_pixelbuffer(const std::string& filename, int x, int y, int w, int h);
+CL_PixelBuffer make_pixelbuffer(int width, int height);
 
 CL_Sprite      make_sprite_from_resource(const std::string& filename, CL_ResourceManager& resources);
 CL_PixelBuffer make_pixelbuffer_from_resource(const std::string& filename, CL_ResourceManager& resources);

Modified: trunk/lib/objmap_sprite_object.cxx
===================================================================
--- trunk/lib/objmap_sprite_object.cxx	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/lib/objmap_sprite_object.cxx	2005-03-30 00:01:21 UTC (rev 514)
@@ -74,8 +74,12 @@
   if (scale_y < 0)
     align.y += sprite.get_height();
       
-  return CL_Rectf(pos - origin - align,
-                  CL_Sizef(sprite.get_width(), sprite.get_height()));
+  if (scale_x > 1.0f && scale_y > 1.0f)
+    return CL_Rectf(pos - origin - align,
+                    CL_Sizef(sprite.get_width() * scale_x, sprite.get_height() * scale_y));
+  else
+    return CL_Rectf(pos - origin - align,
+                    CL_Sizef(sprite.get_width(), sprite.get_height()));  
 }
 
 void

Modified: trunk/netpanzer/gameobjects.rb
===================================================================
--- trunk/netpanzer/gameobjects.rb	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/netpanzer/gameobjects.rb	2005-03-30 00:01:21 UTC (rev 514)
@@ -27,8 +27,13 @@
     def data=(data)
       @data = data
       connect_v1_ObjMapObject(@data.to_object.sig_move(), method(:on_move))
+      on_move(@data)
     end
 
+    def get_sprite()
+      self.class.get_sprite()
+    end
+
     def on_move(data)
       pos = @data.to_object.get_pos()
       pos.x = (((pos.x+16)/32).to_i)*32
@@ -109,6 +114,7 @@
   # TileObject is used to hold tilebrushes
   class TileObject < GameObject
     def initialize(brushindex)
+      @brushindex = brushindex
       (start, width, height, @name) = $brushes[brushindex]
       
       # FIXME: Could be shared among all TileObjects
@@ -128,6 +134,12 @@
       tilemap.draw_tile(@brush, CL_Point.new(x(), y()))
     end
 
+    def get_sprite()
+      sprite = make_sprite("sprites/#{@brushindex}.png")
+      sprite.set_scale(4.0, 4.0)
+      return sprite
+    end
+
     def TileObject.create(objmap, brushindex, x, y)
       obj = TileObject.new(brushindex)
       sprite_obj = ObjMapSpriteObject.new(get_sprite(), CL_Pointf.new(x*32, y*32),
@@ -137,10 +149,6 @@
       
       return obj
     end
-    
-    def TileObject.get_sprite()
-      return make_sprite_from_resource("sprites/spawnpoint", $resources)
-    end
   end
 end
 

Modified: trunk/netpanzer/netpanzer.rb
===================================================================
--- trunk/netpanzer/netpanzer.rb	2005-03-29 23:26:08 UTC (rev 513)
+++ trunk/netpanzer/netpanzer.rb	2005-03-30 00:01:21 UTC (rev 514)
@@ -60,7 +60,7 @@
                                           make_metadata(proc{GameObjects::SpawnPoint.new()})))
 
 $brushes.size.times {|i|
-  $objectselector.add_brush(ObjectBrush.new(GameObjects::TileObject.get_sprite(),
+  $objectselector.add_brush(ObjectBrush.new(make_sprite("sprites/#{i}.png"),
                                             make_metadata(proc{GameObjects::TileObject.new(i)})))
 }
 
@@ -69,7 +69,7 @@
 def on_object_drop(brush, pos)
   obj = get_ruby_object(brush.get_data()).call()
   pos = $editor_map.screen2world(pos)
-  sprite_obj = ObjMapSpriteObject.new(obj.class.get_sprite(), pos, make_metadata(obj))
+  sprite_obj = ObjMapSpriteObject.new(obj.get_sprite(), pos, make_metadata(obj))
   obj.data = sprite_obj
   
   cmd = ObjectAddCommand.new($workspace.get_map().get_data().objects)
@@ -282,6 +282,22 @@
   gc.set_pos(pos)
 end
 
+def generate_sprites()
+  $brushes.each_with_index{|(start, width, height, name), index|
+    puts "#{index}"
+    buffer = make_pixelbuffer(width * 32, height * 32)
+
+    (0..(height-1)).each {|y|
+      (0..(width-1)).each {|x|
+        tile = $tileset.create(start + width * y + x)
+        blit(buffer, tile.get_pixelbuffer(), x * 32, y * 32)
+      }
+    }
+    
+    CL_ProviderFactory.save(buffer, "sprites/#{index}.png")
+  }
+end
+
 menu.add_item("Zoom/1:4 (25%) ",  proc{ gui_set_zoom(0.25) })
 menu.add_item("Zoom/1:2 (50%) ",  proc{ gui_set_zoom(0.5) })
 menu.add_item("Zoom/1:1 (100%) ", proc{ gui_set_zoom(1.0) }) 
@@ -298,6 +314,7 @@
 
 set_tilemap_paint_tool()
 
+# generate_sprites()
 $gui.run()
 
 # flexlay.deinit()

Added: trunk/netpanzer/sprites/0.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/0.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/1.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/1.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/10.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/10.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/100.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/100.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/101.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/101.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/102.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/102.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/103.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/103.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/104.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/104.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/105.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/105.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/106.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/106.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/107.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/107.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/108.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/108.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/109.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/109.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/11.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/11.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/110.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/110.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/111.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/111.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/112.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/112.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/113.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/113.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/114.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/114.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/115.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/115.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/12.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/12.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/13.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/13.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/14.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/14.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/15.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/15.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/16.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/16.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/17.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/17.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/18.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/18.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/19.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/19.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/2.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/2.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/20.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/20.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/21.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/21.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/22.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/22.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/23.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/23.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/24.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/24.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/25.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/25.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/26.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/26.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/27.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/27.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/28.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/28.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/29.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/29.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/3.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/3.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/30.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/30.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/31.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/31.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/32.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/32.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/33.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/33.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/34.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/34.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/35.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/35.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/36.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/36.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/37.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/37.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/38.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/38.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/39.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/39.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/4.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/4.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/40.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/40.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/41.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/41.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/42.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/42.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/43.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/43.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/44.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/44.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/45.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/45.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/46.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/46.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/47.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/47.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/48.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/48.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/49.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/49.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/5.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/5.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/50.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/50.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/51.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/51.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/52.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/52.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/53.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/53.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/54.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/54.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/55.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/55.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/56.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/56.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/57.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/57.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/58.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/58.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/59.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/59.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/6.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/6.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/60.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/60.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/61.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/61.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/62.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/62.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/63.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/63.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/64.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/64.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/65.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/65.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/66.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/66.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/67.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/67.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/68.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/68.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/69.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/69.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/7.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/7.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/70.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/70.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/71.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/71.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/72.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/72.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/73.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/73.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/74.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/74.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/75.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/75.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/76.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/76.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/77.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/77.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/78.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/78.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/79.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/79.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/8.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/8.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/80.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/80.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/81.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/81.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/82.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/82.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/83.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/83.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/84.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/84.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/85.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/85.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/86.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/86.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/87.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/87.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/88.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/88.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/89.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/89.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/9.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/9.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/90.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/90.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/91.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/91.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/92.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/92.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/93.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/93.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/94.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/94.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/95.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/95.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/96.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/96.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/97.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/97.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/98.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/98.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/netpanzer/sprites/99.png
===================================================================
(Binary files differ)


Property changes on: trunk/netpanzer/sprites/99.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



