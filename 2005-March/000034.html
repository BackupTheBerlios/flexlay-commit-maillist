<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Flexlay-commit] r525 - in trunk: ruby supertux
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/flexlay-commit/2005-March/index.html" >
   <LINK REL="made" HREF="mailto:flexlay-commit%40lists.berlios.de?Subject=Re%3A%20%5BFlexlay-commit%5D%20r525%20-%20in%20trunk%3A%20ruby%20supertux&In-Reply-To=%3C200503301920.j2UJK905020535%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000033.html">
   <LINK REL="Next"  HREF="000035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Flexlay-commit] r525 - in trunk: ruby supertux</H1>
    <B>Matthias Braun at BerliOS</B> 
    <A HREF="mailto:flexlay-commit%40lists.berlios.de?Subject=Re%3A%20%5BFlexlay-commit%5D%20r525%20-%20in%20trunk%3A%20ruby%20supertux&In-Reply-To=%3C200503301920.j2UJK905020535%40sheep.berlios.de%3E"
       TITLE="[Flexlay-commit] r525 - in trunk: ruby supertux">matzebraun at sheep.berlios.de
       </A><BR>
    <I>Wed Mar 30 21:20:09 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000033.html">[Flexlay-commit] r524 - trunk/supertux
</A></li>
        <LI>Next message: <A HREF="000035.html">[Flexlay-commit] r526 - trunk/supertux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34">[ date ]</a>
              <a href="thread.html#34">[ thread ]</a>
              <a href="subject.html#34">[ subject ]</a>
              <a href="author.html#34">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: matzebraun
Date: 2005-03-30 21:20:02 +0200 (Wed, 30 Mar 2005)
New Revision: 525

Modified:
   trunk/ruby/sexpr.rb
   trunk/supertux/gameobj.rb
   trunk/supertux/gui.rb
   trunk/supertux/level.rb
   trunk/supertux/sector.rb
Log:
- Improved parsing of version 1 supertux maps
- Changed sexpr to return translatable strings as normal strings
- Fixed Spawnpoint not parsing name parameter



Modified: trunk/ruby/sexpr.rb
===================================================================
--- trunk/ruby/sexpr.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/ruby/sexpr.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -42,7 +42,12 @@
     if spec == []
       return tree
     elsif spec == ['_']
-      return tree[0]
+	  # is it a translatable string?
+	  if(tree[0].instance_of?(Array) and tree[0][0] == &quot;_&quot;)
+		return tree[0][1]
+	  else
+        return tree[0]
+	  end
     elsif tree == []
       return default
     else

Modified: trunk/supertux/gameobj.rb
===================================================================
--- trunk/supertux/gameobj.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/gameobj.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -89,7 +89,7 @@
 
   def initialize(data, sexpr = [])
     @data = data
-    @name = &quot;start&quot;
+    @name = get_value_from_tree([&quot;name&quot;, &quot;_&quot;],  sexpr, &quot;main&quot;)
     connect_v1_ObjMapObject(data.to_object.sig_move(), method(:on_move))
     on_move(data)
   end
@@ -157,8 +157,8 @@
 	f.write(&quot;       (particles-%s\n&quot; % [@type])
 	if(@layer != -1)
       f.write(&quot;         (layer %d)\n&quot; % [@layer])
+	end
 	f.write(&quot;       )\n&quot;)
-	end
   end
 
   def property_dialog()

Modified: trunk/supertux/gui.rb
===================================================================
--- trunk/supertux/gui.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/gui.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -487,12 +487,12 @@
     dialog = GenericDialog.new(&quot;Edit Sector&quot;, @gui.get_component())
     
     dialog.add_string(&quot;Name: &quot;,   level.current_sector.name)
-    dialog.add_string(&quot;Music: &quot;,   level.current_sector.song)
+    dialog.add_string(&quot;Music: &quot;,   level.current_sector.music)
     dialog.add_float(&quot;Gravity: &quot;, level.current_sector.gravity)
     
-    dialog.set_block() { |name, song, gravity|
+    dialog.set_block() { |name, music, gravity|
       level.current_sector.name = name
-      level.current_sector.song = song
+      level.current_sector.music = music
       level.current_sector.gravity = gravity
     }
   end

Modified: trunk/supertux/level.rb
===================================================================
--- trunk/supertux/level.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/level.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -92,9 +92,11 @@
     f.write(&quot;;; Generated by Flexlay Editor\n&quot; +
                                                 &quot;(supertux-level\n&quot;)
     f.write(&quot;  (version 2)\n&quot;)
-    f.write(&quot;  (name   \&quot;%s\&quot;)\n&quot; % @name)
+    f.write(&quot;  (name   (_ \&quot;%s\&quot;))\n&quot; % @name)
     f.write(&quot;  (author \&quot;%s\&quot;)\n&quot; % @author)
-    f.write(&quot;  (time   %d)\n&quot; % @time)   
+	if(@time != 999)
+      f.write(&quot;  (time   %d)\n&quot; % @time)
+	end
     
     for sector in @sectors
       f.write(&quot;  (sector\n&quot;)

Modified: trunk/supertux/sector.rb
===================================================================
--- trunk/supertux/sector.rb	2005-03-30 18:40:36 UTC (rev 524)
+++ trunk/supertux/sector.rb	2005-03-30 19:20:02 UTC (rev 525)
@@ -64,8 +64,8 @@
 
   def load_v1(data)
     @name = &quot;main&quot;
-    @music = &quot;&quot;
-    @gravity = 10.0
+    @music = get_value_from_tree([&quot;music&quot;, &quot;_&quot;], data, &quot;&quot;)
+    @gravity = get_value_from_tree([&quot;gravity&quot;, &quot;_&quot;], data, 10.0)
     
     @width  = get_value_from_tree([&quot;width&quot;, &quot;_&quot;], data, 20)
     @height = get_value_from_tree([&quot;height&quot;, &quot;_&quot;], data, 15)
@@ -78,36 +78,42 @@
     
     @background  = TilemapLayer.new($tileset, @width, @height)
     @background.set_data(get_value_from_tree([&quot;background-tm&quot;], data, []))
-    
+
+	@cameramode = &quot;normal&quot;
+
     @objects = ObjectLayer.new()
     for i in get_value_from_tree([&quot;objects&quot;], data, [])
-      type = i[0]
-      x = get_value_from_tree([&quot;x&quot;, &quot;_&quot;], i[1..-1], 0)
-      y = get_value_from_tree([&quot;y&quot;, &quot;_&quot;], i[1..-1], 0)
-      print(&quot;Object position: &quot;, type, &quot; &quot;, x, &quot; &quot;, y, &quot;\n&quot;)
-      object = $game_objects.find{|x| x[0] == type}
-      print &quot;Resolved object: &quot;, object, &quot;\n&quot;
-      if object
-        # fixme
-        #        @objects.add_object(ObjMapSpriteObject.new(make_sprite($datadir + object[1]),
-        #                                                   CL_Point.new(x, y),
-        #                                                   make_metadata(BadGuy.new(object[0]))).to_object())
-      else
-        print &quot;Error: Couldn't resolve object type: &quot;, type, &quot;\n&quot;
-      end
+      (name, odata) = i[0], i[1..-1]
+	  print &quot;Create object: &quot;, name, &quot;\n&quot;
+      create_gameobject_from_data(@objects, name, odata)
     end
-    
-# FIXME: doesn't work
-#     for i in get_value_from_tree([&quot;reset-points&quot;], data, [])
-#       type = i[0]
-#       x = get_value_from_tree([&quot;x&quot;, &quot;_&quot;], i[1..-1], [])
-#       y = get_value_from_tree([&quot;y&quot;, &quot;_&quot;], i[1..-1], [])
-#       object = $game_objects.find(&quot;resetpoint&quot;)
-#       @objects.add_object(ObjMapSpriteObject.new(make_sprite($datadir + object[1]),
-#                                                  CL_Point.new(x, y),
-#                                                  make_metadata(BadGuy.new(object[0]))).to_object())
-#     end
 
+	start_pos_x = get_value_from_tree([&quot;start_pos_x&quot;, &quot;_&quot;], data, 0)
+	start_pos_y = get_value_from_tree([&quot;start_pos_y&quot;, &quot;_&quot;], data, 0)
+	sexpr = [[&quot;name&quot;, &quot;main&quot;], [&quot;x&quot;, start_pos_x], [&quot;y&quot;, start_pos_y]]
+	create_gameobject_from_data(@objects, &quot;spawnpoint&quot;, sexpr)
+
+	background = get_value_from_tree([&quot;background&quot;, &quot;_&quot;], data, &quot;&quot;)
+	if(background != &quot;&quot;)
+	  sexpr = [[&quot;image&quot;, background], [&quot;speed&quot;, 0.5]]
+	  create_gameobject_from_data(@objects, &quot;background&quot;, sexpr)
+	end
+
+	partsys = get_value_from_tree([&quot;particle_system&quot;, &quot;_&quot;], data, &quot;&quot;)
+	if(partsys == &quot;snow&quot;)
+	  sexpr = []
+	  create_gameobject_from_data(@objects, &quot;particles-snow&quot;, sexpr)
+	elsif(partsys == &quot;rain&quot;)
+	  sexpr = []
+	  create_gameobject_from_data(@objects, &quot;particles-rain&quot;, sexpr)
+	elsif(partsys == &quot;clouds&quot;)
+	  sexpr = []
+	  create_gameobject_from_data(@objects, &quot;particles-clouds&quot;, sexpr)
+	elsif(partsys == &quot;&quot;)
+	elsif
+	  print &quot;Unknown particle system type '&quot;, partsys, &quot;'\n&quot;
+	end
+	    
     @editormap = EditorMap.new()
     @editormap.add_layer(@background.to_layer())
     @editormap.add_layer(@interactive.to_layer())


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000033.html">[Flexlay-commit] r524 - trunk/supertux
</A></li>
	<LI>Next message: <A HREF="000035.html">[Flexlay-commit] r526 - trunk/supertux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34">[ date ]</a>
              <a href="thread.html#34">[ thread ]</a>
              <a href="subject.html#34">[ subject ]</a>
              <a href="author.html#34">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/flexlay-commit">More information about the Flexlay-commit
mailing list</a><br>
</body></html>
